define(["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/event","core/flex_icon"],function(a,b,c,d,e,f,g,h,i,j){String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return b=b||0,this.substr(b,a.length)===a});var k={},l=function(c,f,h){var i=b.Deferred(),j=[],k=[],l=[],n="",o=[],q=!0,r=!0,s=function(a){var b="",c=m(a);return c.done(function(a){b=a}).fail(e.exception),""===b&&(l.push(c),q=!1),b},t=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim()),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim()),""!==f&&(f=b(f,this)),0===f.indexOf("{")&&0!==f.indexOf("{{")&&(f=JSON.parse(f));var g=o.length;return o.push({key:d,component:e,param:f}),"{{_s"+g+"}}"},u=function(a,b){var c="",d="",e={},f=a.split(",").map(function(a){return a.trim()});f.length>0&&(c=f.shift().trim()),f.length>0&&(d=f.join(",").trim()),c.indexOf("{{")!==-1&&(c=b(c,this)),""!==d&&(d.indexOf("{{")!==-1&&(d=b(d,this)),e=JSON.parse(d));var g="",h="",i=k.length;return"undefined"!=typeof e.alt&&(g=e.alt),e.classes&&(h=e.classes),k.push(p(c,g,h)),"<_p"+i+">"},v=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim()),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim());var g=e+"|"+d+',{"alt":"'+f+'"}';return u.apply(this,[g,b])},w=function(a,b){return j.push(b(a,this)),""},x=function(a,b){var c=b(a.trim(),this);return c=c.replace('"','\\"').replace(/([\{\}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>"),'"'+c+'"'};f.str=function(){return t},f.pix=function(){return v},f.flex_icon=function(){return u},f.js=function(){return w},f.quote=function(){return x},f.globals={config:g};var y=b.Deferred(),z=function(){b.when.apply(b,l).done(function(){if(q&&!r)y.resolve();else{r=!1,j=[],k=[],l=[],n="",o=[],q=!0;try{n=a.render(c,f,s),z()}catch(b){i.reject(b)}}})};return z(),y.done(function(){for(var a=0;a<k.length;a++)k[a].done(function(a){return function(b,c){j.push(c),n=n.replace("<_p"+a+">",b)}}(a));b.when.apply(b,k).then(function(){var a=b.Deferred();return j=j.join(";\n"),o.length>0?d.get_strings(o).done(function(b){var c;for(c=0;c<b.length;c++){for(;n.indexOf("{{_s"+c+"}}")!==-1;)n=n.replace("{{_s"+c+"}}",b[c]);for(;j.indexOf("{{_s"+c+"}}")!==-1;)j=j.replace("{{_s"+c+"}}",b[c])}a.resolve()}):a.resolve(),a}).then(function(){i.resolve(n.trim(),j)},function(a){i.reject(a)})}),i.promise()},m=function(a,d){var e=b.Deferred(),f=a.split("/"),i=f.shift(),j=f.shift(),l=g.theme+"/"+a;if(l in k)return e.resolve(k[l]),e.promise();var m=h.get("core_template/"+l);if(m)return e.resolve(m),k[l]=m,e.promise();var n=c.call([{methodname:"core_output_load_template",args:{component:i,template:j,themename:g.theme}}],d,!1);return n[0].done(function(a){h.set("core_template/"+l,a),k[l]=a,e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},n=function(a){if(""!==a.trim()){var c=b("<script>").attr("type","text/javascript").html(a);b("head").append(c)}},o=function(a,c,d,e){var f=b(a);if(f.length){var g=b(c);e?(f.empty(),f.append(g)):f.replaceWith(g),n(d),i.notifyFilterContentUpdated(g)}},p=function(a,c,d){var e=b.Deferred();return j.getFlexTemplateData(a).done(function(a){void 0===a.data?a.data={}:a.data.customdata={alt:c},void 0!==d&&""!==d&&(a.data.customdata.classes=d),q.render(a.template,a.data).done(function(a){e.resolve(a)})}).fail(function(){var b=a.split("|");1===b.length&&b.unshift("core");var g=f.imageUrl(b[1],b[0]),h=[{name:"src",value:g},{name:"alt",value:c},{name:"title",value:c},{name:"class",value:"smallicon "+d}];q.render("core/pix_icon",{attributes:h}).done(e.resolve)}),e.promise()},q={render:function(a,c,d){var e=b.Deferred(),f=b.extend({},c),g=m(a,!0);return g.done(function(a){var b=l(a,f);b.done(function(a,b){e.resolve(a,b)}).fail(function(a){e.reject(a)})}).fail(function(a){e.reject(a)}),e},runTemplateJS:n,replaceNodeContents:function(a,b,c){return o(a,b,c,!0)},replaceNode:function(a,b,c){return o(a,b,c,!1)},renderIcon:p};return q});