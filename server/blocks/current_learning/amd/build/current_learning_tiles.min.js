define(["core/templates","core/str","core/yui"],function(templates,mdlstr,YUI){function init(a){0!==a.learningitems.length&&(reloadNodes(document.getElementById("inst"+a.instanceid)),pagination=a.pagination,pagination.pagination=!0,totalPages=Math.ceil(pagination.totalitems/pagination.itemsperpage),learningItems=a.learningitems,blockinstanceid=a.instanceid,addEvents(),checkResize())}function reloadNodes(a){blockNode=a,pagesNode=blockNode.querySelector(".panel-footer"),tilesNode=blockNode.querySelector(".block_current_learning-tiles ul")}function addEvents(){if(blockNode.addEventListener("click",changePage),window.addEventListener("resize",checkResize),addDockListeners(),document.body.classList.contains("editing")){var a=function(a){a.filter(function(a){return"childList"===a.type&&a.target.hasAttribute("data-blockregion")}).forEach(function(a){a.addedNodes.forEach(function(a){a.id=="inst"+blockinstanceid&&checkResize()})})},b=new MutationObserver(a);b.observe(document.body,{attributes:!1,childList:!0,subtree:!0})}}function addDockListeners(){YUI.use("moodle-core-dock",function(){var a=M.core.dock.get();a.on("dock:resizepanelcomplete",function(){var a=document.querySelector("#dock .block_current_learning");a&&(reloadNodes(a),checkResize(),blockNode.addEventListener("click",changePage))}),a.on("dock:itemremoved",function(){var a=document.getElementById("inst"+blockinstanceid);a&&(reloadNodes(a),checkResize())})})}function checkResize(){resizePending||(resizePending=!0,setTimeout(doResize,50))}function doResize(){resizePending=!1;var a,b=parseInt(getComputedStyle(tilesNode.parentElement).width,10),c=Math.floor(b/214)||1;return a=c<2?3:c<5?2:1,c==tilesNode.getAttribute("data-items-per-row")&&"false"==tilesNode.parentElement.getAttribute("data-loading")?void updateMargin():(tilesNode.parentElement.setAttribute("data-loading",!0),pagination.itemsperpage=c*a,void render(c).then(updateMargin))}function updateMargin(){if(1==tilesNode.getAttribute("data-items-per-row")){var a=tilesNode.querySelector(".block_current_learning-tile"),b=getComputedStyle(a);if(b.maxWidth===b.width){var c=getComputedStyle(tilesNode).width,d=(parseInt(c,10)-parseInt(b.width,10))/2;tilesNode.querySelectorAll(".block_current_learning-tile").forEach(function(a){a.style.marginLeft=d+"px",a.style.marginRight=d+"px"})}else tilesNode.querySelectorAll(".block_current_learning-tile").forEach(function(a){a.style.marginLeft="",a.style.marginRight=""})}}function changePage(a){var b=a.target.closest("a");if(b&&b.hasAttribute("data-page")&&(a.preventDefault(),!b.parentElement.classList.contains("disabled"))){var c=b.getAttribute("data-page");"next"===c?pagination.currentpage+=1:"prev"===c?pagination.currentpage-=1:pagination.currentpage=parseInt(c),render().then(updateMargin)}}function render(tilesPerRow){tilesPerRow||(tilesPerRow=tilesNode.getAttribute("data-items-per-row")),totalPages=Math.ceil(pagination.totalitems/pagination.itemsperpage),pagination.onepage=1==totalPages,pagination.currentpage>totalPages&&(pagination.currentpage=totalPages),pagination.previousclass=1===pagination.currentpage?"disabled":"",pagination.nextclass=pagination.currentpage===totalPages?"disabled":"";var start=(pagination.currentpage-1)*pagination.itemsperpage,end=Math.min(pagination.currentpage*pagination.itemsperpage,pagination.totalitems),tileData=learningItems.slice(start,end),strData={end:end,start:start+1,total:learningItems.length};pagination.pages=[];for(var page=0;page<totalPages;page++)pagination.pages.push({page:page+1,active:page+1==pagination.currentpage?"active":""});M.util.js_pending("block_current_learning-updated");var pagingComplete=mdlstr.get_string("displayingxofx","block_current_learning",strData).then(function(a){return pagination.text=a,templates.render("block_current_learning/paging",pagination)}).then(function(a,b){return{html:a,js:b}}),tiles=tileData.map(function(a){return templates.render("block_current_learning/tile",a).then(function(a,b){return Promise.resolve({html:a,js:b})})}),tilesUpdated=Promise.all(tiles).then(function(a){var b="",c="";return a.forEach(function(a){b+=a.html,c+=a.js+";"}),Promise.resolve({html:b,js:c})});return Promise.all([pagingComplete,tilesUpdated]).then(function(pagingHTML){return blockNode.querySelector(".panel-footer").outerHTML=pagingHTML[0].html,tilesNode.innerHTML=pagingHTML[1].html,tilesNode.querySelectorAll("script").forEach(function(script){eval(script.innerHTML)}),tilesPerRow=tilesNode.setAttribute("data-items-per-row",tilesPerRow),tilesNode.parentElement.setAttribute("data-loading",!1),templates.runTemplateJS(pagingHTML[0].js+";"+pagingHTML[1].js)}).then(function(){M.util.js_complete("block_current_learning-updated")})}var blockNode,tilesNode,pagesNode,pagination,learningItems,totalPages,resizePending=!1,blockinstanceid;return{init:init}});