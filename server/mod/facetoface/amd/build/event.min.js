define(["jquery","core/config","core/str","core/templates","core/notification"],function(a,b,c,d,e){function f(a){a||e.Exception("Config not supplied")}function g(a){this.manageCustom=a.manageadhocfacilitators,this.init()}function h(a){this.manageCustom=a.manageadhocassets,this.init()}function i(a){this.manageCustom=a.manageadhocrooms,this.init()}var j=10,k=b.wwwroot+"/mod/facetoface/",l=null;M.util.js_pending("mod_facetoface-events__dialogues_inited");var m=new Promise(function(a){window.dialogsInited?a():(window.dialoginits||(window.dialoginits=[]),window.dialoginits.push(a))}).then(function(){M.util.js_complete("mod_facetoface-events__dialogues_inited")}),n=c.get_strings([{key:"ok",component:"moodle"},{key:"cancel",component:"moodle"},{key:"loadinghelp",component:"moodle"}]).then(function(a){var b={ok:a[0],cancel:a[1],loading:a[2]};return b}),o=function(){for(var b=!1,c=!1,d=document.getElementById("id_defaultcapacity"),e=0;e<Number(a('input[name="cntdates"]').val());e++)if(!(a('input[name="datedelete['+e+']"]').val()>0)){var f=a('input[name="roomids['+e+']"]');if(f.val().length>0&&(c=!0),b=!0,b&&c)break}if(d.disabled=!c,!b){var g=a(".sessiondates table.f2fmanagedates");g.hide(),g.parent().append(a('<div class="nodates_notification">'+M.util.get_string("nodatesyet","facetoface")+"</div>"))}};return f.prototype={init:function(){var a=Number(document.querySelector('input[name="cntdates"]').value);this.localStrings=c.get_strings([{key:"choose"+this.type+"s",component:"mod_facetoface"},{key:"createnew"+this.type,component:"mod_facetoface"}]).then(function(a){var b={choose:a[0],create:a[1]};return b});for(var b=0;b<a;b++)if(!(document.querySelector('input[name="datedelete['+b+']"]').value>0)){var d=document.querySelector('input[name="'+this.type+"ids["+b+']"]');this.render(b),this.showCreateResouceDialog(d,b),this.showSelectResourceDialog(d,b)}},getResource:function(a){var b=this;return this.resources||(this.resources=[]),this.requested||(this.requested=[]),this.resources[a]?Promise.resolve(this.resources[a]):this.isLoading?(b.requested.indexOf(a)===-1&&b.requested.push(a),this.loadingPromise.then(function(){return b.getResource(a)})):(this.requested.push(a),this._triggerLoad().then(function(){return Promise.resolve(b.resources[a])}))},generateElement:function(a){var b=this;return this.getResource(a).then(function(a){var e=c.get_string("remove"+b.type+"x","mod_facetoface",a.name_only).then(function(a){return d.renderIcon("delete",a)}).then(function(a){return'<a href="#" data-action="removeresource">'+a+"</a>"});return Promise.all([a,b.editIcon(a),e])}).then(function(a){var c=a[0],d=document.createElement("li");return b.getLiAttributes(c,d),d.innerHTML=c.name+a[1]+a[2],d})},editIcon:function(a){var b=this;return b.manageCustom&&a.custom?c.get_string("editcustom"+b.type+"x","mod_facetoface",a.name_only).then(function(a){return d.renderIcon("edit",a)}).then(function(a){return'<a href="#" data-action="editresource">'+a+"</a>"}):Promise.resolve("")},_triggerLoad:function(){var a=this;return this.isLoading=!0,this.loadingPromise=new Promise(function(b,c){setTimeout(function(){a._loadResources().then(function(){a.isLoading=!1,b()})["catch"](c)},j)}),this.loadingPromise},_loadResources:function(){var a=this,c=new FormData;return this.requested.length>0?(c.append("facetofaceid",l.facetofaceid),c.append("itemids",a.requested),c.append("sesskey",b.sesskey),M.util.js_pending("mod_facetoface-events__loading_resources"),fetch(this.loadUrl,{credentials:"same-origin",method:"POST",body:c}).then(function(a){return a.json()}).then(function(b){a.requested=[],b.forEach(function(b){a.resources[b.id]=b}),M.util.js_complete("mod_facetoface-events__loading_resources")})):Promise.resolve()},getLiAttributes:function(a,b){b.setAttribute("data-id",a.id),b.setAttribute("data-custom",a.custom),b.classList.add(this.cssClass)},showSelectResourceDialog:function(c,d){var e=this,f=Promise.all([n,this.localStrings,m]).then(function(f){var g=f[0],h=f[1],i=new totaraDialog_handler_treeview_multiselect,j={};i._update=function(){var b=a(".selected > div > span",this._container),f=this._get_ids(b);c.value=f.join(),e.render(d),this._dialog.hide()},j[g.ok]=function(){i._update()},j[g.cancel]=function(){i._cancel()},i.oldLoad=i.load,i.load=function(b){i.oldLoad(b);var c=a(".ui-dialog [id^='select"+e.type+"s'][id$='-dialog']"),d=c.height()-a(".dialog-footer",c).outerHeight();a(".select",c).outerHeight(d)},totaraDialogs["select"+e.type+"s"+d]=new totaraDialog("select"+e.type+"s"+d+"-dialog","show-select"+e.type+"s"+d+"-dialog",{buttons:j,title:"<h2>"+h.choose+"</h2>"},function(){var c=l.sessionid;return 1==Number(l.clone)&&(c=0),e.selectUrl+"?sessionid="+c+"&facetofaceid="+l.facetofaceid+"&timestart="+a('input[name="timestart['+d+']"]').val()+"&timefinish="+a('input[name="timefinish['+d+']"]').val()+"&selected="+a('input[name="'+e.type+"ids["+d+']"]').val()+"&offset="+d+"&sesskey="+b.sesskey},i)});return f},showCreateResouceDialog:function(c,d){var e=this,f=Promise.all([n,this.localStrings,m]).then(function(f){var g=f[0],h=f[1],i=new totaraDialog_handler_form;i.every_load=function(){totaraDialog_handler_form.prototype.every_load.call(this),totaraDialogs["select"+e.type+"s"+d].handler._dialog.hide(),totaraDialogs["editcustom"+e.type+d].config.title="<h2>"+h.create+"</h2>"},i._updatePage=function(b){try{var f=a.parseJSON(b),g=[];e.forceReload(f.id),c.value.length>0&&(g=c.value.split(",")),g.indexOf(f.id.toString())===-1&&g.push(f.id),c.value=g.toString(),e.render(d),i._dialog.hide()}catch(h){this._dialog.render(b)}};var j={};j[g.ok]=function(){i.submit()},j[g.cancel]=function(){i._cancel()},totaraDialogs["editcustom"+e.type+d]=new totaraDialog("editcustom"+e.type+d+"-dialog","show-editcustom"+e.type+d+"-dialog",{buttons:j,title:"<h2>"+h.create+"</h2>"},function(){var a=0;return"undefined"!=typeof l.editcustom&&(a=Number(l.editcustom),l.editcustom=0),e.createUrl+"?id="+a+"&f="+l.facetofaceid+"&s="+l.sessionid+"&sesskey="+b.sesskey},i)});return f},forceReload:function(a){var b=document.querySelectorAll("."+this.cssClass+'[data-id="'+a+'"]');this.resources&&this.resources[a]&&delete this.resources[a],b.length>0&&this.generateElement(a).then(function(a){var c;for(c=0;c<b.length;c++)b[c].outerHTML=a.outerHTML})["catch"](e.exception)},render:function(a){if(!(document.querySelector('input[name="datedelete['+a+']"]').value>0)){var b=document.querySelector('input[name="'+this.type+"ids["+a+']"]').value.split(","),c=document.getElementById(this.type+"list"+a),d=this;if(b.length&&""!==b[0]){var f=document.createElement("li");n.then(function(a){f.innerText=a.loading})["catch"](e.exception),c.appendChild(f);var g=b.map(function(a){return d.generateElement(a)});Promise.all(g).then(function(b){c.innerHTML="",b.forEach(function(a){c.appendChild(a)}),d.updateCapacity&&d.updateCapacity(a),d.resourcesUpdated&&d.resourcesUpdated(a)})["catch"](e.exception)}}}},g.prototype=Object.assign({},f.prototype),g.prototype.type="facilitator",g.prototype.loadUrl=k+"facilitator/ajax/facilitator_item.php",g.prototype.cssClass="facilitatorname",g.prototype.selectUrl=k+"facilitator/ajax/sessionfacilitators.php",g.prototype.createUrl=k+"facilitator/ajax/edit.php",h.prototype=Object.assign({},f.prototype),h.prototype.type="asset",h.prototype.loadUrl=k+"asset/ajax/asset_item.php",h.prototype.cssClass="assetname",h.prototype.selectUrl=k+"asset/ajax/sessionassets.php",h.prototype.createUrl=k+"asset/ajax/asset_edit.php",i.prototype=Object.assign({},f.prototype),i.prototype.type="room",i.prototype.loadUrl=k+"room/ajax/room_item.php",i.prototype.cssClass="roomname",i.prototype.selectUrl=k+"room/ajax/sessionrooms.php",i.prototype.createUrl=k+"room/ajax/room_edit.php",i.prototype.getLiAttributes=function(a,b){b.setAttribute("data-id",a.id),b.setAttribute("data-custom",a.custom),b.setAttribute("data-capacity",a.capacity),b.setAttribute("data-can-manage",a.can_manage),b.setAttribute("data-is-virtual",a.virtualmeeting),b.setAttribute("data-lossy-update",a.lossyupdate),b.classList.add(this.cssClass)},i.prototype.editIcon=function(a){var b=this;return b.manageCustom&&a.custom?a.can_manage?c.get_string("editcustom"+b.type+"x","mod_facetoface",a.name_only).then(function(a){return d.renderIcon("edit",a)}).then(function(a){return'<a href="#" data-action="editresource">'+a+"</a>"}):c.get_string("virtual_meeting_not_owner","mod_facetoface",a.name_only).then(function(a){return d.renderIcon("lock",a)}):Promise.resolve("")},i.prototype.updateCapacity=function(a){var b=document.querySelectorAll('.mod_facetoface-roomlist[data-offset="'+a+'"] [data-capacity]');if(0===b.length)return document.querySelector('input[name="roomcapacity['+a+']"]').value=0,void this._updateCapacityState();var c=[];b.forEach(function(a){c.push(parseInt(a.getAttribute("data-capacity"),10))});var d=Math.min.apply(null,c);d===1/0&&(d=0),document.querySelector('input[name="roomcapacity['+a+']"]').value=d,this._updateCapacityState()},i.prototype._updateCapacityState=function(){for(var a=document.querySelector('[name="cntdates"]').value,b=!0,c=0;c<a;c++)if(1!=document.querySelector('input[name="datedelete['+c+']"]').value&&0==document.querySelector('input[name="roomcapacity['+c+']"]').value){b=!1;break}document.getElementById("id_defaultcapacity").disabled=!b},i.prototype.resourcesUpdated=function(a){var b=document.querySelectorAll("#roomlist"+a+" .roomname"),d=document.getElementById("show-selectdate"+a+"-dialog"),f=d.closest("tr"),g=!0,h=0,i=!1;b.forEach(function(a){"false"===a.getAttribute("data-can-manage")&&(g=!1),"true"===a.getAttribute("data-is-virtual")&&h++,"true"===a.getAttribute("data-lossy-update")&&(i=!0)}),e.clearNotifications(),h>1&&c.get_string("error:toomanyvirtualmeetings","mod_facetoface").then(function(a){e.addNotification({message:a})}),i&&l.sessionid&&1!=Number(l.clone)&&c.get_string("warning:meetingmaynotbepreserved","mod_facetoface").then(function(a){e.addNotification({type:"warning",message:a})}),g?f.classList.remove("mod_facetoface-date-other-virtual-room"):f.classList.add("mod_facetoface-date-other-virtual-room")},{config:{},clonefields:["roomids","assetids","facilitatorids","timestart","timefinish","sessiontimezone"],url:b.wwwroot+"/mod/facetoface/",init:function(b){l=b,this.addDOMEvents(),this.facilitatorLib=new g(b),this.assetLib=new h(b),this.roomLib=new i(b),this.config=b,this.init_dates();var d=Number(a('input[name="cntdates"]').val()),f=a('<input name="defaultcapacity" type="button" id="id_defaultcapacity">');c.get_string("useroomcapacity","mod_facetoface").then(function(a){f.val(a)})["catch"](e.exception),f.click(function(b){b.preventDefault();for(var c=0,e=0;e<d;e++)if(!(a('input[name="datedelete['+e+']"]').val()>0)){var f=Number(a('input[name="roomcapacity['+e+']"]').val());(0===c||c>f&&f>0)&&(c=f)}c>0&&a("#id_capacity").val(c)}),f.insertAfter(a("#id_capacity")),o(),a("a.dateremove").each(function(){var b=a(this).data("offset");a('input[name="datedelete['+b+']"]').val()>0&&a(this).closest("tr").hide()}),a('input[name="date_add_fields"]').click(function(){skipClientValidation=!0,a('input[name="cntdates"]').val(d+1)}),a(".sessiondates").removeClass("hidden")},addDOMEvents:function(){var b=this,c=document.querySelector(".sessiondates .f2fmanagedates"),d=document.getElementById("mform_seminar_event");c.addEventListener("click",function(c){var d=c.target.closest("[data-action]");if(d){c.preventDefault();var e=d.getAttribute("data-offset");switch(d.getAttribute("data-action")){case"removedate":document.querySelector('input[name="datedelete['+e+']"]').value=1,d.closest("tr").style.display="none",o();break;case"clonedate":var f=Number(a('input[name="cntdates"]').val()),g=d.closest("form");b.clonefields.forEach(function(a){var b=document.createElement("input");b.setAttribute("name",a+"["+f+"]"),b.value=g.elements[a+"["+e+"]"].value,g.append(b)}),a('input[name="date_add_fields"]').click();break;case"removeresource":b._removeResource(d);break;case"editresource":b._editResource(d)}}}),d.addEventListener("submit",function(a){var b=!0;c.querySelectorAll(".mod_facetoface-roomlist").forEach(function(a){var c=!1;a.querySelectorAll(".roomname").forEach(function(a){"true"===a.getAttribute("data-is-virtual")&&(c&&(b=!1),c=!0)})}),b||a.preventDefault()})},_removeResource:function(a){var b=a.closest("[data-offset]"),c=a.closest("[data-id]"),d=null;if(c.classList.contains("assetname"))d=document.querySelector('[name="assetids['+b.getAttribute("data-offset")+']"]');else if(c.classList.contains("roomname"))d=document.querySelector('[name="roomids['+b.getAttribute("data-offset")+']"]');else{if(!c.classList.contains("facilitatorname"))throw new Error("unknown resource type");d=document.querySelector('[name="facilitatorids['+b.getAttribute("data-offset")+']"]')}d.value=d.value.split(",").filter(function(a){return a!=c.getAttribute("data-id")}).join(","),b.removeChild(c),c.classList.contains("roomname")&&(this.roomLib.updateCapacity(b.getAttribute("data-offset")),this.roomLib.resourcesUpdated(b.getAttribute("data-offset")))},_editResource:function(a){var b=a.closest("[data-offset]"),c=a.closest("[data-id]"),d=b.getAttribute("data-offset");if("true"!==c.getAttribute("data-custom"))throw new Error("Not a custom resource");if(l.editcustom=c.getAttribute("data-id"),c.classList.contains("assetname"))totaraDialogs["editcustomasset"+d].config.title="<h2>"+M.util.get_string("editasset","facetoface")+"</h2>",totaraDialogs["editcustomasset"+d].open();else if(c.classList.contains("roomname"))totaraDialogs["editcustomroom"+d].config.title="<h2>"+M.util.get_string("editroom","facetoface")+"</h2>",totaraDialogs["editcustomroom"+d].open();else{if(!c.classList.contains("facilitatorname"))throw new Error("unknown resource type");totaraDialogs["editcustomfacilitator"+d].config.title="<h2>"+M.util.get_string("editfacilitator","facetoface")+"</h2>",totaraDialogs["editcustomfacilitator"+d].open()}},init_dates:function(){var d=this.url,f=this,g=c.get_strings([{key:"dateselect",component:"mod_facetoface"}]).then(function(a){return{dateselect:a[0]}});Promise.all([n,g,m]).then(function(c){var e=c[0],g=c[1];a(".mod_facetoface-show-selectdate-dialog").each(function(){var c=a(this).data("offset"),h=a("#timeframe-text"+c);if(!(a('input[name="datedelete['+c+']"]').val()>0)){h.empty(),h.text(e.loading),a.post(d+"events/ajax/date_item.php",{timestart:a('input[name="timestart['+c+']"]').val(),timefinish:a('input[name="timefinish['+c+']"]').val(),sesiontimezone:a('input[name="sessiontimezone['+c+']"]').val(),sesskey:b.sesskey},function(a){h.empty(),h.html(a),h.addClass("nonempty")},"json");var i=new totaraDialog_handler_form,j={};j[e.ok]=function(){i.submit()},j[e.cancel]=function(){i._cancel()},i._updatePage=function(b){try{var d=a.parseJSON(b);a('input[name="timestart['+c+']"]').val(d.timestart),a('input[name="timefinish['+c+']"]').val(d.timefinish),a('input[name="sessiontimezone['+c+']"]').val(d.sessiontimezone),a("#timeframe-text"+c).html(d.html),i._dialog.hide()}catch(e){this._dialog.render(b)}},totaraDialogs["selectdate"+c]=new totaraDialog("selectdate"+c+"-dialog",a(this).attr("id"),{buttons:j,title:"<h2>"+g.dateselect+"</h2>"},function(){var e=a('input[name="sessiondateid['+c+']"]').val();return 1==Number(f.config.clone)&&(e=0),d+"events/ajax/sessiondates.php?sessiondateid="+e+"&facetofaceid="+f.config.facetofaceid+"&roomids="+a('input[name="roomids['+c+']"]').val()+"&assetids="+a('input[name="assetids['+c+']"]').val()+"&facilitatorids="+a('input[name="facilitatorids['+c+']"]').val()+"&timezone="+encodeURIComponent(a('input[name="sessiontimezone['+c+']"]').val())+"&start="+a('input[name="timestart['+c+']"]').val()+"&finish="+a('input[name="timefinish['+c+']"]').val()+"&sesskey="+b.sesskey},i)}})})["catch"](e.exception)}}});