define(["jquery","core/webapi","core/localstorage","core/config","core/log"],function(a,b,c,d,e){var f=[];return{get_string:function(a,b,c){arguments.length>3&&e.debug("get_string() cannot accept lang parameter");var d=this.get_strings([{key:a,component:b,param:c}]);return d.then(function(a){return a[0]})},get_strings:function(e){var g,h,i,j=a.Deferred(),k=[],l=[],m=0,n=[],o=d.currentlanguage;for(m=0;m<e.length;m++)if(h=e[m],"undefined"==typeof h.component?h.component="moodle":"core"===h.component?h.component="moodle":"core_"===h.component.substring(0,5)?h.component=h.component.substring(5):"mod_"===h.component.substring(0,4)&&(h.component=h.component.substring(4)),"undefined"==typeof M.str[h.component]&&(M.str[h.component]=[]),"undefined"==typeof M.str[h.component][h.key]){g="core_str/"+o+"/"+h.component+"/"+h.key;var p=c.get(g);p?M.str[h.component][h.key]=JSON.parse(p):"undefined"==typeof f[g]?n.push({identifier:h.key,component:h.component,lang:o}):k.push(f[g])}if(0===n.length&&0===k.length){for(m=0;m<e.length;m++)h=e[m],l[m]=M.util.get_string(h.key,h.component,h.param);return j.resolve(l),j.promise()}if(n.length>0){var q=n.map(function(a){return a.identifier+", "+a.component}),r=b.call({operationName:"core_lang_strings_nosession",variables:{lang:o,ids:q}});for(r.then(function(a){for(m=0;m<a.lang_strings.length;m++)i=a.lang_strings[m],"undefined"==typeof M.str[i.component][i.identifier]&&(M.str[i.component][i.identifier]=i.string,c.set("core_str/"+i.lang+"/"+i.component+"/"+i.identifier,JSON.stringify(i.string)))}),k.push(r),m=0;m<n.length;m++)i=n[m],f["core_str/"+i.lang+"/"+i.component+"/"+i.identifier]=r}return Promise.all(k).then(function(){for(m=0;m<e.length;m++)h=e[m],l[m]=M.util.get_string(h.key,h.component,h.param);j.resolve(l)})["catch"](function(){for(m=0;m<e.length;m++)h=e[m],l[m]=M.util.get_string(h.key,h.component,h.param);j.resolve(l)}),j.promise()}}});