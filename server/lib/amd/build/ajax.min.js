define(["jquery","core/config","core/log","core/notification"],function(a,b,c,d){var e=!1,f=function(a){var b,c,d=this,e=null,f=0;if(a.error)for(;f<d.length;f++)b=d[f],b.deferred.reject(a);else{for(f=0;f<d.length;f++){if(b=d[f],c=a[f],"undefined"==typeof c){e=new Error("missing response");break}if(c.error!==!1){e=c.exception;break}b.deferred.resolve(c.data)}if(null!==e)for(;f<d.length;f++)b=d[f],b.deferred.reject(e)}},g=function(a,b,d){var f=this,g=0;for(g=0;g<f.length;g++){var h=f[g];e?(c.error("Page unloaded."),c.error(d)):h.deferred.reject(d)}};return{call:function(c,d,h){a(window).bind("beforeunload",function(){e=!0});var i,j=[],k=[],l=[],m="";for("undefined"==typeof h&&(h=!0),"undefined"==typeof d&&(d=!0),i=0;i<c.length;i++){var n=c[i];j.push({index:i,methodname:n.methodname,args:n.args}),n.deferred=a.Deferred(),k.push(n.deferred.promise()),"undefined"!=typeof n.done&&n.deferred.done(n.done),"undefined"!=typeof n.fail&&n.deferred.fail(n.fail),n.index=i,l.push(n.methodname)}m=l.length<=5?l.sort().join():l.length+"-method-calls",j=JSON.stringify(j);var o={type:"POST",data:j,context:c,dataType:"json",processData:!1,async:d,contentType:"application/json",headers:{"x-totara-sesskey":b.sesskey}},p="service.php";h||(p="service-nologin.php");var q=b.wwwroot+"/lib/ajax/"+p+"?info="+m;return d?a.ajax(q,o).done(f).fail(g):(o.success=f,o.error=g,a.ajax(q,o)),k},getData:function(a){var b=a.methodname+"_requesting_data",c="",e=this;return a.callback&&(c=a.callback,delete a.callback),M.util.js_pending(b),new Promise(function(f,g){var h=e.call([a],!0,!0);h[0].done(function(a){f({results:a,callbacks:c}),M.util.js_complete(b)}).fail(function(a){d.exception(a),g(a),M.util.js_complete(b)})})},getDataUpdate:function(a){var b=this;return new Promise(function(d,e){for(var f,g=[],h=0;h<a.length;h++)f=a[h],g.push(b.getData(f));Promise.all(g).then(function(a){var b,f,g,h,i,j=[];for(i=0;i<a.length;i++)for(h=a[i].results,g=a[i].callbacks,b=0;b<g.length;b++)f=g[b],"function"!=typeof f?c.error("Callback is not a function"):j.push(f(h));Promise.all(j).then(function(){d()})["catch"](function(){e()})})})}}});