define([],function(){function a(){return this instanceof a?(this.activeClass="tw-selectTree__active",this.activeSelector="data-tw-selector-active",this.clearSelector="data-tw-selectorgroup-clear",this.disabledClass="tw-selectTree--disabled",this.disabledSelector="data-tw-selecttree-disabled",this.hideClass="tw-selectTree__hidden",this.key="",this.keyboardClass="tw-selectTree__keyboard",this.manualSetSelected="data-tw-selector-manualset",this.repositionClass="tw-selectTree__reposition",this.widget="",void(this.visibility=!1)):new a}a.prototype={constructor:a,add:function(a){var b=a.getAttribute("data-tw-selectTree-urlVal"),c=a.getAttribute("data-tw-selectTree-label"),d=a.parentNode,e=d.hasAttribute("data-tw-selectTree-default");this.removeActive(),this.closeLists(),this.setCurrentLabel(c),d.classList.add(this.activeClass),e||d.setAttribute(this.activeSelector,""),this.expandActiveLists(d),this.setEventType(b)},closeLists:function(){for(var a=this.widget.querySelectorAll("[data-tw-selectTree-list]"),b=0;b<a.length;b++)if(!a[b].classList.contains(this.hideClass)){var c=a[b].previousElementSibling,d=c.querySelector("[data-tw-selectTree-toggle]");this.toggleTreeList(a[b],d)}},events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.preventDefault(),b.target&&!a.widget.classList.contains(a.disabledClass))if(b.target.closest("[data-tw-selectTree-trigger]"))a.toggleTree();else if(b.target.closest("[data-tw-selectTree-toggle]")){var c=b.target.closest("[data-tw-selectTree-toggle]"),d=c.parentNode.nextElementSibling;c.hasAttribute("data-tw-selecttree-label")&&(c=c.previousElementSibling),a.toggleTreeList(d,c)}else if(b.target.closest("[data-tw-selectTree-urlVal]")){var e=b.target.closest("[data-tw-selectTree-urlVal]");if(e.parentNode.classList.contains(a.activeClass))return;a.add(e),a.toggleTree(),a.triggerEvent("changed",{})}});var b=function(b){var c=a.widget.querySelector("[data-tw-selectTree-tree]");a.widget.contains(b.target)||c.classList.contains(a.hideClass)||a.toggleTree()};document.addEventListener("click",b),document.addEventListener("touchstart",b),this.widget.addEventListener("keydown",function(b){if(b.target){for(var c=0,d=a.widget.querySelectorAll(".tw-selectTree__list_row"),e=!1,f=0;f<d.length;++f)if(d[f]==document.activeElement.closest(".tw-selectTree__list_row")){c=f,e=!0;break}if(!e)for(var g=0;g<d.length;++g)if(d[g].classList.contains("tw-selectTree__active")){c=g;break}switch(a.widget.classList.add(a.keyboardClass),b.key){case"Enter":b.preventDefault(),b.target.click(),d[c].getElementsByClassName("tw-selectTree__list_row_link")[0].focus();break;case"Tab":var h=b.shiftKey?-1:1,i=b.shiftKey?0===c:c===d.length-1;if(i&&a.visibility)return void a.toggleTree();for(var j=!0,k=c+h;k<d.length&&k>=0;k+=h){var l=d[k].getElementsByClassName("tw-selectTree__list_row_link")[0];if(l&&0!==l.offsetHeight)return b.preventDefault(),j=!1,void l.focus()}j&&a.visibility&&a.toggleTree();break;case"ArrowUp":case"Up":if(b.preventDefault(),0===c)return;for(var m=c-1,n=m;n<d.length;++n){var o=d[m].getElementsByClassName("tw-selectTree__list_row_link")[0];if(o&&0!==o.offsetHeight)return void o.focus();m--}break;case"ArrowDown":case"Down":if(b.preventDefault(),c===d.length-1)return;for(var p=c+1;p<d.length;++p){var q=d[p].getElementsByClassName("tw-selectTree__list_row_link")[0];if(q&&0!==q.offsetHeight)return void q.focus()}break;case"ArrowLeft":case"Left":b.preventDefault();var r=d[c].getElementsByClassName("tw-selectTree__list_row_icon_expand")[0];r&&r.classList.contains("tw-selectTree__hidden")&&d[c].querySelector("[data-tw-selecttree-toggle]").click();break;case"ArrowRight":case"Right":b.preventDefault();var s=d[c].getElementsByClassName("tw-selectTree__list_row_icon_expanded")[0];s&&s.classList.contains("tw-selectTree__hidden")&&d[c].querySelector("[data-tw-selecttree-toggle]").click()}}});var c=new MutationObserver(function(){"true"===a.widget.getAttribute(a.clearSelector)&&(a.setToDefault(),a.widget.setAttribute(a.clearSelector,!1))});c.observe(this.widget,{attributes:!0,attributeFilter:[a.clearSelector],subtree:!1});var d=new MutationObserver(function(){var b=a.widget.getAttribute(a.manualSetSelected);if(b){var c=a.widget.querySelector('[data-tw-selectTree-urlVal="'+b+'"]');a.add(c)}});d.observe(this.widget,{attributes:!0,attributeFilter:[a.manualSetSelected],subtree:!1});var e=new MutationObserver(function(){"activate"===a.widget.getAttribute(a.disabledSelector)?(a.widget.classList.remove(a.disabledClass),a.widget.querySelector("[data-tw-selecttree-trigger]").setAttribute("aria-disabled",!1)):"disable"===a.widget.getAttribute(a.disabledSelector)&&(a.widget.classList.add(a.disabledClass),a.widget.querySelector("[data-tw-selecttree-trigger]").setAttribute("aria-disabled",!0)),a.widget.removeAttribute(a.disabledSelector)});e.observe(this.widget,{attributes:!0,attributeFilter:[a.disabledSelector],subtree:!1})},expandActiveLists:function(a){for(var b,c=!1;!c;)if(b=a.closest("[data-tw-selectTree-list]."+this.hideClass)){var d=b.previousElementSibling,e=d.querySelector("[data-tw-selectTree-toggle]");this.toggleTreeList(b,e)}else c=!0},preset:function(){var a=this.widget.querySelector("["+this.activeSelector+"]");if(a){var b=a.querySelector("[data-tw-selectTree-urlVal]"),c=b.getAttribute("data-tw-selectTree-urlVal");this.expandActiveLists(a),this.setEventType(c)}else{var d=this.widget.querySelector("[data-tw-selectTree-default] [data-tw-selectTree-urlVal]");if(d){var e=d.getAttribute("data-tw-selectTree-urlVal");e&&this.setEventType(e)}}},removeActive:function(){var a=this.widget.querySelectorAll("[data-tw-selectTree-tree] ["+this.activeSelector+"]"),b=this.widget.querySelector("[data-tw-selectTree-default]");b&&b.classList.remove(this.activeClass);for(var c=0;c<a.length;c++)a[c].classList.remove(this.activeClass),a[c].removeAttribute(this.activeSelector)},setCurrentLabel:function(a){var b=this.widget.querySelector("[data-tw-selectTree-current]");b.innerHTML=a},setEventType:function(a){a?this.triggerEvent("add",{key:this.key,val:a,widget:this.widget}):this.triggerEvent("remove",{key:this.key})},setKey:function(a){this.key=a},setParent:function(a){this.widget=a},setToDefault:function(){var a=this.widget.querySelector("[data-tw-selectTree-default] [data-tw-selectTree-urlVal]");if(this.removeActive(),this.closeLists(),a){var b=a.getAttribute("data-tw-selectTree-label"),c=a.getAttribute("data-tw-selectTree-urlVal"),d=a.parentNode;this.expandActiveLists(d),this.setCurrentLabel(b),d.classList.add(this.activeClass),this.setEventType(c)}else{var e=this.widget.querySelector("[data-tw-selecttree-callToActionLabel]");e&&this.setCurrentLabel(e.getAttribute("data-tw-selecttree-callToActionLabel"))}},toggleExpandIcons:function(a){var b=a.childNodes;b[0].classList.toggle(this.hideClass),b[1].classList.toggle(this.hideClass)},toggleTreeList:function(a,b){a.classList.toggle(this.hideClass),this.toggleExpandIcons(b);var c=a.classList.contains(this.hideClass)?"false":"true";b.setAttribute("aria-expanded",c)},toggleTree:function(){this.visibility=!this.visibility;var a=this.widget.querySelector("[data-tw-selectTree-tree]"),b=this.widget.querySelector("[data-tw-selectTree-trigger]");a.classList.remove(this.repositionClass),b.classList.toggle(this.activeClass),a.classList.toggle(this.hideClass);var c=a.getBoundingClientRect().right,d=document.documentElement.clientWidth;if(d<c&&a.classList.toggle(this.repositionClass),a.classList.contains(this.hideClass))a.setAttribute("aria-hidden","true"),this.widget.classList.remove(this.keyboardClass);else{a.setAttribute("aria-hidden","false");var e=a.querySelector("["+this.activeSelector+"] [data-tw-selectTree-label]"),f=e?e:a.querySelector("[data-tw-selectTree-default]");f&&(this.expandActiveLists(f),f.focus())}},triggerEvent:function(a,b){var c=new CustomEvent("totara_core/select_tree:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var b=function(b){return new Promise(function(c){var d=new a;d.setParent(b),d.setKey(b.getAttribute("data-tw-selectTree-urlkey")),d.preset(),d.events(),c(d)})};return{init:b}});