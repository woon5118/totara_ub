define(["core/templates","core/notification","core/ajax","totara_competency/modal_list","totara_competency/loader_manager"],function(a,b,c,d,e){function f(){return this instanceof f?(this.widget="",this.loader=null,this.criterion={id:0,type:"coursecompletion",itemids:[],aggregation:{method:1,reqitems:1},singleuse:!1,expandable:!0},this.criterionKey="",this.courseAdder=null,this.endpoints={detail:"criteria_coursecompletion_get_detail",courses:"totara_competency_get_courses",courseCategories:"totara_competency_get_categories"},this.domClasses={hidden:"tw-editAchievementPaths--hidden"},void(this.filename="coursecompletion.js")):new f}f.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target)if(b.target.closest("[data-tw-criterionCourseCompletion-addCourses]"))b.preventDefault(),a.addCourses();else if(b.target.closest("[data-tw-course-item-remove]")){b.preventDefault();var c,d=b.target.closest("[data-tw-course-item-value]");if(!d)return;c=d.getAttribute("data-tw-course-item-value"),a.removeCourse(c)}}),this.widget.addEventListener("change",function(b){if(b.target)if(b.target.closest("[data-tw-criterionCourseCompletion-aggregationMethod-changed]")){b.preventDefault();var c=b.target.closest("[data-tw-criterionCourseCompletion-aggregationMethod-changed]").value;a.criterion.aggregation.method!=c&&(a.setAggregationMethod(c),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}else if(b.target.closest("[data-tw-criterionCourseCompletion-aggregationCount-changed]")){b.preventDefault();var d=b.target.closest("[data-tw-criterionCourseCompletion-aggregationCount-changed]").value;a.criterion.aggregation.reqitems!=d&&(a.setAggregationCount(d),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}})},setParent:function(a){this.widget=a},getDetail:function(a){var b=this,c=a.closest("[data-tw-editScaleValuePaths-criterion-key]"),d=c.querySelector("[data-tw-criterionCourseCompletion-aggregation]");return new Promise(function(e){c&&(b.criterionKey=c.hasAttribute("data-tw-editScaleValuePaths-criterion-key")?c.getAttribute("data-tw-editScaleValuePaths-criterion-key"):"",b.criterion.id=c.hasAttribute("data-tw-editScaleValuePaths-criterion-id")?c.getAttribute("data-tw-editScaleValuePaths-criterion-id"):0),d&&(b.criterion.aggregation.method=d.getAttribute("data-tw-criterionCourseCompletion-aggregation"),b.criterion.aggregation.reqitems=d.hasAttribute("data-tw-criterionCourseCompletion-aggregation-reqitems")?d.getAttribute("data-tw-criterionCourseCompletion-aggregation-reqitems"):1),b.setAggregationMethod(b.criterion.aggregation.method),b.setAggregationCount(b.criterion.aggregation.reqitems),b.setCourses(a),b.showHideNotEnoughCourses(),Promise.all([b.initCourseAdder()]).then(function(){b.triggerEvent("update",{criterion:b.criterion}),e()})["catch"](function(){})})},setAggregationMethod:function(a){var b=this.widget.querySelector('[data-tw-criterionCourseCompletion-aggregationMethod="'+a+'"]'),c=b.querySelector("[data-tw-criterionCourseCompletion-aggregationMethod-changed]"),d=this.widget.querySelector("[data-tw-criterionCourseCompletion-aggregationCount-changed]"),e=b.querySelector("[data-tw-criterionCourseCompletion-aggregationCount-changed]");this.criterion.aggregation.method=a,c&&(c.checked=!0),d&&(d.disabled=!e),this.showHideNotEnoughCourses(),this.hideAggregationCountInfo()},setAggregationCount:function(a){var b=this.widget.querySelector("[data-tw-criterionCourseCompletion-aggregationCount-changed]"),c=parseInt(a)||0;this.criterion.aggregation.reqitems=c<1?1:c,b&&(b.value=this.criterion.aggregation.reqitems),this.showHideNotEnoughCourses(),c<1?this.showAggregationCountInfo():this.hideAggregationCountInfo()},setCourses:function(a){var b,c=a.querySelectorAll("[data-tw-course-item-value]");this.criterion.itemids=[];for(var d=0;d<c.length;d++)b=parseInt(c[d].getAttribute("data-tw-course-item-value")?c[d].getAttribute("data-tw-course-item-value"):0),b&&this.criterion.itemids.push(b)},initCourseAdder:function(){var a=this;return new Promise(function(c){var e={key:"courseAdder_"+a.criterionKey,title:[{key:"select_courses",component:"criteria_coursecompletion"}],list:{map:{cols:[{dataPath:"fullname",headerString:{key:"select_courses",component:"totara_competency"}}]},service:a.endpoints.courses},primaryDropDown:{filterKey:"category",serviceLabelKey:"fullname",placeholderString:[{component:"totara_competency",key:"all_categories"}],service:a.endpoints.courseCategories,serviceArgs:{}},primarySearch:{filterKey:"name",placeholderString:[{component:"totara_competency",key:"search_courses"}]},onSaved:function(b,c,d){a.updateCourses(d)}};d.adder(e).then(function(b){a.courseAdder=b,c(b)})["catch"](function(c){b.exception({fileName:a.filename,message:c[0]+" modal: "+c[1],name:"Error loading modal list adder"})})})},addCourses:function(){var a=this;this.courseAdder?this.courseAdder.show(this.criterion.itemids):this.initCourseAdder().then(function(){a.courseAdder.show(a.criterion.itemids)})["catch"](function(c){c.fileName=a.filename,c.name="Error initialsing the course adder",b.exception(c)})},updateCourses:function(c){for(var d,e,f,g=this,h=g.widget.querySelector("[data-tw-criterionCourseCompletion-courses]"),i=[],j={},k=0;k<c.length;k++)d=c[k].id,e=c[k].fullname,f=this.criterion.itemids.indexOf(d),f<0&&(this.criterion.itemids.push(d),j={type:"course",value:d,text:e},i.push(a.renderAppend("totara_criteria/partial_item",j,h)));i.length>0&&Promise.all(i).then(function(){g.showHideNotEnoughCourses(),g.triggerEvent("update",{criterion:g.criterion}),g.triggerEvent("dirty",{})})["catch"](function(a){a.fileName=g.filename,a.name="Showing courses",b.exception(a)})},removeCourse:function(a){a=parseInt(a);var b=this,c=b.widget.querySelector('[data-tw-course-item-value="'+a+'"]'),d=this.criterion.itemids.indexOf(a);d>=0&&(this.criterion.itemids.splice(d,1),c&&c.remove()),b.showHideNotEnoughCourses(),b.triggerEvent("update",{criterion:b.criterion}),b.triggerEvent("dirty",{})},showHideNotEnoughCourses:function(){var a=this.widget.querySelector('[data-tw-criterionCourseCompletion-error="nocourses"]'),b=this.widget.querySelector('[data-tw-criterionCourseCompletion-error="notenoughcourses"]');a&&b&&(this.criterion.itemids.length>0?(a.classList.add(this.domClasses.hidden),1==this.criterion.aggregation.method?b.classList.add(this.domClasses.hidden):this.criterion.aggregation.reqitems>this.criterion.itemids.length?b.classList.remove(this.domClasses.hidden):b.classList.add(this.domClasses.hidden)):(a.classList.remove(this.domClasses.hidden),b.classList.add(this.domClasses.hidden)))},showAggregationCountInfo:function(){var a=this.widget.querySelector('[data-tw-criterionCourseCompletion-info="aggregation-count"]');a&&a.classList.remove(this.domClasses.hidden)},hideAggregationCountInfo:function(){var a=this.widget.querySelector('[data-tw-criterionCourseCompletion-info="aggregation-count"]');a&&a.classList.add(this.domClasses.hidden)},triggerEvent:function(a,b){b.key=this.criterionKey;var c=new CustomEvent("totara_criteria/criterion:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var g=function(a){return new Promise(function(b){var c=new f;c.setParent(a),c.events(),c.loader=e.init(a),c.loader.show(),b(c),M.util.js_pending("criterionCourseCompletion"),c.getDetail(a).then(function(){c.loader.hide(),M.util.js_complete("criterionCourseCompletion")})["catch"](function(){})})};return{init:g}});