define(["core/templates","core/notification","core/ajax","totara_competency/modal_list","totara_competency/loader_manager","totara_competency/list_framework_hierarchy_events"],function(a,b,c,d,e,f){function g(){return this instanceof g?(this.widget="",this.loader=null,this.criterion={id:0,type:"othercompetency",itemids:[],aggregation:{method:1,reqitems:1},singleuse:!1,expandable:!0},this.criterionKey="",this.competencies=[],this.competencyAdder=null,this.pwCompetencyId=0,this.endpoints={detail:"criteria_othercompetency_get_detail",competencies:"totara_competency_competency_index"},this.domClasses={hidden:"tw-editAchievementPaths--hidden"},void(this.filename="othercompetency.js")):new g}g.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target)if(b.target.closest("[data-tw-criterionOtherCompetency-addCompetencies]"))b.preventDefault(),a.addCompetencies();else if(b.target.closest("[data-tw-competency-item-remove]")){b.preventDefault();var c,d=b.target.closest("[data-tw-competency-item-value]");if(!d)return;c=d.getAttribute("data-tw-competency-item-value"),a.removeCompetency(c)}}),this.widget.addEventListener("change",function(b){if(b.target)if(b.target.closest("[data-tw-criterionOtherCompetency-aggregationMethod-changed]")){b.preventDefault();var c=b.target.closest("[data-tw-criterionOtherCompetency-aggregationMethod-changed]").value;a.criterion.aggregation.method!=c&&(a.setAggregationMethod(c),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}else if(b.target.closest("[data-tw-criterionOtherCompetency-aggregationCount-changed]")){b.preventDefault();var d=b.target.closest("[data-tw-criterionOtherCompetency-aggregationCount-changed]").value;a.criterion.aggregation.reqitems!=d&&(a.setAggregationCount(d),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}})},setParent:function(a){this.widget=a},getDetail:function(a){var b=this,c=this.widget.closest("[data-tw-editScaleValuePaths-criterion-key]"),d=c.querySelector("[data-tw-criterionOtherCompetency-aggregation]"),e=document.querySelector("[data-tw-editAchievementPaths-competency]");return new Promise(function(f){e&&(b.pwCompetencyId=e.getAttribute("data-tw-editAchievementPaths-competency")),c&&(b.criterionKey=c.hasAttribute("data-tw-editScaleValuePaths-criterion-key")?c.getAttribute("data-tw-editScaleValuePaths-criterion-key"):"",b.criterion.id=c.hasAttribute("data-tw-editScaleValuePaths-criterion-id")?c.getAttribute("data-tw-editScaleValuePaths-criterion-id"):0),d&&(b.criterion.aggregation.method=d.getAttribute("data-tw-criterionOtherCompetency-aggregation"),b.criterion.aggregation.reqitems=d.hasAttribute("data-tw-criterionOtherCompetency-aggregation-reqitems")?d.getAttribute("data-tw-criterionOtherCompetency-aggregation-reqitems"):1),b.setAggregationMethod(b.criterion.aggregation.method),b.setAggregationCount(b.criterion.aggregation.reqitems),b.setCompetencies(a),b.showHideNotEnoughCompetency(),Promise.all([b.initCompetencyAdder()]).then(function(){b.triggerEvent("update",{criterion:b.criterion}),f()})["catch"](function(){})})},setAggregationMethod:function(a){var b=this.widget.querySelector('[data-tw-criterionOtherCompetency-aggregationMethod="'+a+'"]'),c=b.querySelector("[data-tw-criterionOtherCompetency-aggregationMethod-changed]"),d=this.widget.querySelector("[data-tw-criterionOtherCompetency-aggregationCount-changed]"),e=b.querySelector("[data-tw-criterionOtherCompetency-aggregationCount-changed]");this.criterion.aggregation.method=a,c&&(c.checked=!0),d&&(d.disabled=!e),this.showHideNotEnoughCompetency(),this.hideAggregationCountInfo()},setAggregationCount:function(a){var b=this.widget.querySelector("[data-tw-criterionOtherCompetency-aggregationCount-changed]"),c=parseInt(a)||0;this.criterion.aggregation.reqitems=c<1?1:c,b&&(b.value=this.criterion.aggregation.reqitems),this.showHideNotEnoughCompetency(),c<1?this.showAggregationCountInfo():this.hideAggregationCountInfo()},setCompetencies:function(a){var b,c=a.querySelectorAll("[data-tw-competency-item-value]");this.criterion.itemids=[];for(var d=0;d<c.length;d++)b=parseInt(c[d].getAttribute("data-tw-competency-item-value")?c[d].getAttribute("data-tw-competency-item-value"):0),b&&this.criterion.itemids.push(b)},odlCreateEmptyCriterion:function(){return new Promise(function(a){a({results:{id:0,items:[],aggregation:{method:1,reqitems:1}}})})},initCompetencyAdder:function(){var a=this;return new Promise(function(b,c){a.getCompetencyAdderDate().then(function(e){d.adder(e).then(function(c){a.competencyAdder=c,b(c)})["catch"](function(){c()})})["catch"](function(){c()})})},getCompetencyAdderDate:function(){var a=this;return new Promise(function(b,c){f.init().then(function(c){var d={key:"competencies",crumbtrail:{service:"totara_competency_competency_show",stringList:[{component:"criteria_othercompetency",key:"hierarchy_list_competency_all"},{component:"criteria_othercompetency",key:"hierarchy_list_competency_all_in_framework"}]},events:c,expandable:{args:{include:{crumbs:1}},service:"totara_competency_competency_show",template:"totara_competency/hierarchy_expanded"},levelToggle:!0,list:{map:{cols:[{dataPath:"fullname",expandedViewTrigger:!0,headerString:{component:"criteria_othercompetency",key:"select_competencies"}}],extraRowData:[{key:"framework",dataPath:"frameworkid"}],hasExpandedView:!0,hasHierarchy:!0},service:"totara_competency_competency_index"},onSaved:function(b,c,d){a.updateCompetencies(d)},primaryDropDown:{filterKey:"framework",placeholderString:[{component:"criteria_othercompetency",key:"all_frameworks"}],service:"totara_competency_get_frameworks",serviceArgs:{},serviceLabelKey:"fullname"},primarySearch:{filterKey:"text",placeholderString:[{component:"totara_core",key:"search"}]},title:[{component:"criteria_othercompetency",key:"hierarchy_list_competency_select"}]};b(d)})["catch"](function(){c()})})},addCompetencies:function(){var a=this,c=this.criterion.itemids.slice(0);c.push(a.pwCompetencyId),this.competencyAdder?this.competencyAdder.show(c):this.initCompetencyAdder().then(function(){a.competencyAdder.show(c)})["catch"](function(c){c.fileName=a.filename,c.name="Error initialsing the competency adder",b.exception(c)})},updateCompetencies:function(c){for(var d,e,f,g=this,h=g.widget.querySelector("[data-tw-criterionOtherCompetency-competencies]"),i=[],j={},k=0;k<c.length;k++)d=c[k].id,d!=g.pwCompetencyId&&(e=c[k].fullname,f=this.criterion.itemids.indexOf(d),f<0&&(this.criterion.itemids.push(d),j={type:"competency",value:d,text:e},i.push(a.renderAppend("totara_criteria/partial_item",j,h))));i.length>0&&Promise.all(i).then(function(){g.showHideNotEnoughCompetency(),g.triggerEvent("update",{criterion:g.criterion}),g.triggerEvent("dirty",{})})["catch"](function(a){a.fileName=g.filename,a.name="Showing competencies",b.exception(a)})},removeCompetency:function(a){a=parseInt(a);var b=this,c=b.widget.querySelector('[data-tw-competency-item-value="'+a+'"]'),d=this.criterion.itemids.indexOf(a);d>=0&&(this.criterion.itemids.splice(d,1),c&&c.remove()),b.showHideNotEnoughCompetency(),b.triggerEvent("update",{criterion:b.criterion}),b.triggerEvent("dirty",{})},showHideNotEnoughCompetency:function(){var a=this.widget.querySelector('[data-tw-criterionOtherCompetency-error="noothercompetency"]'),b=this.widget.querySelector('[data-tw-criterionOtherCompetency-error="notenoughothercompetency"]');a&&b&&(this.criterion.itemids.length>0?(a.classList.add(this.domClasses.hidden),1==this.criterion.aggregation.method?b.classList.add(this.domClasses.hidden):this.criterion.aggregation.reqitems>this.criterion.itemids.length?b.classList.remove(this.domClasses.hidden):b.classList.add(this.domClasses.hidden)):(a.classList.remove(this.domClasses.hidden),b.classList.add(this.domClasses.hidden)))},showAggregationCountInfo:function(){var a=this.widget.querySelector('[data-tw-criterionOtherCompetency-info="aggregation-count"]');a&&a.classList.remove(this.domClasses.hidden)},hideAggregationCountInfo:function(){var a=this.widget.querySelector('[data-tw-criterionOtherCompetency-info="aggregation-count"]');a&&a.classList.add(this.domClasses.hidden)},triggerEvent:function(a,b){b.key=this.criterionKey;var c=new CustomEvent("totara_criteria/criterion:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var h=function(a){return new Promise(function(b){var c=new g;c.setParent(a),c.events(),c.loader=e.init(a),c.loader.show(),b(c),M.util.js_pending("criterionOtherCompetency"),c.getDetail(a).then(function(){c.loader.hide(),M.util.js_complete("criterionOtherCompetency")})["catch"](function(){})})};return{init:h}});