define(["core/ajax","core/log","core/templates"],function(a,b,c){function d(a){var b="totara_msteams:config_tab:";return b+=1===arguments.length?a:Array.prototype.reduce.call(arguments,function(a,b){return a+":"+b}),M.util.js_pending(b),function(){M.util.js_complete(b)}}function e(a,b){var c,d="totara_msteams:config_tab:debounce:"+ ++g;return function(){var e=this,f=arguments,g=function(){c=null,a.apply(e,f),M.util.js_complete(d)};c?clearTimeout(c):M.util.js_pending(d),c=setTimeout(g,b||0)}}function f(a){this._init(a)}var g=0;return function(){function a(a){var b=getComputedStyle(a);return["height","marginTop","marginBottom","paddingTop","paddingBottom"].reduce(function(a,c){return a+parseFloat(b[c])},0)}function b(a){return null===a?"":a.getAttribute(g.URL)}function d(a){return null===a?"":a.getAttribute(g.TITLE)}var e={TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40},f={LOADING:"totara_msteams_form__list--loading",LIST_ITEM:"totara_msteams_form__list__item",LIST_ITEM_ACTIVE:"totara_msteams_form__list__item--active",DOT_LIST_ITEM:".totara_msteams_form__list__item",DOT_LIST_ITEM_EMPTY:".totara_msteams_form__list__item--empty",DOT_LIST_SPINNER:".totara_msteams_form__list__spinner"},g={URL:"data-url",TITLE:"data-title"},h=0;this._init=function(a){this.el=a,this.el.addEventListener("scroll",this._onScroll.bind(this)),this.el.addEventListener("focus",this._onFocus.bind(this)),this.el.addEventListener("mousedown",this._onMouseDown.bind(this)),this.el.addEventListener("keydown",this._onKeyDown.bind(this)),this._id=++h,this._request=0,this._more=!1,this._loadingMore=!1,this._selectedItem=null,this._searchText="",this._timerClear=null,this._fetchLimit=10,this._calcLimit(),this.refresh()},this.getSelectedUrl=function(){return b(this._selectedItem)},this.getSelectedTitle=function(){return d(this._selectedItem)},this.refresh=function(a,b){"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=this._fetchLimit),this._clearIncrementalSearchState(),0===a&&Array.prototype.forEach.call(this.el.querySelectorAll(f.DOT_LIST_ITEM_EMPTY),function(a){a.parentNode.removeChild(a)});var c=this._getAllItems(),d=c.indexOf(this._selectedItem);d!==-1&&d>=a&&this._selectItem(null,!1),a<c.length&&c.splice(a).forEach(function(a){a.parentNode.removeChild(a)}),this.el.classList.add(f.LOADING),this._loadingMore=!1,this._fireEventLoad(a,b)},this._calcLimit=function(){var b=document.createElement("li");b.className=f.LIST_ITEM,this.el.appendChild(b);var c=a(b);this.el.removeChild(b),c<=0?this._fetchLimit=10:this._fetchLimit=Math.ceil(this.el.clientHeight/c*1.25)+1},this._selectFirstItem=function(){var a=this._getAllItems();this._selectItem(a.length?a[0]:null,!0)},this._selectLastItem=function(){var a=this._getAllItems();this._selectItem(a.length?a[a.length-1]:null,!0)},this._getAllItems=function(){return Array.prototype.slice.apply(this.el.querySelectorAll(f.DOT_LIST_ITEM))},this._selectItem=function(a,b){if(a!==this._selectedItem){b&&this._clearIncrementalSearchState();var c=null;if(this._getAllItems().forEach(function(b){b===a?(b.classList.add(f.LIST_ITEM_ACTIVE),b.setAttribute("aria-selected",!0),c=a):(b.classList.remove(f.LIST_ITEM_ACTIVE),b.removeAttribute("aria-selected"))}),this._selectedItem=c,c){if(this.el.setAttribute("aria-activedescendant",c.id),this.el.scrollHeight>this.el.clientHeight){var d=this.el.scrollTop+this.el.clientHeight,e=c.offsetTop+c.offsetHeight;e>d?this.el.scrollTop=e-this.el.clientHeight:c.offsetTop<this.el.scrollTop&&(this.el.scrollTop=c.offsetTop)}}else this.el.removeAttribute("aria-activedescendant");this._fireEventChange(c)}},this._updateCallback=function(a){var b=this;return new Promise(function(d){var e=function(c){var e=document.createElement("ul");e.innerHTML=c;for(var g=b.el.querySelector(f.DOT_LIST_SPINNER),h=0,i=e.querySelectorAll(f.DOT_LIST_ITEM+","+f.DOT_LIST_ITEM_EMPTY),j=i.length;h<j;h++)b.el.insertBefore(i[h],g);b._getAllItems().forEach(function(a,c){a.id="msteams_listbox_"+b._id+"_"+c}),b._more=a.more,b._loadingMore=!1,b.el.classList.remove(f.LOADING),d()};c.render("totara_msteams/listbox_items",a).done(e)})},this._fireEventLoad=function(a,b){var c=++this._request,d=new CustomEvent("listbox:requestitems",{bubbles:!0,detail:{update:function(a){return c===this._request?this._updateCallback(a):Promise.resolve()}.bind(this),from:a,limit:b}});this.el.dispatchEvent(d)},this._fireEventChange=function(a){var c={target:a};Object.defineProperties(c,{url:{get:function(){return b(a)}},title:{get:function(){return d(a)}}});var e=new CustomEvent("listbox:change",{bubbles:!0,detail:c});this.el.dispatchEvent(e)},this._onScroll=function(){if(this._more&&!this._loadingMore){var a=this.el.scrollTop+this.el.clientHeight,b=this.el.scrollHeight;if(b-10<=a){this._loadingMore=!0,this.el.classList.add(f.LOADING);var c=this.el.querySelector(f.DOT_LIST_SPINNER);this.el.scrollTop=c.offsetTop+c.offsetHeight-this.el.clientHeight,this._fireEventLoad(this._getAllItems().length,this._fetchLimit)}}},this._onFocus=function(){null===this._selectedItem&&this._selectFirstItem()},this._onMouseDown=function(a){if(a.buttons%2!==0){var b=a.target.closest(f.DOT_LIST_ITEM);b&&this._selectItem(b,!0)}},this._onKeyDown=function(a){var b=a.which||a.keyCode;switch(b){case e.HOME:return a.preventDefault(),void this._selectFirstItem();case e.END:return a.preventDefault(),void this._selectLastItem();case e.DOWN:case e.UP:return a.preventDefault(),void this._onKeyUpOrDown(a);case e.ESCAPE:return a.preventDefault(),void this._clearIncrementalSearchState()}if(1===(""+a.key).length){a.preventDefault();var c=this._incrementalSearchItem(a.key);null!==c&&this._selectItem(c,!1)}},this._onKeyUpOrDown=function(a){var b=this._getAllItems(),c=b.indexOf(this._selectedItem);c!==-1&&(c=a.keyCode==e.UP?Math.max(0,c-1):Math.min(b.length-1,c+1),this._selectItem(b[c],!0))},this._incrementalSearchItem=function(a){var b=this._getAllItems(),c=b.indexOf(this._selectedItem);this._searchText+=a,this._initiateTimer(),c!==-1&&1!==this._searchText.length||++c;for(var e=0,f=b.length,g=this._searchText.toUpperCase();e<f;e++){var h=b[(c+e)%f],i=d(h).toUpperCase();if(0===i.indexOf(g))return h}return null},this._initiateTimer=function(){var a=this;this._timerClear&&clearTimeout(this._timerClear),a._timerClear=setTimeout(function(){a._timerClear=null,a._searchText=""},700)},this._clearIncrementalSearchState=function(){this._timerClear&&(clearTimeout(this._timerClear),this._timerClear=null),this._searchText=""}}.call(f.prototype),{form:null,name:null,search:null,list:null,inList:!1,debug:!1,init:function(a){var b=this,e=d("init");return new Promise(function(d){function g(){c.render("totara_msteams/config_tab",a.context).done(function(g,h){var i=document.getElementById(a.id);i.innerHTML=g,c.runTemplateJS(h).then(function(){b.form=i.querySelector(".totara_msteams__config"),b.form.addEventListener("listbox:change",b._onChange.bind(b)),b.form.addEventListener("listbox:requestitems",b._onRequestItems.bind(b)),b.name=document.getElementById(a.context.name.id),b.name.addEventListener("input",b._onNameInput.bind(b)),b.search=document.getElementById(a.context.search.id),b.search.addEventListener("input",b._onSearchInput.bind(b)),b.list=new f(document.getElementById(a.context.list.idlist)),setTimeout(function(){var a=i.querySelector("[autofocus]");a&&a.focus(),e()},1),d()})})}microsoftTeams.initialize(g)})},_onSearchInput:e(function(){this.list.refresh()},400),_onNameInput:function(){this.inList||this._update()},_onChange:function(a){this.name.value=a.detail.title,this.inList=!0;var b=new CustomEvent("input",{bubbles:!0});this.name.dispatchEvent(b),this.inList=!1,this._update()},_onRequestItems:function(c){var e=d("requestItems"),f=a.call([{methodname:"totara_msteams_search_catalog",args:{query:this.search.value,from:c.detail.from,limit:c.detail.limit}}],!0,!0);f[0].then(function(a){c.detail.update(a).then(e)["catch"](function(a){b.error(a)})}).fail(function(a){b.error(a)})},_update:function(){var a=null,b=this.name.value;if(b){var e=this.list.getSelectedUrl();e&&0===e.indexOf(M.cfg.wwwroot)&&(a={contentUrl:M.cfg.wwwroot+"/totara/msteams/tabs/customtab.php?url="+encodeURIComponent(e),websiteUrl:e,suggestedTabName:b})}if(a){var f=this;microsoftTeams.settings.setValidityState(!0),microsoftTeams.settings.registerOnSaveHandler(function(b){var e=d("update");c.render("totara_msteams/spinner",{}).done(function(c){f.form.innerHTML=c,microsoftTeams.settings.setSettings(a),b.notifySuccess(),e()})})}else microsoftTeams.settings.setValidityState(!1)}}});