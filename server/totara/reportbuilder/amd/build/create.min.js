define(["core/templates","core/webapi","core/flex_icon","core/config","core/str","core/notification"],function(a,b,c,d,e,f){function g(b){if(!(this instanceof g))return new g;var d=this;this.widget=b,this.gridContainer=b.querySelector("[data-tw-report-create-container]"),this.loadContainer=b.querySelector("[data-tw-report-create-load]"),this.loadButton=this.loadContainer.innerHTML,this.tiles=[],this.stringPromise=e.get_strings([{key:"template",component:"totara_reportbuilder"},{key:"reportsourcepill",component:"totara_reportbuilder"}]).then(function(a){return d.strings={template:a[0],reportsource:a[1]},d.strings})["catch"](f.exception);var i=["graphicons/report_tile_image_column","graphicons/report_tile_image_line","graphicons/report_tile_image_bar","graphicons/report_tile_image_pie","graphicons/report_tile_image_scatter","graphicons/report_tile_image_area","graphicons/report_tile_image_donut","graphicons/report_tile_image_progress","graphicons/report_tile_image_nograph"].map(function(a){return c.getIconData(a,"totara_core",{alt:""})});this.graphPromises=Promise.all(i).then(function(a){return d.graphIcons={column:a[0],line:a[1],bar:a[2],pie:a[3],scatter:a[4],area:a[5],doughnut:a[6],progress:a[7],none:a[8]},d.graphIcons})["catch"](f.exception),this.filters=[],this.search="",this.currentIndex=0,this.currentRequest=null,this.loadingSpinner=a.render("totara_reportbuilder/loading_overlay",{}),this.loadRecords(h)}var h=20;g.prototype={constructor:g,events:function(){var a=this;this.widget.querySelector("[data-tw-report-create-container]").addEventListener("click",function(b){if(b.target.matches("[data-tw-create-report-create]"))return b.preventDefault(),void a.createReport(b.target)}),this.loadContainer.addEventListener("click",function(b){if(b.target.matches("button")){var c=a.displayLoadingSpinner(a.loadContainer,!0);b.preventDefault(),a.loadRecords(h,c)}}),this.widget.addEventListener("totara_core/grid:add",function(b){a.openDetails(b)}),this.widget.addEventListener("totara_core/select_multi:add",function(b){a.filters.push(b.detail.val),a.updateFilters()}),this.widget.addEventListener("totara_core/select_multi:remove",function(b){a.filters.splice(a.filters.indexOf(b.detail.val),1),a.updateFilters()}),this.widget.addEventListener("totara_core/select_search_text:add",function(b){a.search=b.detail.val,a.updateFilters()}),this.widget.addEventListener("totara_core/select_search_text:remove",function(b){a.search="",a.updateFilters()}),this.widget.addEventListener("totara_core/toggle_filter_panel:changed",function(b){var c=a.widget.querySelector(b.detail.targetwidget);c.classList.toggle(b.detail.toggleClass),a.updateFilters()})},openDetails:function(c){var d=c.detail.val.split("-"),e=d[0],g=d[1],h=this.widget.querySelector('[data-tw-grid-item-ID="'+c.detail.val+'"]');if(h){c.preventDefault();var i=h.querySelector("[data-tw-report-create-details]");if(i&&""!==i.innerHTML){this.displayLoadingSpinner(i);var j="totara_reportbuilder_"+g;M.util.js_pending("totara_reportbuilder-create--open_details"),b.call({operationName:j,variables:{key:e}}).then(function(b){var c=b[j],d=[];return c.defaultcolumns.forEach(function(a){if(0===d.length)d.push({groupName:a.type,values:[a.name]});else{var b=d.filter(function(b){return b.groupName==a.type});b.length?b[0].values.push(a.name):d.push({groupName:a.type,values:[a.name]})}}),c.defaultcolumns=d,a.render("totara_reportbuilder/details",c)}).then(function(a){i.innerHTML=a,M.util.js_complete("totara_reportbuilder-create--open_details")})["catch"](f.exception)}}},createReport:function(a){var c=d.wwwroot+a.getAttribute("data-tw-create-report-create"),e=a.closest("[data-tw-grid-item]"),g=e.getAttribute("data-tw-grid-item-ID").split("-"),h="",i={key:g[0]};h="template"===g[1]?"totara_reportbuilder_create_report_from_template":"totara_reportbuilder_create_report",M.util.js_pending("totara_reportbuilder-create--createReport"),b.call({operationName:h,variables:i}).then(function(a){var b=a[h];window.location.href=c+="?id="+b})["catch"](f.exception)},loadRecords:function(c,d){var g=this,h="totara_reportbuilder_creation_sources",i=this.tiles;M.util.js_pending("totara_reportbuilder-create--loadRecords");var j=b.call({operationName:h,variables:{start:this.currentIndex,limit:c,label:this.filters,search:this.search}});g.request=j,Promise.all([j,this.stringPromise,this.graphPromises]).then(function(b){var f=b[0],j=b[1],k=b[2],l=f[h];l.templates.forEach(function(a){i.push({template_name:"totara_reportbuilder/create_report_tile",template_data:{title:a.fullname,classname:a.key,type:"template",primary_label:a.label,secondary_label:j.template,template:"totara_reportbuilder/create_report_tile",graphimagetemplate:k[a.graph].template,graphimagedata:k[a.graph].context,itemid:a.key+"-template"}})}),l.sources.forEach(function(a){i.push({template_name:"totara_reportbuilder/create_report_tile",template_data:{title:a.fullname,classname:a.key.replace("rb_source_",""),type:"source",primary_label:a.label,secondary_label:j.reportsource,template:"totara_reportbuilder/create_report_tile",graphimagetemplate:k.none.template,graphimagedata:k.none.context,itemid:a.key.replace("rb_source_","")+"-source"}})}),i.length<l.totalcount?g.currentIndex+=c:g.currentIndex=0;var m=a.render("totara_core/grid",{tiles:i,single_column:!1}),n=e.get_string("xrecords","totara_reportbuilder",i.length);return Promise.all([m,n,d])}).then(function(b){return j!==g.currentRequest?"":(0===g.currentIndex?g.loadContainer.setAttribute("data-tw-report-create-disabled",!0):g.loadContainer.removeAttribute("data-tw-report-create-disabled"),g.widget.querySelector("[data-totara_reportbuilder-create_report-results_count]").innerHTML=b[1],g.gridContainer.innerHTML=b[0],g.currentIndex=g.gridContainer.querySelectorAll("[data-tw-grid-item]").length,g.widget.setAttribute("data-tw-report-create-loaded",!0),g.loadContainer.innerHTML=g.loadButton,g.tiles=i,a.runTemplateJS())}).then(function(){M.util.js_complete("totara_reportbuilder-create--loadRecords")})["catch"](f.exception),this.currentRequest=j},updateFilters:function(){var a=this.displayLoadingSpinner(this.gridContainer,!0);this.currentIndex=0,this.tiles=[],this.loadRecords(h,a)},displayLoadingSpinner:function(a,b){return this.loadingSpinner.then(function(c){(b||""===a.innerHTML.trim())&&(a.innerHTML=c)})}};var i=function(a){return new Promise(function(b){var c=new g(a);c.events(),b(c)})};return{init:i}});