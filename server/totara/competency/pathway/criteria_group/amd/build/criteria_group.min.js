define(["core/str","core/notification","core/templates","totara_competency/loader_manager"],function(a,b,c,d){function e(){return this instanceof e?(this.widget="",this.pathway={id:0,type:"criteria_group",scalevalue:0,sortorder:0,criteria:[]},this.pwKey="",this.lastCriterionKey=0,this.criteria={},this.criteriaLength=0,this.markedForDeletionCriteria={},this.typeModal=null,this.endpoints={create:"pathway_criteria_group_create",update:"pathway_criteria_group_update"},this.filename="criteria_group.js",this.busyAddCriterion="",void(this.loader=null)):new e}e.prototype={events:function(){var a,c=this;this.widget.addEventListener("click",function(d){if(!d.target)return!1;if(d.target.closest("[data-cg-action]"))a=d.target.closest("[data-cg-action]").getAttribute("data-cg-action"),"addcriterion"===a&&c.showCriteriaTypeOptions();else if(d.target.closest('[data-tw-editScaleValuePaths-dropDown-level="criteria_group"]')){var e=d.target.closest('[data-tw-editScaleValuePaths-dropDown-level="criteria_group"]');c.hideCriteriaTypeSelectors(),c.addCriterion(c.pwKey,e)}else if(d.target.closest("[data-tw-editScaleValuePaths-criterion-action]")){var f,g=d.target.closest("[data-tw-editScaleValuePaths-criterion-action]"),h=g.closest("[data-tw-editScaleValuePaths-criterion-key]"),i=h.querySelector("button");if(a=g.getAttribute("data-tw-editScaleValuePaths-criterion-action"),!h)return b.exception({fileName:c.filename,message:"Can't determine target of the "+a+" criterion action",name:"No criterion action target"}),!1;if(c.hideCriteriaTypeSelectors(),f=h.getAttribute("data-tw-editScaleValuePaths-criterion-key"),"toggle-detail"===a){c.toggleCriterionDetail(f);var j=i.getAttribute("aria-expanded"),k="true"===j?"false":"true";i.setAttribute("aria-expanded",k)}else"remove"===a?c.removeCriterion(f):"undo"===a&&c.undoCriterionRemoval(f)}return!1})},bubbledEventsListener:function(){var a,b,c=this,d="totara_criteria/criterion:";this.widget.addEventListener(d+"update",function(d){a=d.detail.key,b=d.detail.criterion,b&&(c.criteria[a]||(c.criteria[a]={id:b.id?b.id:0,type:b.type?b.type:"",title:b.title?b.title:"",singleuse:b.singleuse||!1,expandable:b.expandable||!1},c.markedForDeletionCriteria[a]&&delete c.markedForDeletionCriteria[a],c.criteriaLength+=1),b.singleuse&&(c.hideAddCriteriaDropdown(),c.triggerEvent("singleUseCriterion",{used:!0,scalevalue:c.pathway.scalevalue})),delete b.singleuse,delete b.expandable,c.criteria[a].detail=b),c.packCriteria(),c.unsetBusyAddCriterion(),c.triggerEvent("update",{pathway:c.pathway})}),this.widget.addEventListener(d+"dirty",function(b){a=b.detail.key,c.criteria[a]&&(c.criteria[a].dirty=!0,c.triggerEvent("dirty",{}))})},setParent:function(a){this.widget=a},initData:function(){var a=this,b=this.widget.closest("[data-tw-editAchievementPaths-pathway-key]"),c=this.widget.closest("[data-tw-editScaleValuePaths-value]"),d=0,e=0,f="pathwayCriteriaGroupInit_";return new Promise(function(g){if(b&&(d=b.getAttribute("data-tw-editAchievementPaths-pathway-key")?b.getAttribute("data-tw-editAchievementPaths-pathway-key"):0,e=b.getAttribute("data-tw-editAchievementPaths-pathway-id")?b.getAttribute("data-tw-editAchievementPaths-pathway-id"):0,f+=d),M.util.js_pending(f),a.pwKey=d,c&&(a.pathway.scalevalue=c.getAttribute("data-tw-editScaleValuePaths-value")?c.getAttribute("data-tw-editScaleValuePaths-value"):1),0===e){delete a.pathway.id;var h=document.querySelector("[data-tw-editAchievementPaths-competency]"),i=1;h&&(i=h.getAttribute("data-tw-editAchievementPaths-competency")),a.pathway.competency_id=i,a.widget.setAttribute("data-tw-editAchievementPaths-save-endPoint",a.endpoints.create)}else a.widget.setAttribute("data-tw-editAchievementPaths-save-endPoint",a.endpoints.update),a.pathway.id=e;a.toggleSingleUse(!1),a.triggerEvent("update",{pathway:a.pathway}),M.util.js_complete(f),g()})},getNextCriterionKey:function(){return this.lastCriterionKey++,this.pwKey+"_new_criterion_"+this.lastCriterionKey},packCriteria:function(){this.pathway.criteria=[];for(var a in this.criteria)this.criteria[a].detail&&this.pathway.criteria.push(this.criteria[a].detail)},hideBottomActions:function(){var a=this.widget.closest("[data-tw-editAchievementPaths-pathway-key]").querySelector("[data-tw-editScaleValuePaths-group-add]");a.classList.add("tw-editAchievementPaths--hidden")},showBottomActions:function(){var a=this.widget.closest("[data-tw-editAchievementPaths-pathway-key]").querySelector("[data-tw-editScaleValuePaths-group-add]");a.classList.remove("tw-editAchievementPaths--hidden")},hideCriteriaTypeSelectors:function(){for(var a=document.querySelectorAll("[data-tw-editScaleValuePaths-dropDown]"),b=0;b<a.length;b++)a[b].classList.add("tw-editAchievementPaths--hidden");for(var c=document.querySelectorAll('[data-cg-action="addcriterion"]'),b=0;b<c.length;b++)c[b].setAttribute("aria-expanded",!1)},showCriteriaTypeOptions:function(){var a=this.widget.querySelector('[data-tw-editScaleValuePaths-dropDown="criteria_group"]'),b=!!a&&!a.classList.contains("tw-editAchievementPaths--hidden"),c=a.previousElementSibling;this.hideCriteriaTypeSelectors(),a&&!b&&(a.classList.remove("tw-editAchievementPaths--hidden"),c&&c.setAttribute("aria-expanded","true"))},addCriterion:function(a,d){var e,f=this,g=this.widget.querySelector("[data-tw-editScaleValuePaths-group-criteria]"),h="pathway_criteria_group/scalevalue_group_criteria",i=d.getAttribute("data-tw-editScaleValuePaths-dropDown-item-type"),j=d.getAttribute("data-tw-editScaleValuePaths-dropDown-item-title"),k=d.getAttribute("data-tw-editScaleValuePaths-dropDown-item-template"),l=d.getAttribute("data-tw-editScaleValuePaths-dropDown-item-singleUse");""===this.busyAddCriterion&&(this.setBusyAddCriterion(i),e=f.getNextCriterionKey(),this.criteria[e]={key:e,type:i,title:j,criterion_templatename:k,singleuse:!!+l},this.criteria[e].expandable=!this.criteria[e].singleuse,this.criteriaLength>0&&(this.criteria[e].showand=!0),this.criteriaLength+=1,c.renderAppend(h,{criteria:this.criteria[e]},g).then(function(){c.runTemplateJS(""),f.triggerEvent("dirty",{})})["catch"](function(a){a.fileName=f.filename,a.name="Error displaying "+i,b.exception(a),f.unsetBusyAddCriterion()}))},toggleSingleUse:function(a){var b=this.widget.querySelectorAll('[data-tw-editScaleValuePaths-dropDown-item-singleUse="1"]');if(b.length>0)if(a)for(var c=0;c<b.length;c++)b[c].removeAttribute("disabled");else for(var d=0;d<b.length;d++)b[d].setAttribute("disabled","")},hideAddCriteriaDropdown:function(){var a=this.widget.querySelector(".tw-editScaleValuePaths__addButton");a&&a.classList.add("tw-editAchievementPaths--hidden")},toggleCriterionDetail:function(a){var b=this.widget.querySelector('[data-tw-editScaleValuePaths-criterion-key="'+a+'"]'),c=this.widget.querySelector('[data-tw-editScaleValuePaths-criterion-detail="'+a+'"]'),d=b.hasAttribute("data-tw-editScaleValuePaths-criterion-detail-expanded")?b.getAttribute("data-tw-editScaleValuePaths-criterion-detail-expanded"):0,e=b.querySelector('[data-tw-editScaleValuePaths-criterion-detail-icon="expanded"]'),f=b.querySelector('[data-tw-editScaleValuePaths-criterion-detail-icon="collapsed"]');1==d?(c.classList.add("tw-editAchievementPaths--hidden"),e.classList.add("tw-editAchievementPaths--hidden"),f.classList.remove("tw-editAchievementPaths--hidden"),b.removeAttribute("data-tw-editScaleValuePaths-criterion-detail-expanded")):(c.classList.remove("tw-editAchievementPaths--hidden"),e.classList.remove("tw-editAchievementPaths--hidden"),f.classList.add("tw-editAchievementPaths--hidden"),b.setAttribute("data-tw-editScaleValuePaths-criterion-detail-expanded","1"))},removeCriterion:function(a){var b=this.widget.querySelector('[data-tw-editScaleValuePaths-criterion-key="'+a+'"]'),c=this.widget.querySelector('[data-tw-editAchievementPaths-and-key="'+a+'"]'),d=b.querySelector("[data-tw-editScaleValuePaths-criterion-active]"),e=b.querySelector("[data-tw-editScaleValuePaths-criterion-deleted]"),f=b.querySelector('[data-tw-editScaleValuePaths-criterion-action="remove"]'),g=b.querySelector('[data-tw-editScaleValuePaths-criterion-action="undo"]'),h={},i="removeCriterion"+a;M.util.js_pending(i),this.criteria[a]?(this.criteria[a].singleuse&&(this.triggerEvent("singleUseCriterion",{used:!1,scalevalue:this.pathway.scalevalue}),this.showBottomActions()),this.criteria[a].id&&0!=this.criteria[a].id?(h[a]=this.criteria[a],Object.assign(this.markedForDeletionCriteria,h),delete this.criteria[a],this.packCriteria(),d&&d.classList.add("tw-editAchievementPaths--hidden"),e&&e.classList.remove("tw-editAchievementPaths--hidden"),f&&f.classList.add("tw-editAchievementPaths--hidden"),g&&g.classList.remove("tw-editAchievementPaths--hidden"),this.triggerEvent("update",{pathway:this.pathway}),this.triggerEvent("dirty",{}),M.util.js_complete(i)):(b&&b.remove(),c?c.remove():this.pathway.criteria.length>1&&(c=this.widget.querySelector("[data-tw-editAchievementPaths-and-key]"),c&&c.remove()),delete this.criteria[a],this.packCriteria(),0==this.pathway.criteria.length?this.triggerEvent("remove",{pendingJsKey:i}):(this.triggerEvent("update",{pathway:this.pathway}),M.util.js_complete(i)),this.triggerEvent("dirty",{})),this.criteriaLength-=1):M.util.js_complete(i)},undoCriterionRemoval:function(c){if(this.markedForDeletionCriteria[c]){var d=this.widget.querySelector('[data-tw-editScaleValuePaths-criterion-key="'+c+'"]'),e=d.querySelector("[data-tw-editScaleValuePaths-criterion-active]"),f=d.querySelector("[data-tw-editScaleValuePaths-criterion-deleted]"),g=d.querySelector('[data-tw-editScaleValuePaths-criterion-action="remove"]'),h=d.querySelector('[data-tw-editScaleValuePaths-criterion-action="undo"]'),i={},j="undoRemoveCriterion"+c;if(M.util.js_pending(j),this.markedForDeletionCriteria[c].singleuse){var k=this.hasSingleUseCriteria();if(k)return b.clearNotifications(),a.get_string("error_cant_undo_single_use","pathway_criteria_group").done(function(a){b.addNotification({message:a,type:"error"}),window.scrollTo(0,0)}).fail(b.exception),M.util.js_complete(j),!1}i[c]=this.markedForDeletionCriteria[c],Object.assign(this.criteria,i),delete this.markedForDeletionCriteria[c],this.packCriteria(),this.criteria[c].singleuse?this.triggerEvent("singleUseCriterion",{used:!0,scalevalue:this.pathway.scalevalue}):this.toggleSingleUse(!1),e&&e.classList.remove("tw-editAchievementPaths--hidden"),f&&f.classList.add("tw-editAchievementPaths--hidden"),g&&g.classList.remove("tw-editAchievementPaths--hidden"),h&&h.classList.add("tw-editAchievementPaths--hidden"),this.triggerEvent("update",{pathway:this.pathway}),this.triggerEvent("dirty",{}),this.criteriaLength+=1,M.util.js_complete(j)}},hasSingleUseCriteria:function(){var a=document.querySelector("[data-tw-editAchievementPaths-criteria-singleUse]"),b=0;return a&&(b=a.getAttribute("data-tw-editAchievementPaths-criteria-singleUse")),!!+b},triggerEvent:function(a,b){b.key=this.pwKey;var c=new CustomEvent("totara_competency/pathway:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)},setBusyAddCriterion:function(a){this.busyAddCriterion=a,M.util.js_pending(this.busyAddCriterion),this.loader.show()},unsetBusyAddCriterion:function(){this.loader.hide(),M.util.js_complete(this.busyAddCriterion),this.busyAddCriterion=""}};var f=function(a){return new Promise(function(b){var c=new e;c.setParent(a),c.events(),c.bubbledEventsListener(),c.loader=d.init(a),b(c),M.util.js_pending("pathwayCriteriaGroup"),c.loader.show(),c.initData().then(function(){c.loader.hide(),M.util.js_complete("pathwayCriteriaGroup")})["catch"](function(){})})};return{init:f}});