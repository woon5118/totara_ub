define(["core/templates","core/notification","core/ajax","totara_competency/modal_list"],function(a,b,c,d){function e(){return this instanceof e?(this.widget="",this.pathway={id:0,type:"manual",sortorder:0,roles:[]},this.pwKey="",this.rolesPicker=null,this.fullRoles=[],this.roleIds=[],this.endpoints={create:"pathway_manual_create",update:"pathway_manual_update",allroles:"pathway_manual_get_roles"},void(this.filename="manual.js")):new e}e.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target){if(b.target.closest("[data-pw-manual-action]")){var c=b.target.closest("[data-pw-manual-action]").getAttribute("data-pw-manual-action");"addraters"===c&&a.pickRaters()}if(b.target.closest("[data-pw-item-remove]")&&b.target.closest("[data-pw-item-id]")){var d=b.target.closest("[data-pw-item-id]").getAttribute("data-pw-item-id");a.removeRole(d)}}})},setParent:function(a){this.widget=a},initData:function(){var a=this,c=this.widget.closest("[data-tw-editAchievementPaths-pathway-key]"),d=0,e=0;return new Promise(function(f,g){if(c&&(d=c.getAttribute("data-tw-editAchievementPaths-pathway-key")?c.getAttribute("data-tw-editAchievementPaths-pathway-key"):0,e=c.getAttribute("data-tw-editAchievementPaths-pathway-id")?c.getAttribute("data-tw-editAchievementPaths-pathway-id"):0),a.pwKey=d,0===e){delete a.pathway.id;var h=document.querySelector("[data-tw-editAchievementPaths-competency]"),i=1;h&&(i=h.getAttribute("data-tw-editAchievementPaths-competency")),a.pathway.competency_id=i,a.widget.setAttribute("data-tw-editAchievementPaths-save-endPoint",a.endpoints.create)}else a.pathway.id=e,a.widget.setAttribute("data-tw-editAchievementPaths-save-endPoint",a.endpoints.update),a.getRoles();a.showHideNoRaters(),a.initRolesPicker().then(function(){a.triggerEvent("update",{pathway:a.pathway}),f()})["catch"](function(c){b.exception({fileName:a.filename,message:c[0]+" modal: "+c[1],name:"Error initialising manual data"}),g()})})},getRoles:function(){for(var a,b=this.widget.querySelectorAll(".pw_item"),c=0;c<b.length;c++)a={},a.id=parseInt(b[c].getAttribute("data-pw-item-id")?b[c].getAttribute("data-pw-item-id"):0),a.value=b[c].getAttribute("data-pw-item-value")?b[c].getAttribute("data-pw-item-value"):"",this.pathway.roles.push(a.value),this.roleIds.push(a.id),this.fullRoles[a.id]=a},initRolesPicker:function(){var a=this;return new Promise(function(c){var e={key:"pwManualRolesPicker_"+a.pwKey,title:[{key:"select_raters",component:"pathway_manual"}],list:{map:{cols:[{dataPath:"text",headerString:{key:"select_raters",component:"pathway_manual"}}]},service:a.endpoints.allroles},onSaved:function(b,c,d){a.updateRoles(d)}};d.adder(e).then(function(b){a.rolesPicker=b,c(b)})["catch"](function(c){b.exception({fileName:a.filename,message:c[0]+" modal: "+c[1],name:"Error loading modal list adder"})})})},pickRaters:function(){var a=this;this.rolesPicker?a.rolesPicker.show(a.roleIds):this.initRolesPicker().then(function(b){b.show(a.roleIds)})["catch"](function(c){b.exception({fileName:a.filename,message:c[0]+" modal: "+c[1],name:"Error loading modal list adder"})})},updateRoles:function(c){for(var d=this,e=this.widget.querySelector("[data-pw-roles]"),f=[],g=0;g<c.length;g++){var h=c[g];this.roleIds.indexOf(h.id)<0&&(this.pathway.roles.push(h.value),this.roleIds.push(h.id),this.fullRoles[h.id]=h,f.push(a.renderAppend("totara_competency/partial_item",h,e)))}d.showHideNoRaters(),f.length>0&&Promise.all(f).then(function(){d.triggerEvent("update",{pathway:d.pathway}),d.triggerEvent("dirty",{})})["catch"](function(a){a.fileName=d.filename,a.name="Error showing updated roles",b.exception(a)})},removeRole:function(a){a=parseInt(a);var b,c=this.roleIds.indexOf(a),d=-1;c>=0&&(this.fullRoles[a]&&(d=this.pathway.roles.indexOf(this.fullRoles[a].value),delete this.fullRoles[a]),d>=0&&this.pathway.roles.splice(d,1),this.roleIds.splice(c,1),b=this.widget.querySelector('.pw_item[data-pw-item-id="'+a+'"'),b&&(b.remove(),this.triggerEvent("update",{pathway:this.pathway}),this.triggerEvent("dirty",{}))),this.showHideNoRaters()},showHideNoRaters:function(){var a=this.widget.querySelector("[data-pw-manual-error-no-raters]");0==this.roleIds.length?a.classList.remove("tw-editAchievementPaths--hidden"):a.classList.add("tw-editAchievementPaths--hidden")},triggerEvent:function(a,b){b.key=this.pwKey;var c=new CustomEvent("totara_competency/pathway:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var f=function(a){return new Promise(function(b){var c=new e;c.setParent(a),c.events(),b(c),M.util.js_pending("pathwayManual"),c.initData().then(function(){M.util.js_complete("pathwayManual")})["catch"](function(){})})};return{init:f}});