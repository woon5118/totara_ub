define(["core/str","core/templates","core/notification","totara_competency/paging_manager","core/ajax"],function(a,b,c,d,e){function f(){return this instanceof f?(this.appendType="replace",this.counter="",this.disabledItems=[],this.disabledItemClass=".tw-list__cell_select_label_disabled",this.enabledActions=!0,this.enabledHierarchy=!0,this.eventListener="totara_core/lists",this.eventListenerNode="",this.listDataMap=[],this.listRequestArgs={direction:"asc",filters:{},order:""},this.iconList={},this.orderBy="",this.paging="",this.rowsSelector="[data-tw-list-row]",this.rowsTemplate="totara_competency/lists_rows",this.selectedItems=[],this.toggleLevel="",this.webservice="",void(this.widget="")):new f}f.prototype.onCustomAction=function(){},f.prototype.onHideSubLevelItems=function(){},f.prototype.onItemSelected=function(){},f.prototype.onItemUnselected=function(){},f.prototype.onItemUpdate=function(){},f.prototype.onListHierarchyLevelChange=function(){},f.prototype.onListHierarchyLevelChangeExtend=function(){},f.prototype.onPostRequest=function(){},f.prototype.onPreRequest=function(){},f.prototype.onShowSubLevelItems=function(){},f.prototype.propagatedListEvents=function(){var a=this;this.eventListenerNode.addEventListener(this.eventListener+":action",function(b){a.onCustomAction(b)}),this.eventListenerNode.addEventListener(this.eventListener+":add",function(b){a.onItemSelected(b.detail.val)}),this.eventListenerNode.addEventListener(this.eventListener+":remove",function(b){a.onItemUnselected(b.detail.val)}),this.eventListenerNode.addEventListener(this.eventListener+":update",function(){a.onItemUpdate()}),this.eventListenerNode.addEventListener(this.eventListener+":hierarchyRequest",function(b){a.onListHierarchyLevelChange(b),a.onListHierarchyLevelChangeExtend(b)}),this.orderBy&&(this.orderBy.addEventListener("totara_core/select_tree:add",function(b){a.setOrderBy(b.detail.val)}),this.orderBy.addEventListener("totara_core/select_tree:changed",function(){a.update()})),this.toggleLevel&&this.eventListenerNode.addEventListener("totara_core/lists_toggle_level:changed",function(b){"all"==b.detail.level?a.onShowSubLevelItems():a.onHideSubLevelItems()})},f.prototype.formatListData=function(a){var b,c,d,e,f,g=!1,h=!1,i=this.getDataMap(),j=i.cols,k=i.actions?i.actions:[],l=i.icons?i.icons:null,m=a.items,n={has_actions:!1,hierarchyEnabled:i.hasHierarchy,noResultsText:i.noResultsString&&i.noResultsString.value?i.noResultsString.value:"",rows:[],row_header:{columns:[],header:!0},select_enabled:!!i.hasCheckboxes&&i.hasCheckboxes},o=this.selectedItems,p=this.disabledItems,q=this;return this.enabledHierarchy||(n.hierarchyEnabled=this.enabledHierarchy),c=!!i.hasExpandedView&&i.hasExpandedView,i.expandTemplate&&(n.expandTemplate=i.expandTemplate),i.expandWebservice&&(n.expandWebservice=i.expandWebservice),i.expandWebserviceArgs&&(n.expandWebserviceArgs=i.expandWebserviceArgs),o=o.map(function(a){return parseInt(a,10)}),p=p.map(function(a){return parseInt(a,10)}),new Promise(function(a){q.prepareListIcons(l).then(function(){for(var l=0;l<j.length;l++)b=j[l],n.row_header.columns.push({value:b.headerString.value,width:b.size});for(var r=!1,s=0;s<m.length;s++){if(o&&(g=o.indexOf(m[s].id)>-1),p&&(h=p.indexOf(m[s].id)>-1),i.extraRowData){d={};for(var t=0;t<i.extraRowData.length;t++){var u=i.extraRowData[t].key;d[u]=m[s][i.extraRowData[t].dataPath]}}else d="";f={active:g,columns:[],disabled:h,expandable:c,extra_data:d?JSON.stringify(d):"",has_children:parseInt(m[s].children_count),id:m[s].id,path:m[s].path},q.enabledActions&&(f.actions=q.prepareActions(k,m[s]),f.actions.length>0&&(r=!0));for(var v=0;v<j.length;v++){b=j[v],e=0===v?"":b.headerString.value;var w=null;b.columnTemplate&&(w=b.columnTemplate.template),f.columns.push({column_template:w,expand_trigger:b.expandedViewTrigger,label:e,value:m[s][b.dataPath],width:b.size})}n.rows.push(f)}n.has_actions=r,a(n)})})},f.prototype.getDataMap=function(){return this.listDataMap},f.prototype.getIconList=function(){return this.iconList},f.prototype.getRequestArgs=function(){return this.listRequestArgs},f.prototype.getRowsSelector=function(){return this.rowsSelector},f.prototype.getRowsTemplate=function(){return this.rowsTemplate},f.prototype.getWebservice=function(){return this.webservice},f.prototype.loadHeaderStrings=function(b){var c=b.cols?b.cols:[],d=b.noResultsString?b.noResultsString:"",e=[];d.value||(b.noResultsString?e.push({component:d.component,key:d.key}):e.push({component:"totara_core",key:"noitems"}));for(var f=0;f<c.length;f++){var g=c[f].headerString;g.value||e.push({component:g.component,key:g.key})}return new Promise(function(c){return e.length?void a.get_strings(e).then(function(a){d.value||(b.noResultsString={value:a[0]},a.shift());for(var e=0;e<b.cols.length;e++)b.cols[e].headerString.value||(b.cols[e].headerString.value=a[0],a.shift());c(b)}):void c(b)})},f.prototype.prepareActions=function(a,b){var d,e=this,f=[];if("function"==typeof a){if(d=a(b),d&&!Array.isArray(d))return c.exception({message:"Expected action callback to return an Array."}),[];f=d}else{if(!Array.isArray(a))return c.exception({message:"Expected either an Array of callbacks or one callback for actions setting."}),[];if(!(a.length>0))return[];for(var g=0;g<a.length;g++){if("function"!=typeof a[g])return c.exception({message:"Expected array of callbacks for actions setting."}),[];var h=a[g],i=h(b);if("object"!=typeof i)return c.exception({message:"Expected object to be returned by the action callback"}),[];f.push(i)}}d=[];for(var j=0;j<f.length;j++){var k="",l=e.getIconList(),m=f[j];m.icon&&m.icon in l&&(k=l[m.icon]),d.push({disabled:!!m.disabled&&m.disabled,event_key:m.eventKey?m.eventKey:null,hidden:!!m.hidden&&m.hidden,icon:k,name:m.name?m.name:""})}return d},f.prototype.prepareListIcons=function(b){var d=this;return new Promise(function(e){if(!b)return void e();if(!b||"function"!=typeof b)return c.exception({message:"Expected callback for the icons setting."}),void e();var f=b();if(!Array.isArray(f))return c.exception({message:"Expected icons callback to return an array."}),void e();for(var g=[],h=[],i=0;i<f.length;i++)f[i].string&&f[i].component&&(g.push({key:f[i].string,component:f[i].component}),h.push(f[i].key));g.length>0&&a.get_strings(g).then(function(a){for(var b="",c=[],g=0;g<f.length;g++){var i=h.indexOf(f[g].key);i>=0&&(b=a[i]);var j=d.renderIcon(f[g].key,f[g].name,f[g].classes,b);c.push(j)}Promise.all(c).then(function(){e()})})})},f.prototype.renderIcon=function(a,c,d,e){var f=this;return new Promise(function(g){b.renderIcon(c,e,d).done(function(b){f.iconList[a]=b,g()})})},f.prototype.renderListContent=function(a){var c=this.widget,d=this;return new Promise(function(e){d.renderListCount(a.total).then(function(){d.formatListData(a).then(function(a){if(a.expandWebservice&&c.setAttribute("data-tw-list-webservice-expand",a.expandWebservice),a.expandWebserviceArgs&&c.setAttribute("data-tw-list-webservice-expand-args",JSON.stringify(a.expandWebserviceArgs)),a.expandTemplate&&c.setAttribute("data-tw-list-template-expand",a.expandTemplate),"append"===d.appendType){var f=d.getRowsSelector(),g=c.querySelectorAll(f),h=g[g.length-1];b.renderAppendByItem(d.getRowsTemplate(),a,c,f).then(function(){c.setAttribute("data-tw-list-selectioncheck",!0),d.paging&&d.paging.setContentChangeType("replace"),h.scrollIntoView(),e()})}else b.renderReplace(d.getRowsTemplate(),a,c).then(function(){b.runTemplateJS("");var a=c.firstElementChild;a&&a.scrollIntoView(!1),c.setAttribute("data-tw-list-selectioncheck",!0),e()})})})})},f.prototype.renderListCount=function(b){var c=this.counter;return new Promise(function(d){if(!c)return void d();var e=c.querySelector("[data-tw-list-count-num]"),f=1===b?"listitem":"listitemplural";a.get_string(f,"totara_core",b).then(function(a){e.setAttribute("data-tw-list-count-num",b),e.innerHTML=a,d()})})},f.prototype.removeItemFromList=function(a){var b=this;return new Promise(function(c){if(b.widget.setAttribute("data-tw-list-removerow",JSON.stringify(a)),b.counter){var d=parseInt(b.counter.querySelector("[data-tw-list-count-num]").innerHTML),e=parseInt(a.length);b.renderListCount(d-e).then(c)}else c()})},f.prototype.disableToggleLevel=function(){this.toggleLevel&&this.toggleLevel.setAttribute("data-tw-list-toggleLevel-disable","true")},f.prototype.resetToggleLevel=function(){this.toggleLevel&&this.toggleLevel.setAttribute("data-tw-list-toggleLevel-manual","current")},f.prototype.toggleSelectDisable=function(a){for(var b=this.widget.querySelectorAll("[data-tw-list-rowSelect"),c=0;c<b.length;c++)a?b[c].setAttribute("disabled",!0):b[c].closest(this.disabledItemClass)||b[c].removeAttribute("disabled");a?this.widget.querySelector("[data-tw-list-selectall]").setAttribute("disabled",!0):this.widget.querySelector("[data-tw-list-selectall]").removeAttribute("disabled")},f.prototype.setCounter=function(a){this.counter=a},f.prototype.setOrderBy=function(a){this.setRequestArg("order",a)},f.prototype.setParent=function(a){this.widget=a},f.prototype.setOrderByNode=function(a){this.orderBy=a},f.prototype.setEventListenerNode=function(a){this.eventListenerNode=a},f.prototype.setRequestArg=function(a,b){this.listRequestArgs[a]=b},f.prototype.setRequestArgs=function(a){"undefined"!=typeof a&&Object.assign(this.listRequestArgs,a)},f.prototype.setToggleLevelNode=function(a){this.toggleLevel=a},f.prototype.setWebservice=function(a){this.webservice=a},f.prototype.pagingEvents=function(a){var b=this;a.onChange=function(){b.update()},a.onChangeAppendType=function(a){b.appendType=a}},f.prototype.getUpdateRequestArgs=function(){var a={args:this.getRequestArgs(),callback:[this.renderListContent.bind(this)],methodname:this.getWebservice()};return this.paging&&(a=this.paging.extendRequestData(a)),a},f.prototype.update=function(){var a=this;return new Promise(function(b,c){a.onPreRequest(),e.getDataUpdate([a.getUpdateRequestArgs()]).then(function(){a.onPostRequest(),b()})["catch"](function(){a.onPostRequest(),c()})})},f.prototype.prepare=function(){var a=this;return new Promise(function(b){a.loadHeaderStrings(a.listDataMap).then(function(c){a.listDataMap=c,b()})})},f.prototype.load=function(){var a=this;return new Promise(function(b){a.prepare().then(function(){a.update().then(function(){b()})})})};var g=function(a,b){var e=a.querySelector("[data-tw-list-count]"),g=a.querySelector("[data-tw-list]"),h=a.querySelector("[data-tw-list-order]"),i=a.querySelector("[data-tw-paging]"),j=a.querySelector("[data-tw-list-toggleLevel]"),k=new f;return k.setParent(g),k.setEventListenerNode(a),i&&(k.paging=d.init(a),k.pagingEvents(k.paging)),b.map&&"object"==typeof b.map?(k.listDataMap=b.map,e&&k.setCounter(e),h&&k.setOrderByNode(h),j&&k.setToggleLevelNode(j),b.serviceArgs&&k.setRequestArgs(b.serviceArgs),k.propagatedListEvents(),k.setWebservice(b.service),k):(c.exception({message:"You need to provide a map object for the list"}),null)};return{init:g}});