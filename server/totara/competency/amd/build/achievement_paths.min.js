define(["core/templates","core/ajax","core/modal_factory","core/modal_events","core/notification","core/str","totara_competency/loader_manager"],function(a,b,c,d,e,f,g){function h(){return this instanceof h?(this.widget="",this.aggFunction="",this.aggType="",this.competencyId="",this.criteriaTypes=[],this.dirty=!1,this.draggedNode="",this.filename="achievement_paths.js",this.lastKey=0,this.loader=null,this.markedForDeletionPathways=[],this.nDeletedPaths=0,this.nPaths=0,this.pathways=[],this.singlevalShown=!1,this.busyAddPathway="",this.dropPlaceholder=document.createElement("div"),this.dropPlaceholder.className="tw-editAchievementPaths__dropPlaceholder",this.dropPlaceholder.innerText="Â ",this.endpoints={criteriaTypes:"pathway_criteria_group_get_criteria_types",pathways:"totara_competency_get_pathways",deletePathways:"totara_competency_delete_pathways",setOverallAggregation:"totara_competency_set_overall_aggregation"},void(this.handleDrop=this.handleDrop.bind(this))):new h}h.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target&&""===a.busyAddPathway)if(b.target.closest("[data-tw-editAchievementPaths-action]")){var c=b.target.closest("[data-tw-editAchievementPaths-action]").getAttribute("data-tw-editAchievementPaths-action");"apply"===c?a.applyChanges():"cancel"===c&&a.cancelChanges()}else if(b.target.closest("[data-tw-editScaleValuePaths-add")){var d=b.target.closest("[data-tw-editScaleValuePaths-add]"),e=b.target.closest("[data-tw-editScaleValuePaths-scale-id]");d&&a.showCriteriaTypeDropDown(e)}else if(b.target.closest('[data-tw-editScaleValuePaths-dropDown-level="scalevalue"]')){var f=b.target.closest('[data-tw-editScaleValuePaths-dropDown-level="scalevalue"]'),g=b.target.closest("[data-tw-editScaleValuePaths-scale-id]");a.addSingleValuePath(g,f)}else if(b.target.closest("[data-tw-editAchievementPaths-pathway-action]")){var h=b.target.closest("[data-tw-editAchievementPaths-pathway-action]").getAttribute("data-tw-editAchievementPaths-pathway-action"),i=b.target.closest("[data-tw-editAchievementPaths-pathway-key]").getAttribute("data-tw-editAchievementPaths-pathway-key");"remove"===h?a.removePathway(i,""):"undo"===h&&a.undoRemovePathway(i)}else if(b.target.closest("[data-tw-editAchievementPaths-aggregation-action]")){var j=b.target.closest("[data-tw-editAchievementPaths-aggregation-action]"),k=j.getAttribute("data-tw-editAchievementPaths-aggregation-action");if(j.classList.contains("tw-editAchievementPaths__btn-active"))return;a.widget.querySelector(".tw-editAchievementPaths__btn-active").classList.remove("tw-editAchievementPaths__btn-active"),j.classList.add("tw-editAchievementPaths__btn-active"),"edit"===k?a.disableOrdering():"move"===k&&a.enableOrdering()}}),this.widget.addEventListener("change",function(b){if(b.target&&""===a.busyAddPathway)if(b.target.closest("[data-tw-editAchievementPaths-add-pathway]")){var c=b.target.closest("[data-tw-editAchievementPaths-add-pathway]"),d=c.querySelector("option:checked");if("0"!=d.value){a.addPath(d),c.value="0";var e=document.querySelector("#add-pathway-sr-only");e.innerText=d.innerText+" "+e.dataset.ariaLiveExtraText}}else b.target.closest("[data-tw-editAchievementPaths-aggregation-change]")&&(a.setOverallAggregation(),a.dirty=!0,a.enableApplyChanges())}),this.widget.addEventListener("dragstart",function(b){b.target.hasAttribute("data-tw-editAchievementPaths-draggable")&&(a.draggedNode=b.target,setTimeout(function(){a.dropPosition=a.getDropPosition(a.draggedNode,b.clientY),a.dropPosition&&a.insertChildAtIndex(a.dropPosition.groupNode,a.dropPosition.index,a.dropPlaceholder),a.draggedNode===b.target&&(a.draggedNode.style.display="none")},0))}),this.widget.addEventListener("dragend",function(b){a.handleDrop(b),a.draggedNode.style.display="",a.draggedNode="",a.dropPlaceholder.remove()}),this.widget.addEventListener("drag",function(a){a.preventDefault()}),this.widget.addEventListener("dragover",function(b){a.draggedNode&&(a.dropPosition=a.getDropPosition(a.draggedNode,b.clientY),a.dropPosition&&a.insertChildAtIndex(a.dropPosition.groupNode,a.dropPosition.index,a.dropPlaceholder))}),window.addEventListener("beforeunload",function(b){return a.dirty?(b.preventDefault(),b.returnValue="",""):""})},bubbledEventsListener:function(){var a=this,b="totara_competency/pathway:";this.widget.addEventListener(b+"dirty",function(b){var c=b.detail.key;a.pathways[c]&&(a.pathways[c].dirty=!0),a.dirty=!0,a.enableApplyChanges()}),this.widget.addEventListener(b+"update",function(b){var c=b.detail.key,d=b.detail.pathway;a.pathways[c]||(a.pathways[c]={id:d.id||0,type:d.type||""},d.scalevalue&&(a.singlevalShown=!0,a.toggleSingleUseCriteriaTypes(!1,d.scalevalue)),a.nPaths+=1,a.showHideNoPaths()),d.type&&delete d.type,a.pathways[c].singleuse=d.singleuse||0,a.pathways[c].singleuse&&a.toggleSingleUsePathwayTypes(!1),delete d.singleuse,a.pathways[c].detail=d,a.unsetBusyAddPathway()}),this.widget.addEventListener(b+"remove",function(b){var c=b.detail.key,d=b.detail.pendingJsKey||"";a.removePathway(c,d)}),this.widget.addEventListener(b+"singleUseCriterion",function(b){var c=b.detail.used,d=b.detail.scalevalue;a.widget.setAttribute("data-tw-editAchievementPaths-criteria-singleUse",c?"1":"0"),a.toggleAllSingleUseCriteriaTypes(!c),c?a.hideAddScaleValuePaths(d):a.showAddScaleValuePaths(d)})},setParent:function(a){this.widget=a},showNotification:function(a,b,c,d){"undefined"==typeof d&&(d={}),e.clearNotifications(),f.get_string(b,c,d).done(function(b){e.addNotification({message:b,type:a}),window.scrollTo(0,0)}).fail(e.exception)},initData:function(){var a=this;return new Promise(function(b,c){a.competencyId=a.widget.getAttribute("data-tw-editAchievementPaths-competency"),a.getCriteriaTypes().then(function(){a.setOverallAggregation(),b()})["catch"](function(b){b.fileName=a.filename,b.name="Error retrieving criteria types",e.exception(b),c()})})},getNextKey:function(){return this.lastKey++,"pw_new_"+this.lastKey},updatePage:function(){var c=this,d="totara_competency/achievement_paths_group",f=this.widget.querySelector("[data-tw-editAchievementPaths-groups]"),g={args:{competency_id:c.competencyId},methodname:c.endpoints.pathways};return new Promise(function(h,i){b.getData(g).then(function(b){var g=b.results;c.pathways=[],c.nPaths=0,a.renderReplace(d,{criteria_types:c.criteriaTypes,pathway_groups:g},f).then(function(){c.singlevalShown=c.hasSingleValuePaths(),c.showHideNoPaths(),h()})["catch"](function(a){a.fileName=c.filename,a.name="Error updating pathways",e.exception(a),i()})})["catch"](function(a){a.fileName=c.filename,a.name="Error retrieving pathways",e.exception(a),i()})})},addPath:function(b){var c=b.value,d=b.text,f="";if(""===this.busyAddPathway&&(b.hasAttribute("data-tw-editAchievementPaths-path-template")&&(f=b.getAttribute("data-tw-editAchievementPaths-path-template")),"0"!=c)){if("singlevalue"===c)return this.singlevalShown=!0,void this.showHideNoPaths();this.setBusyAddPathway(c);var g,h,i=this,j=i.getNextKey(),k="totara_competency/partial_pathway";h={key:j,id:0,type:c,title:d,sortorder:0,pathway_templatename:f},this.pathways[j]=h,this.nPaths+=1,g=i.singlevalShown?i.widget.querySelector('[data-tw-editAchievementPaths-group="high-sortorder"]'):i.widget.querySelector('[data-tw-editAchievementPaths-group="low-sortorder"]'),a.renderAppend(k,this.pathways[j],g).then(function(){i.calculateSortOrderFromDisplay(),i.dirty=!0,i.showHideNoPaths(),i.enableApplyChanges(),a.runTemplateJS("")})["catch"](function(a){a.fileName=i.filename,a.name="Error displaying "+c,e.exception(a)})}},hideCriteriaTypeSelectors:function(){for(var a=this.widget.querySelectorAll("[data-tw-editScaleValuePaths-dropDown]"),b=0;b<a.length;b++)a[b].classList.add("tw-editAchievementPaths--hidden");for(var c=document.querySelectorAll("[data-tw-editscalevaluepaths-add]"),b=0;b<c.length;b++)c[b].setAttribute("aria-expanded","false")},showCriteriaTypeDropDown:function(a){var b=a.querySelector('[data-tw-editScaleValuePaths-dropDown="scalevalue"]'),c=!b.classList.contains("tw-editAchievementPaths--hidden"),d=a.querySelector("[data-tw-editscalevaluepaths-add]");this.hideCriteriaTypeSelectors(),b&&!c&&(b.classList.remove("tw-editAchievementPaths--hidden"),d&&d.setAttribute("aria-expanded","true"))},addSingleValuePath:function(b,c){var d,f,g,h,i=this,j="criteria_group",k=b,l=parseInt(k.getAttribute("data-tw-editScaleValuePaths-pathway-list")),m="totara_competency/partial_pathway",n=c.getAttribute("data-tw-editScaleValuePaths-dropDown-item-type"),o=b.getAttribute("data-tw-editScaleValuePaths-scale-id");""===this.busyAddPathway&&(i.setBusyAddPathway("criteria_group"),d=this.getNextKey(),g=d+"_criterion_1",h=this.criteriaTypes.find(function(a){return a.type===n}),h.key=g,h.expandable=!h.singleuse,f={key:d,type:j,scalevalue:o,sortorder:0,pathway_templatename:"pathway_criteria_group/pathway_criteria_group_edit",criteria_type_level:j,criteria_types:this.criteriaTypes,criteria:[h],showor:l>0},this.pathways[d]=f,this.nPaths+=1,a.renderAppend(m,f,k).then(function(){k.setAttribute("data-tw-editScaleValuePaths-pathway-list",l+1),i.hideCriteriaTypeSelectors(),i.toggleSingleUseCriteriaTypes(!1,o),i.calculateSortOrderFromDisplay(),i.dirty=!0,i.enableApplyChanges(),a.runTemplateJS("")})["catch"](function(a){a.fileName=i.filename,a.name="Error displaying "+j,e.exception(a)}))},applyChanges:function(){var a,c,d,f,g,h=this,i=this.widget.querySelectorAll("[data-tw-editAchievementPaths-save-endPoint]"),j=[];if(this.dirty){M.util.js_pending("competencyAchievementPathsApplyChanges"),this.loader.show(),this.disableOrdering(),this.dirty=!1,this.disableApplyChanges();for(var k=Math.round(Date.now()/1e3),l=0;l<i.length;l++)a=i[l].getAttribute("data-tw-editAchievementPaths-save-endPoint"),c=i[l].getAttribute("data-tw-editAchievementPaths-save-req-sortOrder"),d=i[l].closest("[data-tw-editAchievementPaths-pathway-key]").getAttribute("data-tw-editAchievementPaths-pathway-key"),this.pathways[d]&&this.pathways[d].dirty&&this.pathways[d].detail&&(g={args:this.pathways[d].detail,methodname:a},g.args.actiontime=k,c&&(f=i[l].closest("[data-tw-editAchievementPaths-pathway-sortOrder]"),f&&(g.args.sortorder=f.getAttribute("data-tw-editAchievementPaths-pathway-sortOrder"))),j.push(b.getData(g)));if(this.nDeletedPaths>0){var m=[];for(d in this.markedForDeletionPathways)m.push({type:this.markedForDeletionPathways[d].type,id:this.markedForDeletionPathways[d].id});g={args:{competency_id:this.competencyId,pathways:m,actiontime:k},methodname:this.endpoints.deletePathways},j.push(b.getData(g))}g={args:{competency_id:this.competencyId,type:this.aggType,actiontime:k},methodname:this.endpoints.setOverallAggregation},j.push(b.getData(g)),j.length>0&&Promise.all(j).then(function(){h.updatePage().then(function(){h.showNotification("success","apply_success","totara_competency",{}),h.loader.hide(),M.util.js_complete("competencyAchievementPathsApplyChanges")})["catch"](function(a){a.fileName=h.filename,a.name="Error updating the page",e.exception(a),h.loader.hide(),M.util.js_complete("competencyAchievementPathsApplyChanges")})})["catch"](function(a){h.dirty=!0,h.enableApplyChanges(),a.fileName=h.filename,a.name="Error applying changes",e.exception(a),h.loader.hide(),M.util.js_complete("competencyAchievementPathsApplyChanges")})}},showHideNoPaths:function(){var a=this.widget.querySelector("[data-tw-editAchievementPaths-aggregation]"),b=this.widget.querySelector("[data-tw-editAchievementPaths-empty]"),c=this.widget.querySelector('[data-tw-editAchievementPaths-group="singlevalue"]'),d=this.widget.querySelector('[data-tw-editAchievementPaths-add-pathway] option[value="singlevalue"]');0!=this.nPaths||this.singlevalShown?(a&&a.classList.remove("tw-editAchievementPaths--hidden"),b&&b.classList.add("tw-editAchievementPaths--hidden")):(a&&a.classList.add("tw-editAchievementPaths--hidden"),b&&b.classList.remove("tw-editAchievementPaths--hidden")),this.singlevalShown?(c&&c.classList.remove("tw-editAchievementPaths--hidden"),d&&(d.disabled=!0)):(c&&c.classList.add("tw-editAchievementPaths--hidden"),d&&(d.disabled=!1))},calculateSortOrderFromDisplay:function(){for(var a,b,c=this.widget.querySelectorAll("[data-tw-editAchievementPaths-pathway-key]"),d=0,e=0;e<c.length;e++)a=c[e].getAttribute("data-tw-editAchievementPaths-pathway-key"),this.pathways[a]?b=this.pathways[a]:this.markedForDeletionPathways[a]&&(b=this.markedForDeletionPathways[a]),b.sortorder!=d+1&&(this.pathways[a]?this.pathways[a].dirty=!0:this.markedForDeletionPathways[a]&&(this.markedForDeletionPathways[a].dirty=!0)),b.sortorder=++d,c[e].setAttribute("data-tw-editAchievementPaths-pathway-sortOrder",b.sortorder)},cancelChanges:function(){var a=this.widget.getAttribute("data-tw-editAchievementPaths-back-url");a&&(window.location.href=a)},removePathway:function(a,b){var c=this.widget.querySelector('[data-tw-editAchievementPaths-pathway-key="'+a+'"]');if(e.clearNotifications(),this.pathways[a])if(this.dirty=!0,this.enableApplyChanges(),this.pathways[a].singleuse&&this.toggleSingleUsePathwayTypes(!0),this.pathways[a].id&&0!=this.pathways[a].id){var d={};d[a]=this.pathways[a],Object.assign(this.markedForDeletionPathways,d),this.nDeletedPaths+=1,delete this.pathways[a];for(var f,g=c.querySelectorAll("[data-pw-on-delete]"),h=0;h<g.length;h++)f=g[h].getAttribute("data-pw-on-delete"),"mark"==f?g[h].classList.add("tw-editAchievementPaths--deleted"):"hide"==f&&g[h].classList.add("tw-editAchievementPaths--hidden");var i=c.querySelector('[data-tw-editAchievementPaths-pathway-action="remove"]'),j=c.querySelector('[data-tw-editAchievementPaths-pathway-action="undo"]');i.classList.add("tw-editAchievementPaths--hidden"),j.classList.remove("tw-editAchievementPaths--hidden")}else{if(this.pathways[a].scalevalue){var k=this.widget.querySelector('[data-tw-editScaleValuePaths-scale-id="'+this.pathways[a].scalevalue+'"]'),l=this.widget.querySelector('[data-pw-or="'+a+'"]'),m=k,n=parseInt(m.getAttribute("data-tw-editScaleValuePaths-pathway-list"));if(l)l.remove();else{var o=k.querySelectorAll("[data-pw-or]");o.length>0&&o[0].remove()}if(n-=1,m.setAttribute("data-tw-editScaleValuePaths-pathway-list",n),0==n){var p=this.hasSingleUseCriteria();p||this.toggleSingleUseCriteriaTypes(!0,this.pathways[a].scalevalue)}}delete this.pathways[a],this.nPaths-=1,this.showHideNoPaths(),c&&c.remove()}""!==b&&M.util.js_complete(b)},undoRemovePathway:function(a){var b=this.widget.querySelector('[data-tw-editAchievementPaths-pathway-key="'+a+'"]'),c={};if(this.markedForDeletionPathways[a]){if(e.clearNotifications(),this.markedForDeletionPathways[a].singleuse){var d=this.widget.querySelectorAll('[data-tw-editAchievementPaths-singleUse-pathway="1"]');if(d.length>1)return f.get_string("error_cant_undo_single_use","totara_competency").done(function(a){e.addNotification({message:a,type:"error"}),window.scrollTo(0,0)}).fail(e.exception),!1;this.toggleSingleUsePathwayTypes(!1)}c[a]=this.markedForDeletionPathways[a],Object.assign(this.pathways,c),delete this.markedForDeletionPathways[a],this.nDeletedPaths-=1;for(var g,h=b.querySelectorAll("[data-pw-on-delete]"),i=0;i<h.length;i++)g=h[i].getAttribute("data-pw-on-delete"),"mark"==g?h[i].classList.remove("tw-editAchievementPaths--deleted"):"hide"==g&&h[i].classList.remove("tw-editAchievementPaths--hidden");var j=b.querySelector('[data-tw-editAchievementPaths-pathway-action="remove"]'),k=b.querySelector('[data-tw-editAchievementPaths-pathway-action="undo"]');j.classList.remove("tw-editAchievementPaths--hidden"),k.classList.add("tw-editAchievementPaths--hidden")}},getCriteriaTypes:function(){var a=this,c=this.hasSingleUseCriteria();return new Promise(function(d,f){if(a.criteriaTypes&&a.criteriaTypes.length>0)d();else{var g={args:{},methodname:a.endpoints.criteriaTypes};b.getData(g).then(function(b){var e=b.results;a.criteriaTypes=[];for(var f=0;f<e.length;f++)e[f].disabled=!!+e[f].singleuse&&c,a.criteriaTypes.push(e[f]);d()})["catch"](function(b){b.fileName=a.filename,b.name="Error getting criteria types",e.exception(b),f()})}})},toggleSingleUsePathwayTypes:function(a){var b,c=this.widget.querySelector("[data-tw-editAchievementPaths-add-pathway]");if(c&&(b=c.querySelectorAll('[data-tw-editachievementpaths-path-singleUse="1"]')),b)if(a)for(var d=0;d<b.length;d++)b[d].removeAttribute("disabled");else for(var e=0;e<b.length;e++)b[e].setAttribute("disabled","")},toggleAllSingleUseCriteriaTypes:function(a){for(var b,c,d,e,f=this.widget.querySelectorAll('[data-tw-editScaleValuePaths-dropDown="scalevalue"]'),g=0;g<f.length;g++)if(b=f[g].closest("[data-tw-editScaleValuePaths-scale-id]"),c=null,e=0,d=f[g].querySelectorAll('[data-tw-editScaleValuePaths-dropDown-item-singleUse="1"]'),b&&(c=b.getAttribute("data-tw-editScaleValuePaths-scale-id"),e=parseInt(b.getAttribute("data-tw-editscalevaluepaths-pathway-list")||"0")),c&&d.length&&!(e>0))if(a)for(var h=0;h<d.length;h++)d[h].removeAttribute("disabled");else for(var i=0;i<d.length;i++)d[i].setAttribute("disabled","")},toggleSingleUseCriteriaTypes:function(a,b){var c,d,e=this.widget.querySelector('[data-tw-editScaleValuePaths-scale-id="'+b+'"]');if(e&&(c=e.querySelector('[data-tw-editScaleValuePaths-dropDown="scalevalue"]')),c&&(d=c.querySelectorAll('[data-tw-editScaleValuePaths-dropDown-item-singleUse="1"]')))if(a)for(var f=0;f<d.length;f++)d[f].removeAttribute("disabled");else for(var g=0;g<d.length;g++)d[g].setAttribute("disabled","")},hideAddScaleValuePaths:function(a){var b,c=this.widget.querySelector('[data-tw-editScaleValuePaths-scale-id="'+a+'"]');c&&(b=c.querySelector("[data-tw-editScaleValuePaths-add]")),b&&b.classList.add("tw-editAchievementPaths--hidden")},showAddScaleValuePaths:function(a){var b,c=this.widget.querySelector('[data-tw-editScaleValuePaths-scale-id="'+a+'"]');c&&(b=c.querySelector("[data-tw-editScaleValuePaths-add]")),b&&b.classList.remove("tw-editAchievementPaths--hidden")},setOverallAggregation:function(){var a=this.widget.querySelector("[data-tw-editAchievementPaths-aggregation-change]"),b=a.querySelector("option:checked"),c=this.widget.querySelector("[data-tw-editAchievementPaths-aggregation-actions]");this.aggType=b.value,b.hasAttribute("data-tw-editAchievementPaths-aggregation-function")?(this.aggFunction=b.getAttribute("data-tw-editAchievementPaths-aggregation-function"),c&&c.classList.remove("tw-editAchievementPaths--hidden")):(this.aggFunction="",c&&c.classList.add("tw-editAchievementPaths--hidden"))},enableOrdering:function(){for(var a,b=this.widget.querySelectorAll("[data-tw-editAchievementPaths-draggable]"),c=this.widget.querySelectorAll("[data-tw-editAchievementPaths-on-ordering]"),d=0;d<b.length;d++)b[d].classList.add("tw-editAchievementPaths__activeDropZone"),b[d].draggable=!0;for(var e=0;e<c.length;e++)a=c[e].getAttribute("data-tw-editAchievementPaths-on-ordering"),"hide"==a?c[e].classList.add("tw-editAchievementPaths--hidden"):"show"==a?c[e].classList.remove("tw-editAchievementPaths--hidden"):"disable"==a&&(c[e].disabled=!0)},disableOrdering:function(){this.widget.querySelector(".tw-editAchievementPaths__btn-active").classList.remove("tw-editAchievementPaths__btn-active"),this.widget.querySelector(".tw-editAchievementPaths__btn[data-tw-editachievementpaths-aggregation-action=edit]").classList.add("tw-editAchievementPaths__btn-active");for(var a,b=this.widget.querySelectorAll("[data-tw-editAchievementPaths-draggable]"),c=this.widget.querySelectorAll("[data-tw-editAchievementPaths-on-ordering]"),d=0;d<b.length;d++)b[d].classList.remove("tw-editAchievementPaths__activeDropZone"),b[d].draggable=!1;for(var e=0;e<c.length;e++)a=c[e].getAttribute("data-tw-editAchievementPaths-on-ordering"),"hide"==a?c[e].classList.remove("tw-editAchievementPaths--hidden"):"show"==a?c[e].classList.add("tw-editAchievementPaths--hidden"):"disable"==a&&(c[e].disabled=!1);this.aggFunction&&"function"==typeof this[this.aggFunction]&&this[this.aggFunction]()},hasSingleValuePaths:function(){return!!this.widget.querySelectorAll(".tw-editScaleValuePathsGroup").length},hasSingleUseCriteria:function(){var a=this.widget.getAttribute("[data-tw-editAchievementPaths-criteria-singleUse]")||0;return!!+a},enableApplyChanges:function(){var a=this.widget.querySelector('[data-tw-editAchievementPaths-action="apply"]');a&&this.dirty&&a.removeAttribute("disabled")},disableApplyChanges:function(){var a=this.widget.querySelector('[data-tw-editAchievementPaths-action="apply"]');a&&a.setAttribute("disabled","")},getDropPosition:function(a,b){if(!b)return null;var c=this.widget.querySelector('[data-tw-editAchievementPaths-group="high-sortorder"]'),d=this.widget.querySelector('[data-tw-editAchievementPaths-group="low-sortorder"]'),e=Array.prototype.slice.call(this.widget.querySelectorAll(".tw-editAchievementPaths__activeDropZone")),f={groupNode:d,index:0};return e.forEach(function(a){var d=a.getBoundingClientRect();if(0!==d.height){var e=d.top+d.height/2;if(b>e){var g=a.closest("[data-tw-editAchievementPaths-group]"),h=g.getAttribute("data-tw-editAchievementPaths-group");if("singlevalue"===h)return void(f={groupNode:c,index:0});var i=Array.prototype.slice.call(g.children),j=i.indexOf(a);f={groupNode:g,index:j+1}}}}),f},insertChildAtIndex:function(a,b,c){a.children[b]?a.insertBefore(c,a.children[b]):a.appendChild(c)},handleDrop:function(a){var b=this;a.preventDefault(),a.stopPropagation();var c=this.draggedNode&&(this.dropPosition||this.getDropPosition(this.draggedNode,a.clientY));if(this.draggedNode&&c){var d=c.groupNode.getAttribute("data-tw-editAchievementPaths-group"),e=this.draggedNode.closest("[data-tw-editAchievementPaths-group]").getAttribute("data-tw-editAchievementPaths-group"),f=this.widget.querySelector('[data-tw-editAchievementPaths-group="high-sortorder"]'),g=this.widget.querySelector('[data-tw-editAchievementPaths-group="low-sortorder"]');if(this.draggedNode.style.display="","singlevalue"===e){var h=Array.prototype.slice.call(c.groupNode.children);"low-sortorder"===d?h.slice(c.index).forEach(function(a,c){b.insertChildAtIndex(f,c,a)}):"high-sortorder"===d&&h.slice(0,c.index).forEach(function(a){g.appendChild(a)})}else this.insertChildAtIndex(c.groupNode,c.index,this.draggedNode);this.dirty=!0,this.enableApplyChanges()}this.dropPlaceholder.parentNode&&this.dropPlaceholder.remove()},setBusyAddPathway:function(a){this.busyAddPathway=a,M.util.js_pending(this.busyAddPathway),this.loader.show()},unsetBusyAddPathway:function(){""!==this.busyAddPathway&&(this.loader.hide(),M.util.js_complete(this.busyAddPathway),this.busyAddPathway="")}};var i=function(a){return new Promise(function(b){var c=new h;c.setParent(a),c.events(),c.bubbledEventsListener(),c.loader=g.init(a),b(c),M.util.js_pending("competencyAchievementPaths"),c.loader.show(),c.initData().then(function(){c.loader.hide(),M.util.js_complete("competencyAchievementPaths")})["catch"](function(){})})};return{init:i}});