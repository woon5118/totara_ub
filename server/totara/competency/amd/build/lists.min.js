define(["core/notification","core/templates","core/ajax"],function(a,b,c){function d(){return this instanceof d?(this.activeRowClass="tw-list__row_active",this.hoverRowClass="tw-list__row_hover",this.disabledBtnClass="tw-list__cell_action_btn_disabled",this.expandBoxTemplate="totara_competency/lists_expanded",this.expandedClass="tw-list__expanded_show",this.expandedClassRow="tw-list__row_expanded",this.expandContainerHtml="",this.expandID="",this.expandTemplate="",this.expandWebservice="",this.expandWebserviceArgs="",this.expandTemplateAttribute="data-tw-list-template-expand",this.expandWebserviceAttribute="data-tw-list-webservice-expand",this.expandWebserviceArgsAttribute="data-tw-list-webservice-expand-args",this.removeRowData="data-tw-list-removerow",this.selectionCheckData="data-tw-list-selectioncheck",this.stateLocked=!1,void(this.widget="")):new d}d.prototype={checkSelection:function(){var a=!0,b=this.widget.querySelectorAll("[data-tw-list-rowSelect]");if(b.length){for(var c=0;c<b.length;c++)b[c].checked===!1&&(a=!1);this.widget.querySelector("[data-tw-list-selectAll]").checked=a}},events:function(){var a,b="",c=this;this.widget.addEventListener("click",function(d){if(d.target)if(d.target.closest("[data-tw-list-row]")&&(a=d.target.closest("[data-tw-list-row]"),b=parseInt(a.getAttribute("data-tw-list-row"))),d.target.closest("[data-tw-list-selectAll]")){var e=d.target.closest("[data-tw-list-selectAll]"),f=!!e.checked;c.toggleSelectAll(f)}else if(d.target.closest("[data-tw-list-expandTrigger]")){d.preventDefault();var g=a.nextElementSibling;if(c.setExpandID(b),g&&g.hasAttribute("data-tw-list-expanded")){var h=!g.classList.contains(c.expandedClass);c.hideAllExpandedViews(),h&&(g.classList.add(c.expandedClass),a.classList.add(c.expandedClassRow))}else{if(c.stateLocked)return;c.stateLocked=!0,c.hideAllExpandedViews(),c.displayExpandContainer(a),a.classList.add(c.expandedClassRow)}}else if(d.target.closest("[data-tw-list-expandedClose]"))d.preventDefault(),c.hideAllExpandedViews();else if(d.target.closest("[data-tw-list-rowselect]")){var i=d.target.closest("[data-tw-list-rowselect]").checked,j=i?"add":"remove";c.toggleRowState(a,i),c.checkSelection(),c.triggerEvent(j,{extra:c.getExtraData(a),val:b}),c.triggerEvent("update",{})}else if(d.target.closest("[data-tw-list-hierarchyTrigger]"))d.preventDefault(),c.triggerEvent("hierarchyRequest",{extra:c.getExtraData(a),key:"parent",val:b});else if(d.target.closest("[data-tw-list-actionTrigger]")){d.preventDefault();var k=d.target.closest("[data-tw-list-actionTrigger]");if(k.classList.contains(c.disabledBtnClass))return;var l=k.getAttribute("data-tw-list-actionTrigger");c.triggerEvent("action",{extra:c.getExtraData(a),key:l,val:b})}}),this.widget.addEventListener("focusin",function(a){var b=a.target.closest("[data-tw-list-row]");b&&b.classList.add(c.hoverRowClass)}),this.widget.addEventListener("focusout",function(a){var b=a.target.closest("[data-tw-list-row]");b&&b.classList.remove(c.hoverRowClass)}),document.addEventListener("click",function(a){var b=c.widget.querySelector("."+c.expandedClass);if(b&&a.target){var d=a.target.closest("[data-tw-list-expandTrigger]"),e=a.target.closest("."+c.expandedClass);d||e||c.hideAllExpandedViews()}});var d=new MutationObserver(function(){c.widget.getAttribute(c.selectionCheckData)&&(c.checkSelection(),c.widget.removeAttribute(c.selectionCheckData))});d.observe(this.widget,{attributes:!0,attributeFilter:[c.selectionCheckData],subtree:!1});var e=new MutationObserver(function(){if(c.widget.getAttribute(c.removeRowData)){for(var a=JSON.parse(c.widget.getAttribute(c.removeRowData)),b=0;b<a.length;b++)c.removeRow(a[b]);c.widget.removeAttribute(c.removeRowData)}});e.observe(this.widget,{attributes:!0,attributeFilter:[c.removeRowData],subtree:!1});var f=new MutationObserver(function(a){for(var b=0;b<a.length;b++){var d=a[b].attributeName,e=a[b].target.getAttribute(d);switch(d){case c.expandTemplateAttribute:c.expandTemplate=e;break;case c.expandWebserviceAttribute:c.expandWebservice=e;break;case c.expandWebserviceArgsAttribute:c.expandWebserviceArgs=e}}});f.observe(this.widget,{attributes:!0,attributeFilter:[this.expandTemplateAttribute,this.expandWebserviceAttribute,this.expandWebserviceArgsAttribute],subtree:!1})},displayExpandContainer:function(c){var d=this,e=new Promise(function(c,e){return d.expandContainerHtml?void c():void b.render(d.expandBoxTemplate).done(function(a){d.expandContainerHtml=a,c()}).fail(function(b){a.exception(b),e()})});e.then(function(){c.insertAdjacentHTML("afterend",d.expandContainerHtml);var a=c.nextElementSibling,b=a.querySelector("[data-tw-list-expandedtarget]");a.classList.add(d.expandedClass),d.getExpandedViewContent(b)})},getExpandedViewContent:function(a){var d,e="",f=this;this.expandWebservice?(this.expandWebserviceArgs?(e=JSON.parse(this.expandWebserviceArgs),e.id=this.expandID):e={id:this.expandID},d=c.getData({args:e,methodname:this.expandWebservice})):d=Promise.resolve(!1),d.then(function(c){b.renderReplace(f.expandTemplate,c.results,a).then(function(){b.runTemplateJS(""),f.stateLocked=!1})})["catch"](function(){f.stateLocked=!1})},getExtraData:function(a){var b=a.getAttribute("data-tw-list-extraData");return b&&(b=JSON.parse(b)),b},hideAllExpandedViews:function(){for(var a=this.widget.querySelectorAll("."+this.expandedClass),b=this.widget.querySelectorAll("."+this.expandedClassRow),c=0;c<a.length;c++)a[c].classList.remove(this.expandedClass);for(var d=0;d<b.length;d++)b[d].classList.remove(this.expandedClassRow)},removeRow:function(a){var b=this.widget.querySelector('[data-tw-list-row="'+a+'"]');b.remove()},setExpandID:function(a){this.expandID=a},setExpandTemplate:function(){this.expandTemplate=this.widget.getAttribute(this.expandTemplateAttribute),this.expandWebservice=this.widget.getAttribute(this.expandWebserviceAttribute),this.expandWebserviceArgs=this.widget.getAttribute(this.expandWebserviceArgsAttribute)},setParent:function(a){this.widget=a},toggleRowState:function(a,b){b?(a.classList.add(this.activeRowClass),a.setAttribute("aria-selected",!0)):(a.classList.remove(this.activeRowClass),a.setAttribute("aria-selected",!1))},toggleSelectAll:function(a){for(var b,c=this.widget.querySelectorAll("[data-tw-list-rowSelect]:not([disabled])"),d=a?"add":"remove",e=!1,f="",g="",h=0;h<c.length;h++)f=c[h].closest("[data-tw-list-row]"),b=c[h].checked!==a,c[h].checked=a,this.toggleRowState(f,a),b&&(g=parseInt(f.getAttribute("data-tw-list-row")),e=!0,this.triggerEvent(d,{key:"ID",val:g}));e&&this.triggerEvent("update",{})},triggerEvent:function(a,b){var c=new CustomEvent("totara_core/lists:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var e=function(a){return new Promise(function(b){var c=new d;c.setParent(a),c.setExpandTemplate(),c.events(),c.checkSelection(),b(c)})};return{init:e}});