define(["core/str","core/modal_factory","core/modal_events","totara_competency/basket_list","core/ajax","core/notification","core/templates"],function(a,b,c,d,e,f,g){function h(){return this instanceof h?void(this.actionModals={}):new h}h.prototype=new d,h.prototype.customBubbledEventsListener=function(){var a=this;this.listParent.addEventListener(this.basketManager.getEventListener()+":customUpdate",function(b){var c="",d=b.detail.action,e="";switch(d){case"bulkActivate":c="activate";break;case"bulkDelete":c="delete";break;case"bulkArchive":c="archive",e="totara_competency/archive_bulk_modal"}var f=c+"_bulk",g=function(b){var d=a.getExtraDataForArchive(b);a.triggerBulkActionAndUpdatePage(c,d)};a.showConfirmationModal(f,g,e)})},h.prototype.customListEvents=function(){var a=this.list,b=this;a.onCustomAction=function(a){var c=null,d=a.detail.key,e=a.detail.val,f=a.detail.extra,g=null,h="";switch(d){case"activateClicked":c=g="activate","user"===f.user_group_type&&(g+="_individual");break;case"deleteClicked":c=g="delete",g=2==f.status?"delete_archived":"delete_draft","user"===f.user_group_type&&(g+="_individual");break;case"archiveClicked":c=g="archive",h="totara_competency/archive_modal","user"!==f.user_group_type&&(h="totara_competency/archive_modal_group",g+="_group")}var i=function(a){var d=b.getExtraDataForArchive(a);b.triggerActionAndUpdatePage(c,e,d)};b.showConfirmationModal(g,i,h)}},h.prototype.showConfirmationModal=function(c,d,e){var f=null,h=this,i=[{key:"action_"+c+"_modal_header",component:"totara_competency"}];h.loader&&h.loader.show(),""!==e?f=g.render(e,[]):i.push({key:"action_"+c+"_modal",component:"totara_competency"}),a.get_strings(i).then(function(a){var e=a[0],g=null!==f?f:a[1];h.actionModals[c]||(h.actionModals[c]=null);var i=h.actionModals[c];i?h.displayModal(i,d):b.create({body:g,title:e,type:b.types.CONFIRM}).done(function(a){h.actionModals[c]=a,h.displayModal(a,d)})})},h.prototype.displayModal=function(a,b){var d=a.getRoot(),e=this;d.off(c.yes),d.on(c.yes,b),d.on(c.shown,function(a){var b=a.target.querySelector("[data-tw-assigncomp-archive-modal-confirm]");b&&(b.checked=!1),e.loader&&e.loader.hide()}),a.show()},h.prototype.getExtraDataForArchive=function(a){var b=a.target.querySelector("[data-tw-assigncomp-archive-modal-confirm]"),c=!!b&&b.checked;return{continue_tracking:c}},h.prototype.triggerActionAndUpdatePage=function(a,b,c){"undefined"==typeof c&&(c={});var d=this;d.loader.show(),e.getData(this.triggerAction(a,null,b,c)).then(function(c){d.showActionConfirmation(a,c.results),"delete"===a?(d.list.removeItemFromList([b]),d.loader.show(),d.basketManager.queueRemove(b).updateAndRender().then(function(){d.loader.hide()})):d.list.update()})},h.prototype.triggerBulkActionAndUpdatePage=function(a,b){"undefined"==typeof b&&(b={});var c=this;c.loader.show(),c.basketManager.load().then(function(d){e.getData(c.triggerAction(a,c.basketManager.getBasketKey(),null,b)).then(function(b){c.showBulkActionConfirmation(a,b.results,d),c.loader.show(),c.basketManager.deleteAndRender().then(function(){c.updatePage([c.list.getUpdateRequestArgs()])})})})},h.prototype.showActionConfirmation=function(a,b){var c={affected:b.length},d=b.length>0?"success":"error";this.showNotification(d,"action_confirm_"+a+"_"+d,"totara_competency",c)},h.prototype.showBulkActionConfirmation=function(a,b,c){var d=c.length-b.length,e={affected:b.length,expected:c.length,skipped:d},f=b.length>0?"success":"warning",g="action_confirm_"+a+"_bulk";d>0&&(g+="_skipped"),this.showNotification(f,g,"totara_competency",e)},h.prototype.showNotification=function(b,c,d,e){"undefined"==typeof e&&(e={}),f.clearNotifications(),a.get_string(c,d,e).done(function(a){f.addNotification({message:a,type:b}),window.scrollTo(0,0)}).fail(f.exception)},h.prototype.triggerAction=function(a,b,c,d){return"undefined"==typeof d&&(d={}),{args:{action:a,basket:b,id:c,extra:d},callback:[],methodname:"totara_competency_assignment_action"}},h.prototype.actionsCallback=function(a){var b=[],c=parseInt(a.status);return 1!==c&&b.push({name:"delete",icon:"delete",eventKey:"deleteClicked",disabled:!1,hidden:!1}),1===c&&b.push({name:"archive",icon:"archive",eventKey:"archiveClicked",disabled:!1,hidden:!1}),0===c&&b.push({name:"activate",icon:"activate",eventKey:"activateClicked",disabled:!1,hidden:!1}),b},h.prototype.iconsCallback=function(){return[{key:"delete",name:"remove",string:"action_delete",component:"totara_competency",classes:"tw-list__hover_warning"},{key:"activate",name:"activate",string:"action_activate",component:"totara_competency"},{key:"archive",name:"archive",string:"action_archive",component:"totara_competency"}]},h.prototype.initExtend=function(){this.customListEvents(),this.customBubbledEventsListener()};var i=function(a){return{actions:a.actionsCallback,cols:[{dataPath:"competency_name",headerString:{component:"totara_competency",key:"header_competency"}},{dataPath:"assignment_type_name",headerString:{component:"totara_competency",key:"header_assignment_type"}},{dataPath:"user_group_name",headerString:{component:"totara_competency",key:"assigned_type_detail"}},{dataPath:"status_name",headerString:{component:"totara_competency",key:"header_status"},size:"sm"}],extraRowData:[{key:"status",dataPath:"status"},{key:"user_group_type",dataPath:"user_group_type"}],hasHierarchy:!1,icons:a.iconsCallback}},j=function(a){return new Promise(function(b){var c=new h,d={basketKey:"totara_competency_manage_assignment",basketType:"session",list:{map:i(c),service:"totara_competency_assignment_index"},parent:a};c.init(d).then(function(){b(c)})})};return{init:j}});