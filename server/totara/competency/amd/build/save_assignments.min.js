define(["core/str","core/templates","totara_competency/modal_list","totara_competency/list_framework_hierarchy_events","core/ajax","core/notification","totara_competency/loader_manager","core/modal_factory","totara_competency/session_basket"],function(a,b,c,d,e,f,g,h,i){function j(){return this instanceof j?(this.basketKeys={audiences:null,competencies:null,organisations:null,positions:null,users:null},this.baskets={audiences:null,competencies:null,organisations:null,positions:null,users:null},this.counts=null,this.competenciesCount=null,this.disabledBtnClass="tw-assignComp__btn_disabled",this.disabledViewerClass="tw-assignCompSave__disabled",this.hideClass="tw-assignCompSave__hidden",this.manageAssignmentsUrl=null,this.modalsData={audiences:"",organisations:"",positions:"",users:""},this.modalLists={},this.removingElement=!1,this.selectedModal=null,this.services={updateBasket:"totara_core_basket_update",createAssignments:"totara_competency_assignment_create_from_baskets",users:"totara_competency_user_index",audiences:"totara_competency_cohort_index",organisations:"hierarchy_organisation_index",positions:"hierarchy_position_index"},this.strings={},this.widget="",void(this.saveConfirmationModal=null)):new j}j.prototype.propagatedEvents=function(){var a=this.widget.querySelector("[data-tw-assignCompSave-tree]"),b=this;this.widget.addEventListener("click",function(a){if(a.target.closest("[data-tw-assignCompSave-remove-selected-group]")){a.preventDefault();var c=a.target.closest("[data-tw-assignCompSave-selected-row-id]");c&&b.removeSelectedGroup(c)}else if(a.target.closest("[data-tw-assignCompSave-browse-individuals]")){if(a.preventDefault(),a.target.closest("."+b.disabledViewerClass))return;b.modalLists.individual.show()}else a.target.closest("[data-tw-assignCompSave-save]")&&(a.preventDefault(),b.showSaveModal(a))}),a&&(a.addEventListener("totara_core/select_tree:add",function(a){b.selectedModal=a.detail.val}),a.addEventListener("totara_core/select_tree:changed",function(){var a=b.modalLists[b.selectedModal];a.show()}))},j.prototype.showSaveModal=function(){var c=this.getTotalCount(),d=this;c<1||a.get_string("save_modal_body","totara_competency",c*this.competenciesCount).then(function(a){var c={count_string:a};d.saveConfirmationModal?b.render("totara_competency/save_modal",c).then(function(a){d.saveConfirmationModal.setBody(a),d.saveConfirmationModal.show()}):h.create({body:b.render("totara_competency/save_modal",c),title:d.strings.confirmationHeader,type:h.types.CONFIRM}).done(function(a){d.saveConfirmationModal=a;var b=a.getRoot();b.on("modal-confirm:yes",function(a){var b=a.target.querySelector("[data-tw-assigncomp-save-modal-checkbox]").checked;d.createAssignments(b)}),b.on("modal:shown",function(a){var b=a.target.querySelector("[data-tw-assigncomp-save-modal-checkbox]");b&&(b.checked=!1)}),a.show()})})},j.prototype.initVariables=function(){var a=this.widget.dataset;this.manageAssignmentsUrl=this.widget.querySelector("[data-tw-assignCompSave-backBtn]").getAttribute("href"),this.competenciesCount=parseInt(a.competenciesCount),this.basketKeys={audiences:a.basketAudiences,competencies:a.basketCompetencies,organisations:a.basketOrganisations,positions:a.basketPositions,users:a.basketUsers},this.baskets={audiences:new i(this.basketKeys.audiences),competencies:new i(this.basketKeys.competencies),organisations:new i(this.basketKeys.organisations),positions:new i(this.basketKeys.positions),users:new i(this.basketKeys.users)},this.counts={audiences:parseInt(a.basketAudiencesCount),organisations:parseInt(a.basketOrganisationsCount),positions:parseInt(a.basketPositionsCount),users:parseInt(a.basketUsersCount)}},j.prototype.disableOverviewActions=function(){var a=this.widget.querySelector("[data-tw-assignCompSave-save]"),b=this.widget.querySelector("[data-tw-assignCompSave-browse-individuals]");a.classList.add(this.disabledBtnClass),b.classList.add(this.disabledViewerClass),a.setAttribute("aria-disabled",!0),b.setAttribute("aria-disabled",!0)},j.prototype.enableOverviewActions=function(){var a=this.widget.querySelector("[data-tw-assignCompSave-save]"),b=this.widget.querySelector("[data-tw-assignCompSave-browse-individuals]");a.classList.remove(this.disabledBtnClass),b.classList.remove(this.disabledViewerClass),a.setAttribute("aria-disabled",!1),b.setAttribute("aria-disabled",!1)},j.prototype.getTotalCount=function(){var a=0;for(var b in this.counts)this.counts.hasOwnProperty(b)&&(a+=parseInt(this.counts[b]));return a},j.prototype.createAssignments=function(a){var b=this;e.getData({args:{basket:b.basketKeys.competencies,status:a?1:0,usergroups:{cohort:b.basketKeys.audiences,organisation:b.basketKeys.organisations,position:b.basketKeys.positions,user:b.basketKeys.users}},methodname:b.services.createAssignments}).then(function(a){a.results&&0===a.results.length?window.location.reload():window.location.replace(b.manageAssignmentsUrl)})["catch"](function(){window.location.reload()})},j.prototype.setTypeCount=function(a,b){b&&(this.counts[a]=b.length?b.length:0)},j.prototype.updateTotalCount=function(){var a=this.getTotalCount(),b=this.widget.querySelector("[data-tw-assignCompSave-selected-empty]"),c=this.widget.querySelector("[data-tw-assignCompSave-selected-group-count]");c.innerHTML=a,a<1?(b.classList.remove(this.hideClass),this.disableOverviewActions()):(b.classList.add(this.hideClass),this.enableOverviewActions())},j.prototype.resetTreeList=function(){var a=this.widget.querySelector("[data-tw-assignCompSave-tree] [data-tw-selectorgroup]");a.setAttribute("data-tw-selectorgroup-clear",!0)},j.prototype.renderItems=function(a,c){var d=this.widget.querySelector('[data-tw-assignCompSave-selected-group="'+a+'"]'),e=this;return new Promise(function(f){return d?void b.render("totara_competency/save_selected_user_group_body",{basket:e.basketKeys[a],items:c,title:e.strings[a],type:a}).then(function(b){d.innerHTML=b,e.setTypeCount(a,c),e.updateTotalCount(),f()}):void f()})},j.prototype.removeSelectedGroup=function(a){if(!this.removingElement){this.removingElement=!0;var b,c=a.getAttribute("data-tw-assignCompSave-selected-row-id"),d=a.closest("[data-tw-assignCompSave-selected-group]"),e=this,f=a.getAttribute("data-tw-assignCompSave-selected-row-type");this.baskets[f].remove(c).then(function(){a.remove(),b=d.querySelectorAll("[data-tw-assignCompSave-selected-row-id]"),e.setTypeCount(f,b),e.updateTotalCount(),b.length||d.firstElementChild.classList.add(e.hideClass),e.removingElement=!1})["catch"](function(){e.removingElement=!1})}},j.prototype.getUserModalConfig=function(){var a=this;return new Promise(function(b){var c={externalBasket:a.baskets.users,key:"users",list:{map:{cols:[{dataPath:"display_name",headerString:{key:"fullnameuser",value:""}}]},service:"totara_competency_user_index"},onClosed:function(){a.resetTreeList()},onSaved:function(b,c,d){a.renderItems("users",d)},primarySearch:{filterKey:"text",placeholderString:[{component:"totara_core",key:"search"}]},title:[{component:"totara_core",key:"selectuserplural"}]};b(c)})},j.prototype.getAudienceModalConfig=function(){var a=this;return new Promise(function(b){var c={externalBasket:a.baskets.audiences,key:"audiences",list:{map:{cols:[{dataPath:"display_name",headerString:{component:"totara_cohort",key:"name"}}]},service:a.services.audiences},onClosed:function(){a.resetTreeList()},onSaved:function(b,c,d){a.renderItems("audiences",d)},primarySearch:{filterKey:"text",placeholderString:[{component:"totara_core",key:"search"}]},title:[{component:"totara_cohort",key:"selectcohorts"}]};b(c)})},j.prototype.getOrganisationModalConfig=function(){var a=this;return new Promise(function(b,c){d.init().then(function(c){var d={externalBasket:a.baskets.organisations,key:"organisations",crumbtrail:{service:"hierarchy_organisation_show",stringList:[{component:"totara_hierarchy",key:"hierarchy_list:organisation:all"},{component:"totara_hierarchy",key:"hierarchy_list:organisation:all_in_framework"}]},events:c,expandable:{args:{include:{crumbs:1}},service:"hierarchy_organisation_show",template:"totara_competency/hierarchy_expanded"},levelToggle:!0,list:{map:{cols:[{dataPath:"fullname",expandedViewTrigger:!0,headerString:{component:"totara_hierarchy",key:"organisation"}}],extraRowData:[{key:"framework",dataPath:"frameworkid"}],hasExpandedView:!0,hasHierarchy:!0},service:"hierarchy_organisation_index"},onClosed:function(){a.resetTreeList()},onSaved:function(b,c,d){a.renderItems("organisations",d)},primaryDropDown:{filterKey:"framework",placeholderString:[{component:"totara_hierarchy",key:"allframeworks"}],service:"hierarchy_organisation_framework_index",serviceArgs:{direction:"asc",filters:[],order:"sortorder",page:0},serviceLabelKey:"fullname"},primarySearch:{filterKey:"text",placeholderString:[{component:"totara_core",key:"search"}]},title:[{component:"totara_hierarchy",key:"hierarchy_list:organisation:select"}]};b(d)})["catch"](function(){c()})})},j.prototype.getPositionModalConfig=function(){var a=this;return new Promise(function(b,c){d.init().then(function(c){var d={externalBasket:a.baskets.positions,key:"positions",crumbtrail:{service:"hierarchy_position_show",stringList:[{component:"totara_hierarchy",key:"hierarchy_list:position:all"},{component:"totara_hierarchy",key:"hierarchy_list:position:all_in_framework"}]},events:c,expandable:{args:{include:{crumbs:1}},service:"hierarchy_position_show",template:"totara_competency/hierarchy_expanded"},levelToggle:!0,list:{map:{cols:[{dataPath:"fullname",expandedViewTrigger:!0,headerString:{component:"totara_hierarchy",key:"position"}}],extraRowData:[{key:"framework",dataPath:"frameworkid"}],hasExpandedView:!0,hasHierarchy:!0},service:"hierarchy_position_index"},onClosed:function(){a.resetTreeList()},onSaved:function(b,c,d){a.renderItems("positions",d)},primaryDropDown:{filterKey:"framework",placeholderString:[{component:"totara_hierarchy",key:"allframeworks"}],service:"hierarchy_position_framework_index",serviceArgs:{direction:"asc",filters:[],order:"sortorder",page:0},serviceLabelKey:"fullname"},primarySearch:{filterKey:"text",placeholderString:[{component:"totara_core",key:"search"}]},title:[{component:"totara_hierarchy",key:"hierarchy_list:position:select"}]};b(d)})["catch"](function(){c()})})},j.prototype.getIndividualsModalConfig=function(){var a=this;return new Promise(function(b){var c={key:"individual",list:{map:{cols:[{dataPath:"full_name",headerString:{component:"core",key:"fullnameuser"}},{columnTemplate:{template:"totara_competency/save_user_group_names"},dataPath:"user_group_names",headerString:{component:"totara_competency",key:"sort_user_group_name"}}]},service:"totara_competency_expand_user_groups_index",serviceArgs:{baskets:{cohort:a.basketKeys.audiences,organisation:a.basketKeys.organisations,position:a.basketKeys.positions,user:a.basketKeys.users}}},primarySearch:{filterKey:"name",placeholderString:[{component:"totara_core",key:"search"}]},title:[{component:"totara_competency",key:"browse_selected_user_groups"}]};b(c)})},j.prototype.setParent=function(a){this.widget=a},j.prototype.getModalData=function(){var a=this;return new Promise(function(b,c){Promise.all([a.getAudienceModalConfig(),a.getOrganisationModalConfig(),a.getPositionModalConfig(),a.getUserModalConfig(),a.getIndividualsModalConfig()]).then(function(c){a.modalsData.audiences=c[0],a.modalsData.organisations=c[1],a.modalsData.positions=c[2],a.modalsData.users=c[3],a.modalsData.individuals=c[4],b()})["catch"](function(){c()})})},j.prototype.getPageStrings=function(){var b=[],c=this;return b.push({component:"totara_cohort",key:"cohorts"},{component:"totara_core",key:"individualplural"},{component:"totara_hierarchy",key:"organisationplural"},{component:"totara_hierarchy",key:"positionplural"},{component:"totara_competency",key:"save_modal_header"}),new Promise(function(d){a.get_strings(b).then(function(a){c.strings.audiences=a[0],c.strings.users=a[1],c.strings.organisations=a[2],c.strings.positions=a[3],c.strings.selectedGroups=a[4],c.strings.confirmationHeader=a[5],d()})})},j.prototype.createModals=function(){var a=this,b=[c.adder(a.modalsData.audiences),c.adder(a.modalsData.organisations),c.adder(a.modalsData.positions),c.adder(a.modalsData.users),c.viewer(a.modalsData.individuals)];Promise.all(b).then(function(b){var c,d,e;for(c=0;c<b.length;c++)e=b[c],d=e.getKey(),a.modalLists[d]=e;var f=a.widget.querySelector("[data-tw-assignCompSave-tree] [data-tw-selectorgroup]");f.setAttribute("data-tw-selecttree-disabled","activate"),a.getTotalCount()>0&&a.enableOverviewActions(),a.loader.hide()})["catch"](function(a){f.exception({fileName:"save_assignments.js",message:a[0]+" modal: "+a[1],name:"Error adding modal"})})};var k=function(a){return new Promise(function(b){var c=new j;c.setParent(a),c.initVariables(),c.loader=g.init(a),c.loader.show(),c.propagatedEvents(),b(c),c.getPageStrings().then(function(){c.getModalData().then(function(){c.createModals()})})})};return{init:k}});