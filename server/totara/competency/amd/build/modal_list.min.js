define(["core/str","core/templates","core/modal_factory","core/ajax"],function(a,b,c,d){function e(){return this instanceof e?void(this.externalBasket=null):new e}e.prototype.getKey=function(){return this.settings.key},e.prototype.initExtend=function(){this.setExtendingFunctions(),this.propagatedModalEvents()},e.prototype.propagatedModalEvents=function(){var a=this.modal.getRoot(),b=this;a.on("modal-save-cancel:save",function(){var a=new Promise(function(a){"adder"===b.settings.mode?b.basketManager.load().then(function(c){0===c.length?a(b.list.disabledItems):b.externalBasket?b.externalBasket.add(c).then(function(b){a(b)}):a(c.concat(b.list.disabledItems))}):"selector"===b.settings.mode?b.externalBasket?b.externalBasket.copyFrom(b.basketManager.getBasket()).then(function(b){a(b)}):b.basketManager.load().then(function(b){a(b)}):a([])});a.then(function(a){var c={args:b.list.getRequestArgs(),methodname:b.list.getWebservice()};c.args.filters={ids:a},c.args.page=0,d.getData(c).then(function(c){var d=c.results.items;b.reset(),b.settings.onSaved&&b.settings.onSaved(b,a,d)})})}),a.on("modal:hidden",function(){b.basketManager&&b.basketManager.widget.classList.contains("tw-selectionBasket__displayed")&&(b.basketManager.onBasketHide(),b.basketManager.onBasketHidden()),b.basketManager&&b.basketManager["delete"](),b.reset(),b.settings.onClosed&&b.settings.onClosed()})},e.prototype.setExtendingFunctions=function(){var a=this,b=a.settings.events;b&&Object.keys(b).forEach(function(c){if(a[c])for(var d in a.settings.events[c])b[c].hasOwnProperty(d)&&"function"==typeof b[c][d]&&(a[c][d]=b[c][d].bind(a))})},e.prototype.show=function(a){"undefined"==typeof a&&(a=null);var b=this,c=new Promise(function(c){"adder"===b.settings.mode?b.basketManager["delete"]().then(function(){b.externalBasket&&null===a?b.externalBasket.load().then(function(a){b.list.disabledItems=a,c([])}):(b.list.disabledItems=a,c([]))}):"selector"===b.settings.mode?b.externalBasket&&null===a?b.basketManager.getBasket().copyFrom(b.externalBasket).then(function(a){c(a)}):b.basketManager.getBasket().replace(a).then(function(a){c(a)}):c()});c.then(function(a){b.loader.show(),"viewer"===b.settings.mode?b.list.update().then(function(){b.modal.show()}):b.basketManager.renderBasket(a).then(function(){return b.updatePage([b.list.getUpdateRequestArgs()])}).then(function(){b.modal.show()})})};var f=function(a){return new Promise(function(b,c){void 0===a.key?c('Required option "key" has not been defined'):void 0===a.list?c('Required option "list" has not been defined'):void 0===a.list.service?c('Required list option "service" has not been defined'):void 0===a.list.map||"object"!=typeof a.list.map?c('Required list option "map" must be defined & must be of type object'):void 0===a.title?c('Required option "title" has not been defined'):b()})},g=function(a){var b={has_paging:!0,modal_display:!0,has_count:!0};return"adder"!==a.mode&&"selector"!==a.mode||(b.crumbs=null,b.hasToggleSelection=!0,b.selection_basket=!0),a.expandable&&(b.expandTemplate=a.expandable.template,a.expandable.service&&(b.expandTemplateWebservice=a.expandable.service,a.expandable.args&&(b.expandTemplateWebserviceArgs=JSON.stringify(a.expandable.args)))),a.list.map.hasHierarchy&&(b.crumbtrail_template_name="totara_competency/crumb_with_title",b.has_crumbtrail=!0,b.has_level_toggle=a.levelToggle),new Promise(function(c){var d=[];a.title&&d.push(k(a.title)),a.primarySearch&&d.push(j(a.primarySearch)),a.primaryDropDown&&d.push(i(a.primaryDropDown)),Promise.all(d).then(function(a){for(var d=0;d<a.length;d++){var e=a[d];if("object"==typeof e)for(var f in e)b[f]=e[f]}c(b)})})},h=function(a){return new Promise(function(d){g(a).then(function(e){var f="viewer"===a.mode?c.types.DEFAULT:c.types.SAVE_CANCEL;b.render("totara_competency/basket_list",e).then(function(a){c.create({body:a,large:!0,title:e.title,type:f}).done(function(a){a.attachToDOM(),d(a)})})})})},i=function(b){return new Promise(function(c){var e=new Promise(function(c){b.placeholderString.value?c(b.placeholderString.value):a.get_string(b.placeholderString[0].key,b.placeholderString[0].component).then(c)});e.then(function(a){d.getData({args:b.serviceArgs,methodname:b.service}).then(function(d){var e=b.serviceLabelKey?b.serviceLabelKey:"name",f=[{active:!0,"default":!0,has_children:!1,name:a,key:""}];f=f.concat(d.results.items.map(function(a){return{active:!1,"default":!1,has_children:!1,key:a.id,name:a[e]}}));var g={primary_filter_tree:{active_name:a,flat_tree:!0,key:b.filterKey,options:f,parents_are_selectable:!0,partial:!0,show_border_box:!0,title_hidden:!0}};c(g)})})})},j=function(b){return new Promise(function(c){var d=new Promise(function(c){b.placeholderString.value?c(b.placeholderString.value):a.get_string(b.placeholderString[0].key,b.placeholderString[0].component).then(c)});d.then(function(a){var d={primary_filter_search:{key:b.filterKey,partial:!0,placeholder_show:!0,title:a,title_hidden:!0}};c(d)})})},k=function(b){return new Promise(function(c){var d=new Promise(function(c){b[0].value?c({title:b[0].value}):a.get_string(b[0].key,b[0].component).then(function(a){c({title:a})})});d.then(function(a){c(a)})})},l=function(a){return new Promise(function(b){h(a).then(function(c){var d=a.crumbtrail?a.crumbtrail:null,f={crumbtrail:d,list:a.list,parent:c.body[0]},g=new Promise(function(b){"adder"===a.mode||"selector"===a.mode?require(["totara_competency/basket_list"],function(a){b(a)}):require(["totara_competency/view_list"],function(a){b(a)})});g.then(function(d){Object.assign(d.prototype,e.prototype);var g=new d;g.modal=c,g.settings=a,a.externalBasket&&(g.externalBasket=a.externalBasket),g.init(f).then(function(){b(g)})})})})},m=function(a){return new Promise(function(b,c){a.mode="adder",f(a).then(function(){a.list.map.hasCheckboxes=!0,l(a).then(function(a){b(a)})},function(b){c([a.key,b])})})},n=function(a){return new Promise(function(b,c){a.mode="selector",f(a).then(function(){a.list.map.hasCheckboxes=!0,l(a).then(function(a){b(a)})},function(b){c([a.key,b])})})},o=function(a){return new Promise(function(b,c){a.mode="viewer",f(a).then(function(){a.list.map.hasCheckboxes=!1,l(a).then(function(a){b(a)})},function(b){c([a.key,b])})})};return{adder:m,selector:n,viewer:o}});