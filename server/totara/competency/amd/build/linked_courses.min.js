define(["core/str","core/templates","totara_competency/modal_list","core/ajax","core/notification","totara_competency/loader_manager"],function(a,b,c,d,e,f){function g(){return this instanceof g?(this.competencyID=0,this.courseAdderModal={},this.courses=[],this.initialCourses=[],this.existingCourses=[],this.iconList=[],this.loader=null,this.removedClass="tw-editLinkedCourses__list_removed",this.removedCourses=[],void(this.strings={})):new g}g.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target)if(b.target.closest("[data-tw-editLinkedCourses-save]"))b.preventDefault(),a.saveChanges();else if(b.target.closest("[data-tw-editLinkedCourses-adder]"))b.preventDefault(),a.courseAdderModal.show(a.getCourseIds());else if(b.target.closest("[data-linked-courses-checkbox]")){var c=b.target.closest("[data-linked-courses-checkbox]"),d=c.closest("[data-tw-list-row]").getAttribute("data-tw-list-row"),e=a.getCourseById(d);e.mandatory=c.checked}else if(b.target.closest("[data-tw-editLinkedCourses-cancel]")){b.preventDefault();var f=b.target.closest("[data-tw-editLinkedCourses-cancel]"),g=f.getAttribute("data-tw-editLinkedCourses-cancel");g&&(window.location.href=g)}}),this.widget.addEventListener("totara_core/lists:action",function(b){var c=b.detail.key,d=parseInt(b.detail.val);switch(document.querySelector("#user-notifications")&&e.clearNotifications(),c){case"deleteClicked":a.existingCourses.indexOf(d)>-1?a.removeSavedRow(d):(a.removeUnsavedRow(d),a.loader.show(),a.refreshRowsDisplay());break;case"undoDeleteClicked":a.undoRemoveSavedRow(d)}}),window.addEventListener("beforeunload",function(b){var c=a.haveLinkedCoursesChanged(),d=M.util.get_string("unsaved_changes_warning","totara_competency");if(c)return b.returnValue=d,d})},getRowData:function(a){var b,c,d;this.removedCourses.indexOf(a.id)>-1?(b={event_key:"undoDeleteClicked",icon:this.iconList.undo},c=this.strings.removedLinkedCourse,d=this.removedClass):b={event_key:"deleteClicked",icon:this.iconList["delete"]};var e={actions:[b],actions_width:"xxsm",aria_label:c||a.fullname,columns:[{value:a.fullname},{column_template:"totara_competency/edit_linkedcourse_rows_checkbox",label:this.strings.mandatory,width:"xsm"}],id:a.id,mandatory:a.mandatory,row_custom_class:d};return e},getCourseById:function(a){for(var b=0;b<this.courses.length;b++)if(this.courses[b].id==a)return this.courses[b];return null},getCourseIds:function(){return 0===this.courses.length?[]:this.courses.map(function(a){return a.id})},getLinkedCourses:function(){var a=this,b={args:{competency_id:this.competencyID},methodname:"totara_competency_get_linked_courses"};return a.existingCourses=[],new Promise(function(c){d.getData(b).then(function(b){a.courses=b.results.items,a.resetInitialCourses();for(var d=0;d<b.results.items.length;d++){var e=parseInt(b.results.items[d].id);a.existingCourses.push(e)}c()})})},getModalListData:function(){var a=this;return{key:"totara_competency_linked_courses",title:[{component:"totara_competency",key:"select_courses"}],list:{map:{cols:[{dataPath:"fullname",headerString:{key:"fullname",component:"totara_competency"}}]},service:"totara_competency_get_courses"},onSaved:function(b,c,d){var f=[];document.querySelector("#user-notifications")&&e.clearNotifications();for(var g=0;g<d.length;g++){var h=1,i=a.getCourseById(d[g].id);null!==i&&(h=i.mandatory),f.push({id:d[g].id,fullname:d[g].fullname,mandatory:h})}a.courses=f,a.loader.show(),a.refreshRowsDisplay()},primaryDropDown:{filterKey:"category",serviceLabelKey:"fullname",placeholderString:[{component:"totara_competency",key:"all_categories"}],service:"totara_competency_get_categories",serviceArgs:{}},primarySearch:{filterKey:"name",placeholderString:[{component:"totara_competency",key:"search_courses"}]}}},loadCourseModalList:function(){var a=this;return new Promise(function(b){c.adder(a.getModalListData()).then(function(c){a.courseAdderModal=c,b()})["catch"](function(a){e.exception({message:"Error adding course modal list adder"+a[0]+" "+a[1]})})})},loadIcons:function(){var a=[],c=this,d=[{classes:"tw-list__hover_warning",key:"delete",name:"remove",string:this.strings.removeLinkedCourse},{classes:"",key:"undo",name:"undo",string:this.strings.undoRemoveLinkedCourse}];return new Promise(function(e){for(var f=0;f<d.length;f++){var g=d[f];a.push(b.renderIcon(g.name,g.string,g.classes))}Promise.all(a).then(function(a){for(var b=0;b<d.length;b++)c.iconList[d[b].key]=a[b];e()})})},loadStrings:function(){var b=this,c=[{component:"totara_competency",key:"linked_courses_saved"},{component:"totara_competency",key:"mandatory"},{component:"core",key:"courses"},{component:"totara_competency",key:"remove_linked_course"},{component:"totara_competency",key:"removed_linked_course"},{component:"totara_competency",key:"undo_remove_linked_course"},{component:"totara_competency",key:"no_courses_linked_yet"},{component:"totara_competency",key:"unsaved_changes_warning"}];return new Promise(function(d,e){a.get_strings(c).then(function(a){b.strings={savedMsg:a[0],mandatory:a[1],courses:a[2],removeLinkedCourse:a[3],removedLinkedCourse:a[4],undoRemoveLinkedCourse:a[5],noResults:a[6]}}).then(function(){d()})["catch"](function(){e()})})},refreshRowsDisplay:function(){for(var a=this,c=this.widget.querySelector("[data-tw-list]"),d={has_actions:!0,noResultsText:this.strings.noResults,rows:[],row_header:{columns:[{value:this.strings.courses},{value:this.strings.mandatory,width:"xsm"}],header:!0}},e=0;e<this.courses.length;e++)d.rows.push(this.getRowData(this.courses[e]));b.renderReplace("totara_competency/lists_rows",d,c).then(function(){a.loader.hide()})},removeSavedRow:function(a){this.removedCourses.push(a),this.loader.show(),this.refreshRowsDisplay()},removeUnsavedRow:function(a){for(var b,c=0;c<this.courses.length;c++)if(b=this.courses[c].id,b===a){this.courses.splice(c,1);break}},saveChanges:function(){var a,b=this;for(b.loader.show(),document.querySelector("#user-notifications")&&e.clearNotifications(),a=0;a<b.removedCourses.length;a++){var c=b.removedCourses[a];b.removeUnsavedRow(c)}b.removedCourses=[];var f=[];for(a=0;a<b.courses.length;a++)f[a]={id:b.courses[a].id,mandatory:b.courses[a].mandatory};d.getData({args:{competency_id:b.competencyID,courses:f},methodname:"totara_competency_set_linked_courses"}).then(function(){b.getLinkedCourses().then(function(){b.refreshRowsDisplay(),b.loader.hide(),e.addNotification({message:b.strings.savedMsg,type:"success"})})})},setCompetency:function(){var a=this.widget.closest("[data-tw-editLinkedCourses-comp-id]");a&&(this.competencyID=a.getAttribute("data-tw-editLinkedCourses-comp-id"))},setParent:function(a){this.widget=a},undoRemoveSavedRow:function(a){var b=this.removedCourses.indexOf(a);b>-1&&this.removedCourses.splice(b,1),this.loader.show(),this.refreshRowsDisplay()},haveLinkedCoursesChanged:function(){if(this.courses.length!==this.initialCourses.length)return!0;var a=this.initialCourses;return this.courses.some(function(b,c){return b.id!==a[c].id||b.mandatory!==a[c].mandatory})},resetInitialCourses:function(){this.initialCourses=this.courses.map(function(a){return{id:a.id,mandatory:a.mandatory}})}};var h=function(a){return new Promise(function(b){var c=new g;c.setParent(a),c.setCompetency(),c.events(),c.loader=f.init(a),c.loader.show(),b(c),M.util.js_pending("linkedCourses"),Promise.all([c.loadStrings(),c.getLinkedCourses(),c.loadCourseModalList()]).then(function(){c.loadIcons().then(function(){c.refreshRowsDisplay(),M.util.js_complete("linkedCourses")})})})};return{init:h}});