function totaraDialog(t,e,i,a,l){this.title=t,this.buttonid=e,this.dialog,this.default_url=a,this.url="",this.config=i,this.handler=l,this.setup=function(){var t=this,e=.8*$(window).height(),i=.8*$(window).width();i=Math.max(i,$(window).width()-50),i=Math.min(i,800);var a={autoOpen:!1,closeOnEscape:!0,draggable:!1,height:e,width:i+"px",modal:!0,resizable:!1,zIndex:1500,dialogClass:"totara-dialog",open:function(){$(this).parent().find("span.ui-dialog-title").html("<span class='title'>"+t.config.title+"</span>")}};$('<div class="totara-dialog" style="display: none;"><div id="'+this.title+'"></div></div>').appendTo($("body")),this.dialog=$("#"+this.title).dialog($.extend(a,this.config)),void 0!=this.handler&&this.handler._setup(this),$("#"+this.title).on("dialogclose",function(e){e.preventDefault(),t.hide()}),$(document).on("click","#"+this.buttonid,function(e){e.preventDefault(),t.open()}),$.ui.dialog.prototype._focusTabbable=function(){}},this.open=function(){this.dialog.html(""),this.dialog.dialog("open");var t=this.dialog.parent(),e=t.height()-$("div.ui-dialog-titlebar",t).height()-$("div.ui-dialog-buttonpane",t).height()-36;this.dialog.height(e),void 0!=this.handler._open&&this.handler._open(),this.load(this.default_url)},this.load=function(t,e,i){this.dialog.html(""),this.showLoading(),this.url="function"==typeof t?t():t,this._request(this.url,{},e,i)},this.error=function(t,e){e?(t.hideLoading(),t.dialog.html(e)):require(["core/str"],function(e){e.get_string("error:dialoggenericerror","totara_core").done(function(e){t.hideLoading(),t.dialog.html('<div class="box errorbox errorboxcontent">'+e+"</div>")})})},this.render=function(t,e){this.hideLoading(),e?e.html(t):this.dialog.html(t),this.bindLinks(),this.bindForms(),this.handler._load(),e&&void 0!=this.handler._partial_load&&this.handler._partial_load(e)},this.bindLinks=function(){var t=this;$("a",this.dialog).each(function(){0==$(this).parents(".dialog-nobind").length&&($(this).parent().is("span.helplink")||$(this).on("click",function(e){var i=$(this).attr("href"),a=$(this).parents(".dialog-load-within").slice(0,1);return 0!=a.length?(t.showLoading(),t._request(i,{outputelement:a})):t.load(i),e.preventDefault(),!1}))})},this.bindForms=function(){var t=this;$("form",this.dialog).each(function(){$(this).on("submit",function(e){var i=$(this).attr("action"),a=$(this).attr("method"),l=$(this).serialize(),n=$(this).parents(".dialog-load-within").slice(0,1);return 0!=n.length?(t.showLoading(),t._request(i,{outputelement:n},a,l)):t.load(i,a,l),e.preventDefault(),!1})})},this.showLoading=function(){$("div#"+this.title).addClass("yui-isloading")},this.hideLoading=function(){$("div#"+this.title).removeClass("yui-isloading")},this.hide=function(){this.handler._loaded=!1,this.dialog.html(""),this.dialog.dialog("isOpen")&&this.dialog.dialog("close")},this._request=function(t,e,i,a){var l=this;void 0==i&&(i="POST"),$.ajax({url:t,type:i,data:a,dataType:"html",success:function(t){var i=!0;void 0!=e&&void 0!=e.object&&(i=e.object[e.method](t,e.data)),i&&(void 0!=e&&void 0!=e.outputelement?l.render(t,e.outputelement):l.render(t),l.dialog.find("a:visible, input:visible, select:visible, button:visible").length>0?l.dialog.find("a:visible, input:visible, select:visible, button:visible")[0].focus():l.dialog.parent().find(".ui-dialog-buttonpane button")[0].focus())},error:function(e){l.error(l,e.responseText,t)}})},this.setup()}function totaraDialog_handler(){}M.totara_dialog=M.totara_dialog||{Y:null,config:{},init:function(t,e){if(this.Y=t,e){var i=t.JSON.parse(e);for(var a in i)t.Object.owns(i,a)&&(this.config[a]=i[a])}if("undefined"==typeof $)throw Error("M.totara_dialog.init()-> jQuery dependency required for this module to function.")}},navigator.userAgent.match(/mozilla/i)&&$("body").addClass("mozilla");var totaraDialogs={};totaraDialog_handler.prototype._setup=function(t){this._dialog=t,this._title=t.title},totaraDialog_handler.prototype._load=function(){if(!this._loaded){this._container=$("#"+this._title),void 0!=this.first_load&&this.first_load();var t=this._container.height(),e=parseFloat($(".select h3",this._container).css("margin-bottom"),10)||0,i=parseFloat($("#dialog-tabs",this._container).css("margin-bottom"),10)||0,a=t-$(".select h3",this._container).outerHeight(!0)-$(".select .tabs",this._container).outerHeight(!0)-($("#dialog-tabs").outerHeight(!0)-$("#dialog-tabs").height())+Math.min(e,i);$("#browse-tab").outerHeight(a),$("#search-tab").outerHeight(a),$(".selected.dialog-nobind",this._container).outerHeight(this._container.height()),this._loaded=!0}return void 0!=this.every_load&&this.every_load(),!0},totaraDialog_handler.prototype._update=function(t){$(".noitems-"+this._title).remove(),this._dialog.hide();var e=$("div.list-"+this._title);e.replaceWith(t),$(".totara-noscript",$("div.list-"+this._title)).hide()},totaraDialog_handler.prototype._get_ids=function(t){var e=[];return t.each(function(){var t=$(this).attr("id").split("_");t="personal"==t[t.length-2]?"p"+t[t.length-1]:t[t.length-1],e.push(t)}),e},totaraDialog_handler.prototype._save=function(t){var e=$(".selected > div > span",this._container),i=this._get_ids(e).join(",");t+=i,this._dialog._request(t,{object:this,method:"_update"})},totaraDialog_handler.prototype._cancel=function(){this._dialog.hide()},totaraDialog_handler.prototype._set_framework=function(){var t=$(".simpleframeworkpicker option:selected",this._container).val(),e=this._dialog.url;if(-1==e.indexOf("&frameworkid=")||-1==e.indexOf("?frameworkid="))e=e+"&frameworkid="+t+"&treeonly=1&switchframework=1";else{var i=e.indexOf("frameworkid=")+12,a=e.indexOf("&",i);e=-1==a?e.substring(0,i)+t:e.substring(0,i)+t+e.substring(a)}this._dialog.showLoading(),this._dialog._request(e,{outputelement:$("#browse-tab .treeview-wrapper",this._container)})},totaraDialog_handler.prototype._set_plan=function(){var t=$(".planselector option:selected",this._container).val(),e=this._dialog.url;e=e+"&planid="+t+"&treeonly=1&switchplan=1",this._dialog.showLoading(),this._dialog._request(e,{outputelement:$("#browse-tab .treeview-wrapper",this._container)})},totaraDialog_handler_treeview=function(){},totaraDialog_handler_treeview.prototype=new totaraDialog_handler,totaraDialog_handler_treeview.prototype.setup_tabs=function(t,e){$(".select",this._container);e&&"search-tab"===$(e.newTab).attr("aria-controls")&&$("#id_query",this._container).focus()},totaraDialog_handler_treeview.prototype.first_load=function(){var t=this;$(".treeview",this._container).treeview({prerendered:!0}),$("#dialog-tabs").tabs({selected:0,show:t.setup_tabs,activate:t.setup_tabs}),this.setup_tabs(),$(".simpleframeworkpicker",this._container).off("change"),$(".simpleframeworkpicker",this._container).change(function(){t._set_framework()}),$(".planselector",this._container).off("change"),$(".planselector",this._container).change(function(){t._set_plan()}),this._make_hierarchy($(".treeview",this._container)),$(".selected > div > span a",this._container).off("click").click(function(t){t.preventDefault()})},totaraDialog_handler_treeview.prototype._partial_load=function(t){if(this.setup_tabs(),t.hasClass("treeview"))var e=t;else var e=$(".treeview",t);return e.length&&e.treeview({prerendered:!0}),this._make_hierarchy(t),$(".selected > div > span a",t).off("click").click(function(t){t.preventDefault()}),void 0!=this.every_load&&this.every_load(),!0},totaraDialog_handler_treeview.prototype._make_hierarchy=function(t){var e=this;$("span.expandonly",t).each(function(){var t=$(this).attr("id"),i=$(".treeview",e._container).find("span#"+t);$("a",i).off("click"),$("a",i).click(function(t){t.preventDefault()})}),$("span.folder, div.hitarea, span.expandonly",t).on("click",function(){var t=$(this).parent();if($("> ul > li",t).length)return!1;var i=t.attr("id").substr(10),a=e._dialog.url+"&parentid="+i;return e._dialog._request(a,{object:e,method:"_update_hierarchy",data:i}),!1}),$("span.unclickable",t).each(function(){e._toggle_items($(this).attr("id"),!1)}),$(".selected > div > span",this._container).each(function(){var t=$(this).attr("id");e._toggle_items(t,!1)})},totaraDialog_handler_treeview.prototype._update_hierarchy=function(t,e){var i=t,a=$("#browse-tab .treeview li#item_list_"+e+" ul:first",this._container);$("li",a).remove();var l=$("#browse-tab .treeview",this._container);l.treeview({add:a.append($(i))}),this._make_hierarchy(a),void 0!=this._handle_update_hierarchy&&this._handle_update_hierarchy(a)},totaraDialog_handler_treeview.prototype._toggle_items=function(t,e){var i=this,a=$(".treeview",this._container).find("span#"+t);e?(a.removeClass("unclickable"),a.addClass("clickable"),void 0!=i._make_selectable&&a.each(function(){i._make_selectable($(".treeview",i._container))})):(a.removeClass("clickable"),a.addClass("unclickable"),$("a",a).off("click"),$("a",a).click(function(t){t.preventDefault()}))},totaraDialog_handler_treeview.prototype._make_deletable=function(t){var e=$(".deletebutton",t),i=this;e.off("click"),e.each(function(){var t=$(this).parent();t.hasClass("unremovable")||$(this).click(function(){var t=$(this).parent();return i._toggle_items(t.attr("id"),!0),t.remove(),!1})})},totaraDialog_handler_treeview.prototype._append_to_selected=function(t){var e=t.closest("span").clone(),i=$(".selected",this._container);if($("#"+e.attr("id"),i).length<1){var a=$("<div></div>").append(e),l=a.find("span").first().data().displaystring;l&&a.find("a").first().text(l),i.append(a),$("a",a).click(function(t){t.preventDefault()}),i.scrollTop(i.children().slice(-1).position().top),this._make_deletable(i)}},totaraDialog_handler_treeview_multiselect=function(){},totaraDialog_handler_treeview_multiselect.prototype=new totaraDialog_handler_treeview,totaraDialog_handler_treeview_multiselect.prototype.every_load=function(){this._make_selectable($(".treeview",this._container)),this._make_deletable($(".selected",this._container))},totaraDialog_handler_treeview_multiselect.prototype._make_selectable=function(t){{var e=$("span.clickable",t),i=this;$("span.clickable a",t).off()}e.off("click"),e.on("click",function(){var t=$(this);return i._append_to_selected(t),i._toggle_items(t.attr("id"),!1),!1})},totaraDialog_handler_treeview_multiselect.prototype._handle_update_hierarchy=function(t){this._make_selectable(t)},totaraDialog_handler_treeview_multiselect_rb_filter=function(){},totaraDialog_handler_treeview_multiselect_rb_filter.prototype=new totaraDialog_handler_treeview_multiselect,totaraDialog_handler_treeview_multiselect_rb_filter.prototype.first_load=function(){var t=this._title,e=$(".list-"+t),i=this,a="";$(".multiselect-selected-item",e).each(function(){var t=$(this).data("id"),e=$(this).text();a+='<div class="treeview-selected-item"><span id="item_'+t+'"><a href="#">'+e+'</a><span class="deletebutton">'+M.util.get_string("delete","totara_core")+"</span></span></div>",i._toggle_items("item_"+t,!1)});var l=$(".selected",this._container);l.append(a),totaraDialog_handler_treeview_multiselect.prototype.first_load.call(this)},totaraDialog_handler_treeview_multiselect_rb_filter.prototype._update=function(t){var e=this._title,i=$("input[name="+e+"]"),a=i.val(),l=a?a.split(","):[];$("#"+e+" .selected .clickable").each(function(){l.push($(this).attr("id").split("_")[1])});var n=l.join(",");i.val(n),this._dialog.hide();var o=$("div.list-"+this._title);o.replaceWith(t),$(".totara-noscript",$("div.list-"+this._title)).hide()},totaraDialog_handler_treeview_singleselect=function(t,e,i){this.value_element_name=t,this.text_element_id=e,this.dualpane="undefined"!=i?i:!1},totaraDialog_handler_treeview_singleselect.prototype=new totaraDialog_handler_treeview,totaraDialog_handler_treeview_singleselect.prototype._handle_update_hierarchy=function(t){this._make_selectable(t)},totaraDialog_handler_treeview_singleselect.prototype.setup_delete=function(){this.deletable=!0;var t=$("#"+this.text_element_id),e=$('input[name="'+this.value_element_name+'"]'),i=$('<a href="#" class="dialog-singleselect-deletable"></a>'),a=this;i.click(function(i){i.preventDefault(),e.val(""),t.removeClass("nonempty"),t.empty(),a.setup_delete()}),require(["core/templates"],function(t){t.renderIcon("delete",M.util.get_string("delete","totara_core")).done(function(t){i.html(t)})}),t.hasClass("nonempty")&&t.text().length>0&&t.append(i)},totaraDialog_handler_treeview_singleselect.prototype.first_load=function(){totaraDialog_handler_treeview.prototype.first_load.call(this),this._set_current_selected()},totaraDialog_handler_treeview_singleselect.prototype.every_load=function(){this._make_selectable($(".treeview",this._container))},totaraDialog_handler_treeview_singleselect.prototype._set_current_selected=function(){var t=$('input[name="'+this.value_element_name+'"]').val(),e=$("#"+this.text_element_id).clone();$(".dialog-singleselect-deletable",e).remove(),e=e.text();var i=60;t&&e||(t=0,e="None"),label_length=$("#treeview_currently_selected_span_"+this._title+" label").html().length,e.length+label_length>i&&(e=e.substring(0,i-label_length)+"..."),$("#treeview_selected_text_"+this._title).text(e),$("#treeview_selected_val_"+this._title).val(t),0!=t&&($("#treeview_currently_selected_span_"+this._title).css("display","inline"),this._toggle_items("item_"+t,!1))},totaraDialog_handler_treeview_singleselect.prototype._save=function(){dialog=this;var t=$("#treeview_selected_val_"+this._title).val();if("0"===t)return M.str.hasOwnProperty("totara_core")&&M.str.totara_core.hasOwnProperty("error:"+this._title+"notselected")?alert(M.util.get_string("error:"+this._title+"notselected","totara_core")):require(["core/str"],function(t){t.get_string("error:itemnotselected","totara_core").done(function(t){alert(t)})}),!1;var e=$(".treeview span.unclickable#item_"+t+" a",dialog._container).html();this.value_element_name&&$('input[name="'+this.value_element_name+'"]').val(t),this.text_element_id&&(e?($("#"+this.text_element_id).html(e),$("#"+this.text_element_id).addClass("nonempty")):$("#"+this.text_element_id).removeClass("nonempty"),this.deletable&&this.setup_delete()),this.external_function&&this.external_function(),this._dialog.hide()},totaraDialog_handler_treeview_singleselect.prototype._make_selectable=function(t){{var e=$("span.clickable",t),i=this;$("span.clickable a",t).off()}return e.off("click"),this.dualpane?void e.click(function(){var t=$(this),e=$("#treeview_selected_val_"+i._title).val();i._toggle_items("item_"+e,!0),i._toggle_items($(this).attr("id"),!1);var a=t.attr("id").split("_");return a=a[a.length-1],t.attr("id",a),void 0!=i.handle_click&&i.handle_click($(this)),!1}):(e.click(function(){var e=$(this),a=e.clone(),l=60,n=$("#treeview_selected_val_"+i._title).val();i._toggle_items($(this).attr("id"),!1),label_length=$("#treeview_currently_selected_span_"+i._title+" label").html().length,selected_title=i.get_selected_title?i.get_selected_title(a):$("a",a).html().length+label_length>l?$("a",a).html().substring(0,l-label_length)+"...":$("a",a).html(),$("#treeview_selected_text_"+i._title).html(selected_title);var o=a.attr("id").split("_")[1];return $("#treeview_selected_val_"+i._title).val(o),$("#treeview_currently_selected_span_"+i._title).css("display","inline"),i._toggle_items("item_"+n,!0),i._make_selectable(t),!1}),void i._toggle_items("item_"+$("#treeview_selected_val_"+i._title).val(),!1))},totaraDialog_handler_skeletalTreeview=function(){},totaraDialog_handler_skeletalTreeview.prototype=new totaraDialog_handler_treeview,totaraDialog_handler_skeletalTreeview.prototype.every_load=function(){$(".treeview",this._container).treeview({prerendered:!0});var t=this;$(".simpleframeworkpicker",this._container).off("change"),$(".simpleframeworkpicker",this._container).change(function(){t._set_framework()}),$(".planselector",this._container).off("change"),$(".planselector",this._container).change(function(){t._set_plan()}),this._make_hierarchy($(".treeview",this._container)),this._make_deletable($(".selected",this._container))},totaraDialog_handler_skeletalTreeview.prototype._make_hierarchy=function(t){var e=this;$("span.folder, div.hitarea",t).click(function(){var t=$(this).parent();if(0===$("li:visible",$(t)).length)return!1;if(0===$("> ul > li.loading",t).length)return!1;var i=t.attr("id").substr(10);return e._handle_hierarchy_expand(i),!1})},totaraDialog_handler_skeletalTreeview.prototype._update_hierarchy=function(t,e){var i=t,a=$(".treeview li#item_list_"+e+" ul:first",this._container);$("> li.loading",a).remove(),$(".treeview",this._container).treeview({add:a.append($(i))});var l=this;l._make_selectable(a,!1)},totaraDialog_handler_skeletalTreeview.prototype._make_selectable=function(t,e){var i=this;e&&e.addClass("clickable"),void 0!=i._handle_course_click?$("span.clickable",t).click(function(){var t=$(this).parent(),e=t.attr("id").substr(7);i._handle_course_click(e)}):($("span.clickable",t).parent().mouseenter(function(){$(".addbutton",this._container).css("display","none"),$(this).find(".addbutton").css("display","inline")}),$("span.clickable",t).parent().mouseleave(function(){$(this).find(".addbutton").css("display","none")}),$("span.clickable",t).find(".list-item-action").click(function(){i._append_to_selected($(this)),$(this).parents("span:first").attr("class","unclickable"),$(this).html("")}))},totaraDialog_handler_form=function(){},totaraDialog_handler_form.prototype=new totaraDialog_handler,totaraDialog_handler_form.prototype.every_load=function(){var t=this,e=$("form",this._container);e.off("submit"),e.on("submit",function(e){e.preventDefault(),t._dialog.showLoading();var i=$(this).attr("action"),a=$(this).attr("method"),l=$(this).serialize();t._dialog._request(i,{object:t,method:"_updatePage"},a,l)})},totaraDialog_handler_form.prototype.submit=function(){var t=$("form",this._container).first();t.submit()},totaraDialog_handler_form.prototype._updatePage=function(t){var e=$(t);e.each(function(){var t=$(this).attr("id");t&&$("body #"+t).replaceWith($(this))}),this._dialog.hide()},totaraDialog_handler_selectable=function(t){this.selected=t},totaraDialog_handler_selectable.prototype=new totaraDialog_handler,totaraDialog_handler_selectable.prototype.first_load=function(){$("#icon-selectable").selectable({filter:"li",multiple:!1}),this._set_selected()},totaraDialog_handler_selectable.prototype.every_load=function(){totaraDialog_handler_selectable.prototype.first_load.call(this)},totaraDialog_handler_selectable.prototype._updatePage=function(t){var e=void 0===this._dialog.suffix?"":this._dialog.suffix;""===e?$("input[name=icon]").val(t.id):$("#icon"+e).val(t.id),$("#icon_preview"+e).attr("src",t.src),$("#icon_preview"+e).attr("title",t.id.replace(/-|_/g," ").toTitleCase()),this._dialog.hide()},totaraDialog_handler_selectable.prototype._set_selected=function(){$("#"+this.selected).addClass("ui-selected"),$("input[name=icon]").attr("initialvalue",this.selected)},String.prototype.toTitleCase=function(){return this.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},totaraSingleSelectDialog=function(t,e,i,a,l,n,o){var r=new totaraDialog_handler_treeview_singleselect(a,l),s={};o&&r.setup_delete(),r.external_function=n,s[M.util.get_string("ok","moodle")]=function(){r._save()},s[M.util.get_string("cancel","moodle")]=function(){r._cancel()},totaraDialogs[t]=new totaraDialog(t,"show-"+t+"-dialog",{buttons:s,title:"<h2>"+e+"</h2>"},i,r)},totaraMultiSelectDialog=function(t,e,i,a){var l=new totaraDialog_handler_treeview_multiselect,n={};n[M.util.get_string("save","totara_core")]=function(){l._save(a)},n[M.util.get_string("cancel","moodle")]=function(){l._cancel()},totaraDialogs[t]=new totaraDialog(t,"show-"+t+"-dialog",{buttons:n,title:"<h2>"+e+"</h2>"},i,l)},totaraMultiSelectDialogRbFilter=function(t,e,i,a){var l=new totaraDialog_handler_treeview_multiselect_rb_filter,n={};n[M.util.get_string("save","totara_core")]=function(){l._save(a)},n[M.util.get_string("cancel","moodle")]=function(){l._cancel()},totaraDialogs[t]=new totaraDialog(t,"show-"+t+"-dialog",{buttons:n,title:"<h2>"+e+"</h2>"},i,l),$(document).on("click",".multiselect-selected-item[data-filtername="+t+"] a",function(t){t.preventDefault();var e=$(this).parents("div.multiselect-selected-item"),i=e.data("filtername"),a=e.data("id"),l=$("input[name="+i+"]"),n=l.val(),o=n.split(","),r=$.grep(o,function(t){return t!=a}),s=r.join(",");l.val(s),e.remove()})};for(var init in window.dialoginits)"function"==typeof window.dialoginits[init]&&window.dialoginits[init]();window.dialogsInited=!0;