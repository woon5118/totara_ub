define(["jquery","core/config","core/templates","core/notification"],function(a,b,c,d){function e(a,b,c,d){return this instanceof e?(this.parent=a,this.type=b,this.id=c,void(this.node=d)):new e(a,b,c,d)}function f(){this.elements={}}function g(a,b,c){return this instanceof g?(e.call(this,a,"totara_form\\form\\group",b,c),void f.call(this)):new g(a,b,c)}function h(c){return this instanceof h?(["el"].forEach(function(a){if(!c.hasOwnProperty(a)){var b='Missing required config property "'+a+'"';throw new Error(b)}}),this.node=c.el,this.id=c.el.getAttribute("id"),this.clientActions=[],this.actionListeners=[],this.form=a(this.node),this.form.data("TotaraForm",this),this.form.attr("action")===b.wwwroot+"/totara/form/ajax.php"&&(j.debug("Form submission for "+this.id+" is being directed via ajaxSubmit",this,j.LOGLEVEL.info),this.form.on("submit.ajaxSubmit",a.proxy(function(a){a.preventDefault(),this.ajaxSubmit(this.form.find("input[type=submit]:focus"))},this))),void f.call(this)):new h(c)}var i=!(!window.console||!b.hasOwnProperty("developerdebug"))&&b.developerdebug;e.prototype={toString:function(){return"[object Element]"},init:function(a){a()},getId:function(){return this.id},getType:function(){return this.type},getNode:function(){return this.node},getValue:function(){return null},compare:function(a){var b=this.getValue(),c=[b].concat(Array.prototype.slice.call(arguments));return h.prototype.compare.apply(null,c)},isEmpty:function(){var a=this.getValue();return null===a||""===a||0===a||a===[]||a===[]||!!a.hasOwnProperty("isEmpty")&&a.isEmpty()},isHidden:function(){return null!==this.node.getAttribute("data-hidden")},setHidden:function(a){a?(j.debug("#"+this.id+" is now hidden",this,j.LOGLEVEL.debug),this.node.setAttribute("data-hidden","")):(j.debug("#"+this.id+" is no longer hidden",this,j.LOGLEVEL.debug),this.node.removeAttribute("data-hidden"))},changed:function(a){this.getForm().valueChanged(this.getId(),this.getValue())},disable:function(){return!!this.input&&(this.input.setAttribute("disabled",""),!0)},enable:function(){return!!this.input&&(this.input.removeAttribute("disabled"),!0)},isDisabled:function(){return this.input?null!==this.input.getAttribute("disabled"):null},isEnabled:function(){return this.input?null===this.input.getAttribute("disabled"):null},getForm:function(){var a=0,b=function(c){if(a++,a>10)throw"Coding error: element nesting is too deep!";return c.hasOwnProperty("parent")?b(c.parent):c};return b(this.parent)}},f.prototype={registerItem:function(a){i&&this.elements[a.getId()]&&j.debug("Item being registered already exists #"+a.getId(),f,j.LOGLEVEL.error),this.elements[a.getId()]=a},registerGroup:function(a,b){this.registerItem(a);var c=!0;if(i){var d=3e3;window.setTimeout(function(){c===!0&&j.debug("Element #"+a.getId()+" failed to call done() in "+d+"ms",a,j.LOGLEVEL.error)},d)}j.debug("Registered group #"+a.getId()+" of type "+a.getType(),a,j.LOGLEVEL.debug),a.init(function(){j.debug("Completed initialisation of #"+a.getId(),a,j.LOGLEVEL.debug),c=!1,b.resolve(a)})},registerElement:function(a,b){this.registerItem(a);var c=!0;if(i){var d=3e3;window.setTimeout(function(){c===!0&&j.debug("Element #"+a.getId()+" failed to call done() in "+d+"ms",a,j.LOGLEVEL.error)},d)}j.debug("Registered element #"+a.getId()+" of type "+a.getType(),a,j.LOGLEVEL.debug),a.init(function(){j.debug("Completed initialisation of #"+a.getId(),a,j.LOGLEVEL.debug),c=!1,b.resolve(a)})},filterItems:function(b,c,d){var e=[],f=[];if(void 0===d&&(d=0),d++,d>6)return j.debug("Filtering depth exceeds known limits, coding error!",this,j.LOGLEVEL.error),e;if(d>4&&j.debug("Filtering depth nearing limit, check you need this level of depth!",this,j.LOGLEVEL.warn),"function"!=typeof b)throw new Error("You must provide a filter function for filterItems()");for(var h in this.elements)if(this.elements.hasOwnProperty(h)){var i=this.elements[h];b(i)===!0&&(e[h]=i),c===!0&&i instanceof g&&(f=i.filterItems(b,!0,d),e=a.extend(e,f))}return e},getElements:function(a){return this.filterItems(function(a){return!(a instanceof g)&&a instanceof e},a)},getGroups:function(a){return this.filterItems(function(a){return a instanceof g},a)},getElementById:function(a){var b=this.getElements(!0);return b[a]},getGroupById:function(a){var b=this.getGroups(!0);return b[a]},getItemById:function(b){var c=a.extend(this.getElements(!0),this.getGroups(!0));return c[b]},map:function(a){var b=this.elements,c=[];for(var d in b)b.hasOwnProperty(d)&&c.push(a(b[d]));return c},disable:function(){return this.map(function(a){a.disable()}),this},enable:function(){return this.map(function(a){a.enable()}),this},isDisabled:function(){var a=this.map(function(a){return a.isDisabled()});return a.indexOf(!1)===-1},isEnabled:function(){var a=this.map(function(a){return a.isEnabled()});return a.indexOf(!1)===-1},isValid:function(){return this.getElements(!0).every(function(a){if("function"!=typeof a.isValid)return!0;var b=a.isValid();return b||"function"!=typeof a.displayError||a.displayError(),b})},toString:function(){return"[object ElementCollection]"},findItemNodes:function(b){var c=j.attributeIdentifiers.CLASSIFICATION+'="'+j.itemIdentifiers.ELEMENT+'"',d=j.getDataAttributeSelector(c),e=j.attributeIdentifiers.CLASSIFICATION+'="'+j.itemIdentifiers.GROUP+'"',f=j.getDataAttributeSelector(e),g=a(b),h=g.find([d,f].join(", ")).get();return h=Array.prototype.filter.call(h,function(b){return 0===a(b).parentsUntil(g,f).length})},getItemNodes:function(){return this.findItemNodes(this.node)},initGroup:function(b){var c,d,e=this,f={},h=j.attributeIdentifiers,i=a.Deferred();if([h.TYPE,h.ID,h.MODULE].forEach(function(a){f[a.split("-").pop()]=b.getAttribute(a)}),f.module)require([f.module],function(c){var d=new c(e,f.id,b),g=d.getItemNodes(),h=a.Deferred();e.registerGroup(d,h),h.done(function(){d.initItems(g).then(function(){i.resolve()},function(a){j.debug("Failed to initialise the items within a group of type "+f.module,e,j.LOGLEVEL.error),i.reject()})})});else{c=new g(this,f.id,b),d=c.getItemNodes();var k=a.Deferred();this.registerGroup(c,k),k.done(function(){c.initItems(d).done(function(){i.resolve()})})}return i.promise()},initElement:function(b){var c=this,d=a.Deferred(),e={},f=j.attributeIdentifiers;return[f.TYPE,f.ID,f.MODULE].forEach(function(a){e[a.split("-").pop()]=b.getAttribute(a)}),e.module||(e.module="totara_form/element_generic"),require([e.module],function(a){var f=new a(c,e.type,e.id,b);c.registerElement(f,d)}),d.promise()},initItems:function(b){var c=Array.prototype.map.call(b,function(a){return a.getAttribute(j.attributeIdentifiers.CLASSIFICATION)===j.itemIdentifiers.GROUP?this.initGroup(a):a.getAttribute(j.attributeIdentifiers.CLASSIFICATION)===j.itemIdentifiers.ELEMENT?this.initElement(a):void 0},this);return a.when.apply(a,c)}},g.prototype=Object.create(e.prototype),a.extend(g.prototype,f.prototype),g.prototype.constructor=g,g.prototype.toString=function(){return"[object Group]"},g.prototype.init=function(a){a()},h.prototype=Object.create(f.prototype),h.prototype.constructor=h,a.extend(h.prototype,{toString:function(){return"[object Form]"},initClientActions:function(b){var c=this,d=b.map(function(a){return c.initClientAction(a).done(function(a){c.clientActions.push(a)})});return a.when.apply(a,d).done(function(){c.checkAllClientActionStates()})},initClientAction:function(b){var c=this,d=a.Deferred(),e=this.convertTypeToModule(b.actionType);if(!e)throw new Error("Unknown action of type ["+b.actionType+"]");return require([e],function(a){a.init(b,c,function(a){d.resolve(a)})}),d.promise()},convertTypeToModule:function(a){var b=a.split("\\"),c=b[0],d=b.slice(1).join("_"),e=c+"/"+d;return j.debug("Found module to be ["+e+"] from type ["+a+"] by split.",h,j.LOGLEVEL.debug),e},checkModuleExists:function(a){return require.specified(a)},valueChanged:function(a){j.debug("Value of #"+a+" changed",this,j.LOGLEVEL.info),this.checkClientActionState(a)},checkClientActionState:function(a){var b=this.setFormWorking("checkaction");j.debug("Checking ClientActions on #"+a,this,j.LOGLEVEL.debug),this.clientActions.forEach(function(b){b.getWatchedIds().indexOf(a)!==-1&&b.checkState()}),b.resolve()},checkAllClientActionStates:function(){var a=this.setFormWorking("checkallactions");j.debug("Checking the state of all ClientActions",this,j.LOGLEVEL.debug);for(var b in this.clientActions)this.clientActions.hasOwnProperty(b)&&this.clientActions[b].checkState();a.resolve()},addActionListener:function(a){this.actionListeners.push(a)},callActionListener:function(a,b){for(var c in this.actionListeners)this.actionListeners.hasOwnProperty(c)&&this.actionListeners[c].hasOwnProperty(a)&&this.actionListeners[c][a].apply(this,b)},reload:function(a){this.ajaxSubmit(a,!0)},ajaxSubmit:function(c,d){d=d||!1,d?j.debug("Reloading form #"+this.id,this,j.LOGLEVEL.info):j.debug("Submitting form #"+this.id+" by AJAX",this,j.LOGLEVEL.info);var e=this.form.serializeArray(),f=a.Deferred(),g=this.setFormWorking("ajaxsubmit");return f.done(function(){g.resolve()}),void 0!==c&&e.push({name:c.attr("name"),value:c.val()}),d&&(e.push({name:"___tf_reload",value:1}),e.push({name:"___tf_original_action",value:this.form.attr("action")})),a.ajax({type:"POST",url:b.wwwroot+"/totara/form/ajax.php",data:e,context:this,success:function(a){this.ajaxSubmitHandler(f,a)},complete:function(a,b){"success"!==b&&f.resolve(b,{},a)},dataType:"json"}),f},ajaxSubmitHandler:function(b,e){var f=this;b.done(function(a,b){f.callActionListener(a,[f,b])}),"display"===e.formstatus?(j.debug("Displaying the form after an AJAX reload.",h,j.LOGLEVEL.info),c.render(e.templatename,e.templatedata).done(a.proxy(this.replaceFormContents,this),b.resolve(e.formstatus,e.templatedata.formid)).fail(d.exception)):"cancelled"===e.formstatus?(b.done(function(){j.debug("The form has been cancelled, the calling JS needs to do something.",h,j.LOGLEVEL.success)}),b.resolve(e.formstatus,e)):"submitted"===e.formstatus?(b.done(function(){j.debug("The form has been successfully submit, the calling JS needs to do something.",h,j.LOGLEVEL.success)}),b.resolve(e.formstatus,e.data)):(b.done(function(){j.debug("Unexpected reload result.",h,j.LOGLEVEL.error)}),b.resolve("unknown",e))},replaceFormContents:function(a,b){c.replaceNode(this.form,a,b)},compare:function(b,c){if(null!==b&&!Array.isArray(b)&&("function"==typeof b||"object"==typeof b))return!1;var d,e,f,g=h.prototype.compare,i=Array.isArray(b),k=null;switch(c){case h.Operators.Equals:if(3!==arguments.length)return e=arguments.length,j.debug("Compare NotEquals expects 3 arguments, "+e+" given.",h,j.LOGLEVEL.error),k;if(d=arguments[2],Array.isArray(d))if(!i||b.length<d.length)k=!1;else{k=!0;for(f in d)if(d.hasOwnProperty(f)&&!a.inArray(d[f],b)){k=!1;break}}else if(i){for(f in b)if(b.hasOwnProperty(f)&&b[f].toString()===d.toString()){k=!0;break}}else null===b&&(b=""),k=b.toString()===d.toString();break;case h.Operators.Empty:k=null===b||b===!1||""===b.toString()||"0"===b.toString()||i&&0===b.length;break;case h.Operators.Filled:i?k=b.length>0:(null===b&&(b=""),b=b.toString().trim(),k=""!==b&&"false"!==b.toLowerCase()&&!/^[0]*$/.test(b));break;case h.Operators.NotEquals:if(3!==arguments.length)return e=arguments.length,j.debug("Compare NotEquals expects 3 arguments, "+e+" given.",h,j.LOGLEVEL.error),k;d=arguments[2],k=!g(b,h.Operators.Equals,d);break;case h.Operators.NotEmpty:k=!g(b,h.Operators.Empty);break;case h.Operators.NotFilled:k=!g(b,h.Operators.Filled);break;default:j.debug('Unknown comparison operator given: "'+c+'"',h,j.LOGLEVEL.error)}return k},submitHandler:function(b){var c=b.data.form;if(b.preventDefault(),c.isValid()){var d=a(b.target);d.unbind("submit",c.submitHandler),d.submit()}else j.debug("Failed validation, the responsible element should identify itself.",h,j.LOGLEVEL.warn)},setCustomValidation:function(){var b=a(this.node),c=this;c.node.setAttribute("novalidate",""),b.on("submit.working",{form:c},c.submitHandler)},setFormWorking:function(b){j.debug("Form working on "+b+' "'+this.id+'"',h,j.LOGLEVEL.debug);var c=a.Deferred(),d=this;return c.done(function(){d.setFormReady(b)}),M.util.js_pending("totaraForm_"+this.id+"_"+b),this.form&&this.form.on("submit.working",this.preventSubmissionOnSubmit),c},setFormReady:function(a){j.debug("Form ready after "+a+' "'+this.id+'"',h,j.LOGLEVEL.debug),this.form&&this.form.off("submit.working",this.preventSubmissionOnSubmit),M.util.js_complete("totaraForm_"+this.id+"_"+a)},preventSubmissionOnSubmit:function(a){a.preventDefault()}}),h.Operators={Equals:"equals",Empty:"empty",Filled:"filled",NotEquals:"notequals",NotEmpty:"notempty",NotFilled:"notfilled"};var j={Operators:h.Operators,Element:e,Group:g,forms:{},listenerQueue:{},itemIdentifiers:{FORM:"data-totara-form",ELEMENT:"element",GROUP:"group",INPUT:"data-totara-form-element-input"},attributeIdentifiers:{ID:"data-element-id",TYPE:"data-element-type",MODULE:"data-element-amd-module",CLASSIFICATION:"data-item-classification"},LOGLEVEL:{none:"none",debug:"debug",info:"info",success:"success",warn:"warn",error:"error"},getDataAttributeSelector:function(a){return"["+a+"]"},init:function(b){j.debug("Initialising form #"+b.id,h,j.LOGLEVEL.info);var c=a("#"+b.id);if(0===c.length)throw new Error("Unable to find form #"+b.id);c=c[0],j.debug("Preventing form #"+b.id+" submission during bootstrapping",h,j.LOGLEVEL.debug);var d,e=new h({el:c}),f=b.actionsConfig,g=a.Deferred();this.forms[e.id]=e,this.listenerQueue.hasOwnProperty(e.id)&&e.addActionListener(this.listenerQueue[e.id]);var i=e.setFormWorking("init");if(d=e.getItemNodes(),0===d.length)throw new Error("Form [#"+this.id+"] must contain at least one element or group.");return e.initItems(d).then(function(){e.initClientActions(f).done(function(){g.resolve(e)})},function(a){j.debug("Failed to initialise items in form #"+b.id,h,j.LOGLEVEL.info)}),g.promise().done(function(a){var c=a.node;j.debug("Re-enabling submission of form #"+c.getAttribute("id"),h,j.LOGLEVEL.debug);var d=a.getElements(!0).some(function(a){return"function"==typeof a.isValid});d&&a.setCustomValidation(),i.resolve(),j.debug("Initialised form #"+b.id+".",h,j.LOGLEVEL.success)})},extend:function(b,c,d){return c&&"undefined"!==c||(c=function(){b.apply(this,arguments)}),c.prototype=Object.create(b.prototype),c.prototype.constructor=c,a.extend(c.prototype,d),c},load:function(e,f,g,i){var k=a.extend(g,{sesskey:b.sesskey,___tf_formclass:e,___tf_idsuffix:f}),l=a("#"+i),m=a.Deferred();return a.ajax({url:b.wwwroot+"/totara/form/ajax.php",data:k,context:this,success:function(b){"display"===b.formstatus?(j.debug("Displaying the form for the first time.",h,j.LOGLEVEL.debug),l.empty(),c.render(b.templatename,b.templatedata).done(function(d,e){c.replaceNodeContents(a("#"+i),d,e),m.resolve("display",b.templatedata.formid)}).fail(d.exception)):(j.debug("Unexpected form response",h,j.LOGLEVEL.warn),m.reject())},complete:function(a,b){"success"!==b&&m.resolve(b)},dataType:"json"}),m.promise()},getFormInstance:function(a){return this.forms.hasOwnProperty(a)?this.forms[a]:null},addActionListeners:function(a,b){var c=this.getFormInstance(a);null===c?this.listenerQueue[a]=b:c.addActionListener(b)},debug:function(a,b,c){if(i){if(!window.console.log.apply)return void(window.console.log&&window.console.log(a));c||(c=j.LOGLEVEL.none),a=b?b.prototype&&b.prototype.constructor&&b.prototype.constructor.name?"%cForm."+b.prototype.constructor.name+": %c"+a:b.constructor&&b.constructor.name?"%cForm."+b.constructor.name+": %c"+a:"%cForm: %c"+a:"%cForm: %c"+a;var d="#cb8bbe",e="#ae45a3";switch(c){case j.LOGLEVEL.debug:window.console.log.apply(window.console,[a,"color: "+d+"; font-style: italic; padding-left:2em;","color: #454545; font-style: italic;"]);break;case j.LOGLEVEL.error:window.console.log.apply(window.console,[a,"color: "+e+"; font-weight: bold;","color: #c74939;"]);break;case j.LOGLEVEL.warn:window.console.log.apply(window.console,[a,"color: "+e+"; font-weight: bold;","color: #c68c25;"]);break;case j.LOGLEVEL.success:window.console.log.apply(window.console,[a,"color: "+e+"; font-weight: bold;","color: #2da833;"]);break;case j.LOGLEVEL.info:window.console.log.apply(window.console,[a,"color: "+e+"; font-weight: bold;","color: #235aac;"]);break;default:window.console.log.apply(window.console,[a,"",""])}}}};return j});